<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Predora - Demo Build</title>

    <!-- Apply theme before first paint to prevent flash -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.documentElement.classList.add('light-mode');
            }
        })();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* === THEME VARIABLES === */
        :root {
            /* Dark Mode - Deep & Mysterious */
            --bg-primary: #0D1117;
            --bg-secondary: #161B22;
            --bg-panel: #161B22;
            --border-color: #30363D;
            --text-primary: #E6EDF3;
            --text-secondary: #9CA3AF;
            --text-tertiary: #6B7280;
            --nav-bg: rgba(22, 27, 34, 0.95);
            --nav-border: #30363D;
            --shadow-ambient: rgba(0, 0, 0, 0.1);
            --shadow-drop: rgba(0, 0, 0, 0.2);
        }

        :root.light-mode,
        body.light-mode {
            /* Light Mode - Luminous & Airy */
            --bg-primary: #F5F7FB;
            --bg-secondary: linear-gradient(135deg, #FFFFFF 0%, #EDF3FF 100%);
            --bg-panel: #E8EEFF;
            --border-color: #CBD5F5;
            --text-primary: #0F172A;
            --text-secondary: #475569;
            --text-tertiary: #64748B;
            --nav-bg: rgba(255, 255, 255, 0.85);
            --nav-border: rgba(227, 235, 255, 0.7);
            --shadow-ambient: rgba(255, 255, 255, 0.6);
            --shadow-drop: rgba(157, 180, 255, 0.2);
            --accent-gradient-start: #5CC6FF;
            --accent-gradient-end: #7B8CFF;
            --accent-coral: #F26D85;
            --muted-fill: #E2E8F8;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding-bottom: 90px;
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        #top-nav {
            background: var(--nav-bg);
            border-bottom: 1px solid var(--nav-border);
            min-height: 60px;
            transition: all 0.3s ease;
            backdrop-filter: blur(12px);
        }

        #bottom-nav {
            background: var(--nav-bg);
            border-top: 1px solid var(--nav-border);
            transition: all 0.3s ease;
            backdrop-filter: blur(12px);
        }

        /* Light mode nav enhancements */
        :root.light-mode #top-nav,
        body.light-mode #top-nav,
        :root.light-mode #bottom-nav,
        body.light-mode #bottom-nav {
            box-shadow: 0 -6px 30px var(--shadow-ambient), 0 12px 40px var(--shadow-drop);
        }

        /* ---  UI PANEL  --- */
            .ui-panel {
                background: var(--bg-panel);
                border: 1px solid var(--border-color);
                border-radius: 1rem; /* 16px */
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                padding: 1.25rem; /* 20px */
                transition: all 0.3s ease;
            }
            
            :root.light-mode .ui-panel,
            body.light-mode .ui-panel {
                background: var(--bg-panel);
                box-shadow: 0 -6px 20px var(--shadow-ambient), 0 8px 25px var(--shadow-drop);
                border-color: var(--border-color);
            }

        /* --- NAVIGATION VISIBILITY --- */
        /* Hide top navigation on mobile (small screens), show on desktop */
        @media (max-width: 767px) {
            #top-nav {
                display: none !important;
            }
        }

        /* --- ANIMATION --- */
        @keyframes glow-pulse {
            0%, 100% {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2), 0 0 10px rgba(56, 189, 248, 0.1);
                border-color: #30363D;
            }
            50% {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2), 0 0 20px rgba(56, 189, 248, 0.3);
                border-color: #38BDF8;
            }
        }

        .glowing-card {
            border: 1px solid #30363D;
            animation: glow-pulse 4s ease-in-out infinite;
        }

        /* --- SHIMMERING GRADIENT TEXT --- */
        @keyframes textPan {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }
        .gradient-text {
            background: linear-gradient(to right, #38BDF8, #6366F1, #38BDF8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            background-size: 200% 100%;
            animation: textPan 5s linear infinite;
            letter-spacing: -0.02em;
        }

        /* ---  PULSING DOT --- */
        @keyframes pulse-live {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.3; transform: scale(0.9); }
        }
        .live-dot {
            animation: pulse-live 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* --- AI SPINNER --- */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border-top-color: #38BDF8; /* sky-400 */
            animation: spin 1s linear infinite;
        }

        /* --- SCREEN TRANSITIONS --- */
        .screen {
            display: none; 
            width: 100%;
        }
        .screen-active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }
        .screen-inactive {
            display: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- TOAST NOTIFICATION  --- */
        #toast-notification {
            position: fixed;
            top: 80px; 
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            z-index: 999;
            pointer-events: none;
            background: #161B22; /* Dark panel */
            border: 1px solid #30363D; /* Border */
            border-radius: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            padding: 0.75rem 1rem;
        }
        #toast-notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* --- Custom Badge Style --- */
        .badge {
            display: inline-flex;
            align-items: center;
            font-size: 0.75rem;
            padding: 0.125rem 0.625rem;
            border-radius: 9999px;
            font-weight: 500;
        }
        .badge-blue {
            background-color: rgba(59, 130, 246, 0.1);
            color: #60A5FA;
        }
        .badge-green {
            background-color: rgba(34, 197, 94, 0.1);
            color: #4ADE80;
        }
        .badge-timer {
            background-color: rgba(56, 189, 248, 0.1);
            color: #38BDF8;
        }
        .badge-xp {
            background-color: rgba(234, 179, 8, 0.1);
            color: #FACC15;
        }
        .badge-rank {
            background-color: rgba(168, 85, 247, 0.1);
            color: #C084FC;
        }
        .badge-pick-yes {
            background-color: rgba(34, 197, 94, 0.1);
            color: #4ADE80;
            border: 1px solid #4ADE80;
        }
        .badge-pick-no {
            background-color: rgba(248, 113, 113, 0.1);
            color: #F87171;
            border: 1px solid #F87171;
        }

        /* --- Custom Button Styles --- */
        .btn {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s ease;
            transform-origin: center;
            cursor: pointer;
        }
        .btn-primary {
            background: linear-gradient(to right, #38BDF8, #6366F1);
            color: white;
            box-shadow: 0 4px 15px rgba(56, 189, 248, 0.2);
        }
        .btn:hover {
            transform: scale(1.03);
            box-shadow: 0 6px 20px rgba(56, 189, 248, 0.3);
        }
        .btn:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: rgba(56, 189, 248, 0.1); /* sky-400/10 */
            border: 1px solid #38BDF8; /* sky-400 */
            color: #38BDF8; /* sky-400 */
        }
        .btn-secondary:hover {
            background: rgba(56, 189, 248, 0.2);
        }
        .btn-stake-yes {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid #22C55E;
            color: #4ADE80;
        }
        .btn-stake-yes:hover {
            background: rgba(34, 197, 94, 0.2);
        }
        .btn-stake-no {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #EF4444;
            color: #F87171;
        }
        .btn-stake-no:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: scale(1);
            box-shadow: none;
        }

        /* --- Custom Input Style--- */
        .ui-input {
            background: #0D1117; /* Darkest background */
            border: 1px solid #30363D; /* Border */
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            color: white;
            width: 100%;
            transition: border-color 0.3s;
        }
        .ui-input::placeholder {
            color: #6B7280; /* gray-500 */
        }
        .ui-input:focus {
            outline: none;
            border-color: #38BDF8;
            box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.3);
        }
        .ui-input:disabled {
             opacity: 0.5;
             cursor: not-allowed;
        }
        /* Style for the asset <select> */
        .ui-select {
            background: #0D1117;
            border: 1px solid #30363D;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            color: white;
            width: 100%;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none' stroke='%239CA3AF' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpath d='M7 7l3-3 3 3m0 6l-3 3-3-3'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.25em 1.25em;
        }
        .ui-select:focus {
            outline: none;
            border-color: #38BDF8;
            box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.3);
        }

        /* ===  LIGHT MODE OVERRIDES === */
        :root.light-mode .btn-primary,
        body.light-mode .btn-primary {
            background: linear-gradient(to right, #5CC6FF, #7B8CFF);
            color: white;
            box-shadow: 0 4px 15px rgba(92, 198, 255, 0.25);
        }
        
        :root.light-mode .btn-primary:hover,
        body.light-mode .btn-primary:hover {
            box-shadow: 0 6px 25px rgba(92, 198, 255, 0.4);
        }
        
        :root.light-mode .btn-secondary,
        body.light-mode .btn-secondary {
            background: rgba(92, 198, 255, 0.1);
            border: 1px solid #5CC6FF;
            color: #0F172A;
        }
        
        :root.light-mode .btn-secondary:hover,
        body.light-mode .btn-secondary:hover {
            background: rgba(92, 198, 255, 0.2);
            border-color: #7B8CFF;
        }
        
        :root.light-mode .ui-input,
        body.light-mode .ui-input {
            background: #FFFFFF;
            border: 1px solid #CBD5F5;
            color: #0F172A;
        }
        
        :root.light-mode .ui-input::placeholder,
        body.light-mode .ui-input::placeholder {
            color: #9CA3AF;
        }
        
        :root.light-mode .ui-input:focus,
        body.light-mode .ui-input:focus {
            border-color: #5CC6FF;
            box-shadow: 0 0 0 3px rgba(92, 198, 255, 0.2);
        }
        
        :root.light-mode .ui-select,
        body.light-mode .ui-select {
            background: #FFFFFF;
            border: 1px solid #CBD5F5;
            color: #0F172A;
        }
        
        :root.light-mode .ui-select:focus,
        body.light-mode .ui-select:focus {
            border-color: #5CC6FF;
            box-shadow: 0 0 0 3px rgba(92, 198, 255, 0.2);
        }
        
        :root.light-mode .badge-blue,
        body.light-mode .badge-blue {
            background-color: rgba(92, 198, 255, 0.15);
            color: #0369A1;
        }
        
        :root.light-mode .badge-green,
        body.light-mode .badge-green {
            background-color: rgba(60, 191, 140, 0.15);
            color: #047857;
        }
        
        :root.light-mode .badge-xp,
        body.light-mode .badge-xp {
            background-color: rgba(247, 185, 74, 0.15);
            color: #D97706;
        }
        
        :root.light-mode .badge-rank,
        body.light-mode .badge-rank {
            background-color: rgba(123, 140, 255, 0.15);
            color: #6366F1;
        }
        
        :root.light-mode .btn-stake-yes,
        body.light-mode .btn-stake-yes {
            background: rgba(60, 191, 140, 0.15);
            border: 1px solid #3CBF8C;
            color: #047857;
        }
        
        :root.light-mode .btn-stake-yes:hover,
        body.light-mode .btn-stake-yes:hover {
            background: rgba(60, 191, 140, 0.25);
        }
        
        :root.light-mode .btn-stake-no,
        body.light-mode .btn-stake-no {
            background: rgba(242, 109, 133, 0.15);
            border: 1px solid #F26D85;
            color: #DC2626;
        }
        
        :root.light-mode .btn-stake-no:hover,
        body.light-mode .btn-stake-no:hover {
            background: rgba(242, 109, 133, 0.25);
        }
        
        :root.light-mode .gradient-text,
        body.light-mode .gradient-text {
            background: linear-gradient(to right, #5CC6FF, #7B8CFF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Quick Play Screens */
        :root.light-mode #quick-play-screen,
        body.light-mode #quick-play-screen {
            background: #F5F7FB;
        }
        
        :root.light-mode #quick-play-card,
        body.light-mode #quick-play-card {
            background: #FFFFFF;
            border: 1px solid #CBD5F5;
            box-shadow: 
                0 4px 20px rgba(92, 198, 255, 0.1),
                0 1px 3px rgba(15, 23, 42, 0.08);
        }
        
        /* Toast Notification */
        :root.light-mode #toast-notification,
        body.light-mode #toast-notification {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #CBD5F5;
            box-shadow: 
                0 8px 32px rgba(92, 198, 255, 0.15),
                0 2px 8px rgba(15, 23, 42, 0.1);
            color: #0F172A;
            backdrop-filter: blur(12px);
        }
        
        /* Mock Wallet Modal */
        :root.light-mode #mock-wallet-modal,
        body.light-mode #mock-wallet-modal {
            background: rgba(245, 247, 251, 0.9);
        }
        
        :root.light-mode #mock-wallet-modal > div,
        body.light-mode #mock-wallet-modal > div {
            background: #FFFFFF;
            border: 1px solid #CBD5F5;
            box-shadow: 
                0 20px 60px rgba(92, 198, 255, 0.2),
                0 4px 12px rgba(15, 23, 42, 0.1);
        }
        
        /* Live User Counter */
        :root.light-mode #live-user-counter,
        body.light-mode #live-user-counter {
            background: #FFFFFF;
            border: 1px solid #CBD5F5;
            box-shadow: 0 2px 8px rgba(92, 198, 255, 0.1);
        }
        
        /* Glowing Cards */
        :root.light-mode .glowing-card,
        body.light-mode .glowing-card {
            border: 1px solid #CBD5F5;
            background: #FFFFFF;
            box-shadow: 
                0 4px 20px rgba(92, 198, 255, 0.15),
                0 1px 3px rgba(15, 23, 42, 0.08);
        }
        
        /* Filter Pills */
        :root.light-mode .filter-pill,
        body.light-mode .filter-pill {
            background-color: rgba(92, 198, 255, 0.1);
            border: 1px solid rgba(92, 198, 255, 0.2);
            color: #0F172A;
        }
        
        :root.light-mode .filter-pill:hover,
        body.light-mode .filter-pill:hover {
            background-color: rgba(92, 198, 255, 0.2);
        }
        
        :root.light-mode .filter-pill.active,
        body.light-mode .filter-pill.active {
            background: linear-gradient(to right, #5CC6FF, #7B8CFF);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(92, 198, 255, 0.3);
        }
        
        /* Additional Badge Variants */
        :root.light-mode .badge-timer,
        body.light-mode .badge-timer {
            background-color: rgba(92, 198, 255, 0.15);
            color: #0369A1;
        }
        
        :root.light-mode .badge-pick-yes,
        body.light-mode .badge-pick-yes {
            background-color: rgba(60, 191, 140, 0.15);
            color: #047857;
            border: 1px solid #3CBF8C;
        }
        
        :root.light-mode .badge-pick-no,
        body.light-mode .badge-pick-no {
            background-color: rgba(242, 109, 133, 0.15);
            color: #DC2626;
            border: 1px solid #F26D85;
        }
        
        /* Quick Play Buttons */
        :root.light-mode .quick-play-btn,
        body.light-mode .quick-play-btn {
            background: rgba(92, 198, 255, 0.08) !important;
            border: 2px solid #CBD5F5 !important;
        }
        
        :root.light-mode .quick-play-btn-yes,
        body.light-mode .quick-play-btn-yes {
            background: rgba(60, 191, 140, 0.15) !important;
            border-color: #3CBF8C !important;
            color: #047857 !important;
            box-shadow: 0 0 20px rgba(60, 191, 140, 0.25) !important;
        }
        
        :root.light-mode .quick-play-btn-yes:hover,
        body.light-mode .quick-play-btn-yes:hover {
            background: rgba(60, 191, 140, 0.25) !important;
            box-shadow: 0 0 30px rgba(60, 191, 140, 0.35) !important;
        }
        
        :root.light-mode .quick-play-btn-yes:active,
        body.light-mode .quick-play-btn-yes:active {
            transform: scale(0.9);
        }
        
        :root.light-mode .quick-play-btn-no,
        body.light-mode .quick-play-btn-no {
            background: rgba(242, 109, 133, 0.15) !important;
            border-color: #F26D85 !important;
            color: #DC2626 !important;
            box-shadow: 0 0 20px rgba(242, 109, 133, 0.25) !important;
        }
        
        :root.light-mode .quick-play-btn-no:hover,
        body.light-mode .quick-play-btn-no:hover {
            background: rgba(242, 109, 133, 0.25) !important;
            box-shadow: 0 0 30px rgba(242, 109, 133, 0.35) !important;
        }
        
        :root.light-mode .quick-play-btn-no:active,
        body.light-mode .quick-play-btn-no:active {
            transform: scale(0.9);
        }
        
        :root.light-mode .quick-play-btn-skip,
        body.light-mode .quick-play-btn-skip {
            background: rgba(107, 114, 128, 0.1) !important;
            border-color: #9CA3AF !important;
            color: #4B5563 !important;
        }
        
        :root.light-mode .quick-play-btn-skip:hover,
        body.light-mode .quick-play-btn-skip:hover {
            background: rgba(107, 114, 128, 0.18) !important;
        }
        
        :root.light-mode .quick-play-btn-skip:active,
        body.light-mode .quick-play-btn-skip:active {
            transform: scale(0.9);
        }
        
        /* Quick Play Button Icons - override text-white class */
        :root.light-mode .quick-play-btn-yes svg,
        body.light-mode .quick-play-btn-yes svg {
            color: #047857 !important;
        }
        
        :root.light-mode .quick-play-btn-no svg,
        body.light-mode .quick-play-btn-no svg {
            color: #DC2626 !important;
        }
        
        :root.light-mode .quick-play-btn-skip svg,
        body.light-mode .quick-play-btn-skip svg {
            color: #4B5563 !important;
        }
        
        /* Profile Panel Flip Animation */
        #profile-panel {
            transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            transform-style: preserve-3d;
        }
        
        #profile-panel.flip-left {
            animation: flipLeft 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        @keyframes flipLeft {
            0% {
                transform: rotateY(0deg);
            }
            50% {
                transform: rotateY(-90deg);
            }
            100% {
                transform: rotateY(0deg);
            }
        }
        
        /* Fix Light Mode Text Contrast - Targeted Coverage */
        :root.light-mode,
        body.light-mode {
            color: #0F172A;
        }
        
        :root.light-mode h1,
        :root.light-mode h2,
        :root.light-mode h3,
        :root.light-mode h4,
        :root.light-mode h5,
        :root.light-mode h6,
        body.light-mode h1,
        body.light-mode h2,
        body.light-mode h3,
        body.light-mode h4,
        body.light-mode h5,
        body.light-mode h6 {
            color: #0F172A;
        }
        
        /* Override all gray shades to dark readable colors */
        :root.light-mode .text-gray-300,
        body.light-mode .text-gray-300 {
            color: #475569 !important;
        }
        
        :root.light-mode .text-gray-400,
        body.light-mode .text-gray-400 {
            color: #64748B !important;
        }
        
        :root.light-mode .text-gray-500,
        body.light-mode .text-gray-500 {
            color: #475569 !important;
        }
        
        :root.light-mode .text-gray-600,
        body.light-mode .text-gray-600 {
            color: #334155 !important;
        }
        
        /* Override all slate shades */
        :root.light-mode .text-slate-300,
        body.light-mode .text-slate-300 {
            color: #475569 !important;
        }
        
        :root.light-mode .text-slate-400,
        body.light-mode .text-slate-400 {
            color: #334155 !important;
        }
        
        :root.light-mode .text-slate-500,
        body.light-mode .text-slate-500 {
            color: #1E293B !important;
        }
        
        :root.light-mode .text-slate-600,
        body.light-mode .text-slate-600 {
            color: #0F172A !important;
        }
        
        /* Override all neutral shades */
        :root.light-mode .text-neutral-300,
        body.light-mode .text-neutral-300 {
            color: #475569 !important;
        }
        
        :root.light-mode .text-neutral-400,
        body.light-mode .text-neutral-400 {
            color: #334155 !important;
        }
        
        :root.light-mode .text-neutral-500,
        body.light-mode .text-neutral-500 {
            color: #1E293B !important;
        }
        
        :root.light-mode .text-neutral-600,
        body.light-mode .text-neutral-600 {
            color: #0F172A !important;
        }
        
        /* Override sky colors for better contrast */
        :root.light-mode .text-sky-300,
        body.light-mode .text-sky-300 {
            color: #0369A1 !important;
        }
        
        :root.light-mode .text-sky-400,
        body.light-mode .text-sky-400 {
            color: #0369A1 !important;
        }
        
        /* Gradient text with darker colors */
        :root.light-mode .gradient-text,
        body.light-mode .gradient-text {
            background: linear-gradient(to right, #0369A1, #6366F1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* --- Custom Toggle Switch --- */
        .toggle-label {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .toggle-checkbox {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4B5563;
            border-radius: 9999px;
            transition: all 0.3s;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            border-radius: 9999px;
            transition: all 0.3s;
        }
        .toggle-checkbox:checked + .toggle-slider {
            background-color: #38BDF8;
        }
        .toggle-checkbox:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        .toggle-checkbox:disabled + .toggle-slider {
            background-color: #374151;
            cursor: not-allowed;
        }

        /* --- Enhanced Desktop Navigation --- */
        @media (min-width: 768px) {
            #top-nav {
                background: linear-gradient(135deg, rgba(13, 17, 23, 0.95) 0%, rgba(22, 27, 34, 0.95) 100%);
                backdrop-filter: blur(12px);
                border-bottom: 1px solid rgba(56, 189, 248, 0.2);
            }
            #top-nav::before {
                content: '';
                position: absolute;
                inset: 0;
                background: linear-gradient(90deg, transparent, rgba(56, 189, 248, 0.03), transparent);
                pointer-events: none;
            }
        }
        
        /* Light mode navigation */
        :root.light-mode #top-nav,
        body.light-mode #top-nav {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(249, 250, 251, 0.98) 100%);
            border-bottom: 1px solid rgba(3, 105, 161, 0.2);
        }

        /* --- Enhanced Mobile Header --- */
        #mobile-header {
            position: relative;
        }
        
        #mobile-header::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(56, 189, 248, 0.05), transparent);
            pointer-events: none;
        }
        
        /* Mobile app title hover glow */
        #mobile-app-title:active {
            transform: scale(0.97);
        }

        /* --- Profile Page Tabs --- */
        .profile-tab {
            padding: 0.5rem 0;
            font-weight: 600;
            color: #9CA3AF;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
        }
        .profile-tab.active {
            color: #38BDF8;
            border-bottom-color: #38BDF8;
        }

        /* --- Bottom Nav (5 icons) --- */
        .nav-button {
            flex-grow: 1;
            font-size: 0.7rem;
            transition: all 0.2s ease;
            transform-origin: bottom;
        }
        .nav-button:hover {
            transform: scale(1.1);
        }
        .nav-button:active {
            transform: scale(0.95);
        }

        /* --- Toast Notifications --- */
        .toast-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @media (max-width: 640px) {
            #toast-container {
                right: 1rem;
                left: 1rem;
                max-width: calc(100% - 2rem);
            }
        }

        /* --- QUICK PLAY  --- */
        #quick-play-screen {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;  
            right: 0;  
            padding: 1rem;
            flex-direction: column;
            justify-content: center;
            background: #0D1117; /* Dark background */
        }
        #quick-play-screen.screen-active {
            display: flex;
        }

        #quick-play-card-container {
            position: relative;
            perspective: 1000px;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #quick-play-card {
            width: 90%;
            max-width: 380px;
            /* All height properties removed to auto-adjust */
            background: #161B22; /* Dark panel */
            border: 1px solid #30363D; /* Border */
            border-radius: 1.25rem;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.5);
            padding: 1.5rem;
            transition: all 0.5s cubic-bezier(0.25, 1, 0.3, 1);
            transform: translateZ(0) rotate(0);
            opacity: 1;
            display: flex;
            flex-direction: column;
            justify-content: center; 
            gap: 1.5rem; 
        }
        #quick-play-card.fly-out-right {
            transform: translateX(150%) rotate(15deg);
            opacity: 0;
        }
        #quick-play-card.fly-out-left {
            transform: translateX(-150%) rotate(-15deg);
            opacity: 0;
        }
        #quick-play-card.fly-out-skip {
            transform: translateY(150%) scale(0.5);
            opacity: 0;
        }
        #quick-play-card.fade-in {
            transform: scale(0.8);
            opacity: 0;
        }

        .quick-play-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 9999px;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 1.125rem;
            font-weight: 700;
        }
        .quick-play-btn:active {
            transform: scale(0.9);
        }
        .quick-play-btn-no {
            border-color: #F87171;
            color: #F87171;
            box-shadow: 0 0 20px rgba(248, 113, 113, 0.3);
        }
        .quick-play-btn-yes {
            border-color: #4ADE80;
            color: #4ADE80;
            box-shadow: 0 0 20px rgba(74, 222, 128, 0.3);
        }
        .quick-play-btn-skip {
            width: 60px;
            height: 60px;
            font-size: 0.875rem;
            border-color: #9CA3AF; /* gray-400 */
            color: #9CA3AF;
        }

        /* --- NEW: Quick-tap button for pledge pool --- */
        .btn-quick-tap {
            padding: 0.5rem 0.75rem;
            font-weight: 600;
            font-size: 0.875rem;
            background: #30363D;
            color: #e0e0e0;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
        }
        .btn-quick-tap:hover {
            background: #4B5563;
        }
        .btn-quick-tap:active {
            transform: scale(0.95);
        }

        /* --- NEW: Small input for pledge pool --- */
        .pledge-amount-input {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            max-width: 100%;
        }


        /* --- Helper class --- */
        .hidden {
            display: none !important;
        }

        /* --- "ALIVE" MOCK FEATURES --- */
        #live-user-counter {
            background: #161B22; /* Dark panel */
            border: 1px solid #30363D; /* Border */
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
        }

        /* --- MOCK WALLET MODAL --- */
        #mock-wallet-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 990;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        #mock-wallet-modal.show {
            opacity: 1;
            pointer-events: auto;
        }
        #mock-wallet-modal > div {
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.23, 1, 0.32, 1);
        }
        #mock-wallet-modal.show > div {
            transform: scale(1);
        }


        /* --- (This is at the end of your <style> tag) --- */

                /* --- NEW: Category Filter Bar --- */
                .category-scroll-container {
                    -ms-overflow-style: none;  /* IE and Edge */
                    scrollbar-width: none;  /* Firefox */
                }
                .category-scroll-container::-webkit-scrollbar {
                    display: none; /* Chrome, Safari, Opera */
                }
                .filter-pill {
                    padding: 0.375rem 1rem; /* 6px 16px */
                    border-radius: 9999px;
                    font-size: 0.875rem; /* 14px */
                    font-weight: 600;
                    background-color: #30363D; /* gray-700 */
                    color: #D1D5DB; /* gray-300 */
                    cursor: pointer;
                    transition: all 0.2s ease;
                    white-space: nowrap; /* Prevents text from wrapping */
                }
                .filter-pill:hover {
                    background-color: #4B5563; /* gray-600 */
                }
                .filter-pill.active {
                    background: linear-gradient(to right, #38BDF8, #6366F1);
                    color: white;
                    box-shadow: 0 4px 15px rgba(56, 189, 248, 0.2);
                }


        /* --- Modern Top Nav Button Styles --- */
        .top-nav-btn {
            color: #9CA3AF; /* gray-400 */
            position: relative;
        }
        .top-nav-btn:hover {
            color: #38BDF8;
            background-color: rgba(56, 189, 248, 0.1);
        }
        .top-nav-btn.active {
            background: linear-gradient(to right, #38BDF8, #6366F1);
            color: white;
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
        }
        
        /* Notification Tab Styles */
        .notif-tab.active {
            color: #38BDF8;
            border-bottom-color: #38BDF8;
        }
        :root.light-mode .notif-tab,
        body.light-mode .notif-tab {
            color: #6B7280;
        }
        :root.light-mode .notif-tab:hover,
        body.light-mode .notif-tab:hover {
            color: #0369A1;
        }
        :root.light-mode .notif-tab.active,
        body.light-mode .notif-tab.active {
            color: #0369A1;
            border-bottom-color: #0369A1;
        }
    </style>
</head>
<body class="text-gray-100">
    <!-- Mobile Header (visible on mobile only) -->
    <header id="mobile-header" class="sticky top-0 z-50 md:hidden backdrop-blur-xl bg-gradient-to-r from-[#0D1117]/95 to-[#161B22]/95 dark:from-[#0D1117]/95 dark:to-[#161B22]/95 light:from-white/98 light:to-gray-50/98 border-b border-[#30363D]/30 dark:border-[#30363D]/30 light:border-gray-200/50 shadow-lg shadow-black/5">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-center relative">
                <!-- Centered Logo with Glow Effect -->
                <h1 id="mobile-app-title" class="text-2xl font-black gradient-text tracking-tight cursor-pointer transition-transform duration-200 active:scale-95 relative">
                    Predora
                    <div class="absolute -inset-2 bg-gradient-to-r from-sky-400/20 to-indigo-400/20 blur-xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 -z-10"></div>
                </h1>
            </div>
        </div>
    </header>

    <!-- Desktop Navigation (hidden on mobile) -->
    <nav id="top-nav" class="hidden md:block sticky top-0 z-50 shadow-lg shadow-black/20">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center gap-8">
                    <!-- Logo -->
                    <div>
                        <h1 id="app-title" class="text-2xl md:text-3xl font-extrabold gradient-text tracking-tight cursor-pointer" onclick="showScreen('home-screen')">Predora</h1>
                    </div>

                    <!-- Desktop Navigation - Centered Pill Style -->
                    <div class="flex items-center gap-2 bg-[#161B22]/60 backdrop-blur-xl px-4 py-2.5 rounded-full border border-[#30363D]/50 shadow-lg shadow-black/10">
                        <button data-screen="home-screen" class="top-nav-btn px-2 md:px-4 py-2 rounded-full text-xs md:text-sm font-semibold transition-all duration-300">
                            <svg class="w-4 h-4 inline-block mr-0.5 md:mr-1.5 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6-4v4m0-4h4"></path></svg>
                            <span class="hidden sm:inline">Home</span>
                        </button>
                        <button data-screen="leaderboard-screen" class="top-nav-btn px-2 md:px-4 py-2 rounded-full text-xs md:text-sm font-semibold transition-all duration-300">
                            <svg class="w-4 h-4 inline-block mr-0.5 md:mr-1.5 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                            <span class="hidden sm:inline">Leaders</span>
                        </button>
                        <button data-screen="pledge-pool-screen" class="top-nav-btn px-2 md:px-4 py-2 rounded-full text-xs md:text-sm font-semibold transition-all duration-300">
                            <svg class="w-4 h-4 inline-block mr-0.5 md:mr-1.5 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                            <span class="hidden sm:inline">Pledges</span>
                        </button>
                        <button data-screen="create-market-screen" class="top-nav-btn px-2 md:px-4 py-2 rounded-full text-xs md:text-sm font-semibold transition-all duration-300">
                            <svg class="w-4 h-4 inline-block mr-0.5 md:mr-1.5 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            <span class="hidden sm:inline">Create</span>
                        </button>
                    </div>

                    <!-- Right Side: Live Counter + Notifications + Theme + Profile -->
                    <div class="flex items-center gap-3">
                        <div id="live-user-counter" class="hidden sm:flex items-center text-xs md:text-sm text-gray-300">
                            <span class="w-2 h-2 bg-green-400 rounded-full mr-2 live-dot"></span>
                            <span id="live-user-count-text">147</span>
                            <span class="ml-1">online</span>
                        </div>

                        <!-- Notification Bell -->
                        <button id="notification-bell" onclick="toggleNotifications()" class="relative w-9 h-9 md:w-10 md:h-10 rounded-full flex items-center justify-center text-gray-400 hover:text-sky-400 transition-all duration-300 hover:scale-110 active:scale-95 hover:bg-gray-800/30" title="Notifications">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                            </svg>
                            <!-- Notification Badge -->
                            <span id="notification-badge" class="hidden absolute -top-1 -right-1 w-5 h-5 bg-rose-500 text-white text-xs font-bold rounded-full flex items-center justify-center animate-pulse">0</span>
                        </button>

                        <!-- Theme Toggle -->
                        <button id="theme-toggle" onclick="toggleTheme()" class="w-9 h-9 md:w-10 md:h-10 rounded-full flex items-center justify-center text-gray-400 hover:text-sky-400 transition-all duration-300 hover:scale-110 active:scale-95 hover:bg-gray-800/30" title="Toggle theme">
                            <svg id="theme-icon-sun" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                            </svg>
                            <svg id="theme-icon-moon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                            </svg>
                        </button>

                        <button data-screen="profile-screen" id="nav-profile-button" class="w-9 h-9 md:w-10 md:h-10 bg-gradient-to-br from-indigo-600 to-blue-600 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-lg transition-all duration-300 hover:scale-110 hover:shadow-xl hover:shadow-indigo-500/50 active:scale-95">
                            P
                        </button>
                    </div>
                </div>
            </div>
        </nav>

    <div class="min-h-screen relative">

            <main class="max-w-md md:max-w-xl lg:max-w-7xl mx-auto relative p-4">

            <div id="login-screen" class="screen screen-active space-y-6 max-w-md mx-auto lg:max-w-lg lg:space-y-8">
                <h1 class="text-3xl lg:text-4xl font-bold gradient-text text-center">Welcome to Predora</h1>
                <p class="text-center text-gray-300 lg:text-lg">Select a demo account to get started.</p>

                <div class="space-y-3 lg:space-y-4">
                    <button onclick="mockLogin('judge-123', '@Judge')" class="btn btn-primary lg:text-lg">Sign in as @Judge</button>
                    <button onclick="mockLogin('alice-456', '@Alice')" class="btn btn-secondary lg:text-lg">Sign in as @Alice</button>
                    <button onclick="mockLogin('bob-789', '@Bob')" class="btn btn-secondary lg:text-lg">Sign in as @Bob</button>
                </div>

                <div class="ui-panel space-y-4 lg:space-y-5">
                    <p class="text-center text-gray-400 text-sm lg:text-base">Or, test the (mock) OTP flow:</p>
                    <input id="mock-email-input" type="email" class="ui-input lg:text-lg" placeholder="your-email@gmail.com">
                    <button onclick="validateAndShowOtp()" class="btn btn-secondary w-full lg:text-lg">Sign in with Email</button>

                </div>
            </div>

            <div id="otp-screen" class="screen screen-inactive space-y-4 max-w-md mx-auto lg:max-w-lg lg:space-y-6">
                <button onclick="showScreen('login-screen')" class="flex items-center text-sky-400 font-medium lg:text-lg">
                    <svg class="w-5 h-5 mr-1 lg:w-6 lg:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    Back
                </button>
                <h1 class="text-2xl lg:text-3xl font-bold gradient-text">Enter OTP</h1>
                <p class="text-gray-300 lg:text-lg">A (mock) code was sent. <br> Hint: It's `123456`</p>
                <input id="mock-otp-input" type="text" class="ui-input text-center text-2xl lg:text-3xl tracking-[1em]" placeholder="123456" maxlength="6">
                <button onclick="mockOtpLogin()" class="btn btn-primary w-full lg:text-lg">Verify & Sign In</button>
            </div>

                <div id="home-screen" class="screen screen-inactive space-y-5">


                <div onclick="showScreen('quick-play-screen')" class="ui-panel glowing-card flex items-center justify-between p-4 lg:p-6 cursor-pointer transition-all duration-300 hover:scale-[1.02]">
                    <div>
                        <h3 class="text-lg lg:text-xl font-bold gradient-text">Quick Plays</h3>
                        <p class="text-sm lg:text-base text-gray-300">Fast markets, fast results.</p>
                    </div>
                    <svg class="w-8 h-8 lg:w-10 lg:h-10 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                </div>

                    <!--   SEARCH BAR BLOCK -->
                    <div class="relative w-full my-5">
                        <input type="text" id="search-bar-input" class="ui-input pl-10 lg:pl-12 lg:text-lg" placeholder="Search markets (e.g., 'BTC', 'Elections')">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 lg:pl-4 pointer-events-none">
                            <svg class="w-5 h-5 lg:w-6 lg:h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </div>
                    </div>

                    <!-- FILTER BAR -->
                    <div id="category-filter-bar" class="w-full overflow-x-auto category-scroll-container">
                        <div class="flex space-x-3 py-1">
                            <!-- Categories will be loaded here by JavaScript -->
                            <button class="filter-pill active" onclick="filterMarkets('All')">All</button>
                            <button class="filter-pill" onclick="filterMarkets('Crypto')">Crypto</button>
                            <button class="filter-pill" onclick="filterMarkets('Sports')">Sports</button>
                            <button class="filter-pill" onclick="filterMarkets('Politics')">Politics</button>
                            <button class="filter-pill" onclick="filterMarkets('Entertainment')">Entertainment</button>
                            <button class="filter-pill" onclick="filterMarkets('Finance')">Finance</button>
                            <button class="filter-pill" onclick="filterMarkets('Tech')">Tech</button>
                            <button class="filter-pill" onclick="filterMarkets('Micro-Influencer')">Influencers</button>
                            <button class="filter-pill" onclick="filterMarkets('Creator Milestones')">Creators</button>
                            <button class="filter-pill" onclick="filterMarkets('Gossip')">Gossip</button>
                            <button class="filter-pill" onclick="filterMarkets('Campus')">Campus</button>
                            <button class="filter-pill" onclick="filterMarkets('Local Sports')">Local Sports</button>
                            <button class="filter-pill" onclick="filterMarkets('Gaming')">Gaming</button>
                            <button class="filter-pill" onclick="filterMarkets('Other')">Other</button>
                        </div>
                    </div>
                    <!-- END OF FILTER BAR -->

                <h2 class="text-xl lg:text-2xl font-semibold text-white tracking-tight pt-2">Trending Markets</h2>
                <div id="standard-markets-feed" class="space-y-4 lg:grid lg:grid-cols-2 lg:gap-4 lg:space-y-0 xl:grid-cols-3">
                    <p class="text-gray-400 text-center lg:col-span-2 xl:col-span-3">Loading markets...</p>
                </div>
            </div>

            <div id="create-market-screen" class="screen screen-inactive space-y-6">
                <h1 class="text-2xl lg:text-3xl font-bold gradient-text">Create Standard Market</h1>

                <div class="lg:grid lg:grid-cols-3 lg:gap-6 space-y-6 lg:space-y-0">
                    <div class="lg:col-span-2 space-y-6">

                <div class="ui-panel p-4 space-y-3">
                    <h3 class="text-base font-semibold text-sky-300">AI Assistant (LIVE)</h3>
                    <p class="text-sm text-gray-400">Stuck? Get AI suggestions for your market.</p>
                    <textarea id="ai-helper-prompt" rows="2" class="ui-input" placeholder="e.g., 'Grammys' or 'Russia' or 'SOL'"></textarea>
                    <button id="ai-generate-btn" class="btn btn-secondary w-full">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                        Get AI Suggestions
                    </button>
                    <div id="ai-spinner" class="hidden flex justify-center items-center py-4">
                        <div class="spinner w-6 h-6 border-2 border-transparent rounded-full"></div>
                        <span class="ml-3 text-gray-300">Generating market details...</span>
                    </div>
                </div>

                <div class="space-y-4">
                    <h3 class="text-base font-semibold text-gray-200">Market Details (Manual Entry)</h3>
                    
                    <div class="space-y-2">
                        <label for="market-category-select" class="text-sm font-medium text-gray-300">Category</label>
                        <select id="market-category-select" class="ui-input">
                            <option value="">Select a category...</option>
                            <optgroup label="Popular">
                                <option value="Crypto">Crypto</option>
                                <option value="Sports">Sports</option>
                                <option value="Politics">Politics</option>
                                <option value="Entertainment">Entertainment</option>
                                <option value="Finance">Finance</option>
                                <option value="Tech">Tech</option>
                            </optgroup>
                            <optgroup label="Creator & Social">
                                <option value="Micro-Influencer">Micro-Influencer Predictions</option>
                                <option value="Creator Milestones">Creator Personal Milestones</option>
                                <option value="Gossip">Gossip Predictions</option>
                            </optgroup>
                            <optgroup label="Local & Campus">
                                <option value="Campus">Campus Predictions</option>
                                <option value="Local Sports">Local Football Predictions</option>
                            </optgroup>
                            <optgroup label="Gaming">
                                <option value="Gaming">Gaming/E-sports Round Predictions</option>
                            </optgroup>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div class="space-y-2">
                        <label for="market-title-input" class="text-sm font-medium text-gray-300">Title</label>
                        <textarea id="market-title-input" rows="3" class="ui-input" placeholder="e.g., Will ETH reach $5,000 by EOY?"></textarea>
                    </div>
                    <div class="space-y-2">
                        <label for="market-insight-input" class="text-sm font-medium text-gray-300">Insight / Summary</label>
                        <textarea id="market-insight-input" rows="4" class="ui-input" placeholder="A brief context or analysis of the event."></textarea>
                    </div>
                </div>

                <div class="space-y-4">
                    <h3 class="text-base font-semibold text-gray-200">Initial Odds</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label for="market-yes-input" class="text-sm font-medium text-gray-300">YES %</label>
                            <input type="number" id="market-yes-input" class="ui-input" placeholder="e.g., 60" min="1" max="99">
                        </div>
                        <div class="space-y-2">
                            <label for="market-no-input" class="text-sm font-medium text-gray-300">NO %</label>
                            <input type="number" id="market-no-input" class="ui-input" placeholder="e.g., 40" min="1" max="99">
                        </div>
                    </div>
                </div>

                    <div class="space-y-4">
                        <h3 class="text-base font-semibold text-gray-200">Market Type</h3>
                        <input type="hidden" id="market-type-input" value="no-loss"> 

                        <div class="grid grid-cols-2 gap-3">
                            <button id="btn-market-no-loss" onclick="selectMarketType('no-loss')" class="btn btn-stake-yes">
                                No-Loss
                                <span class="block text-xs font-light">(Principal Safe)</span>
                            </button>

                            <button id="btn-market-traditional" onclick="selectMarketType('traditional')" class="btn btn-secondary">
                                Traditional
                                <span class="block text-xs font-light">(High-Risk)</span>
                            </button>
                        </div>
                    </div>

                <!--  CATEGORY BLOCK -->
                <div class="space-y-2">
                    <label for="market-category-select" class="text-sm font-medium text-gray-300">Category</label>
                    <select id="market-category-select" class="ui-select">
                        <option value="Other" selected>Select a category...</option>
                        <option value="Crypto">Crypto</option>
                        <option value="Sports">Sports</option>
                        <option value="Politics">Politics</option>
                        <option value="Entertainment">Entertainment</option>
                        <option value="Finance">Finance</option>
                        <option value="Tech">Tech</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <!-- END OF  BLOCK -->

                <div class="space-y-4">
                    <h3 class="text-base font-semibold text-gray-200">Initial Liquidity</h3>
                    <div class="ui-panel p-4 space-y-4">
                        <p class="text-sm text-gray-400">
                            You must provide the initial liquidity for this market. This amount is locked and used to create the starting odds.
                        </p>

                        <div class="grid grid-cols-3 gap-2">
                            <div class="col-span-2 space-y-1">
                                <label for="market-liquidity-input" class="text-xs font-medium text-gray-300">Amount</label>
                                <input type="number" id="market-liquidity-input" class="ui-input" placeholder="100.00">
                            </div>
                            <div class="col-span-1 space-y-1">
                                <label for="market-liquidity-asset" class="text-xs font-medium text-gray-300">Asset</label>
                                <select id="market-liquidity-asset" class="ui-select">
                                    </select>
                            </div>
                        </div>
                        <div class="text-center p-3 mt-2 rounded-lg bg-green-500/10 border border-green-400">
                            <p class="font-semibold text-green-300">
                                Get a 100% Refund!
                            </p>
                            <p class="text-xs text-gray-300">
                                Your initial liquidity is refunded if your market hits
                                <span class="font-bold">$100 in Stake Volume</span> from at least
                                <span class="font-bold">10 different stakers.</span>
                            </p>
                        </div>
                    </div>
                </div>

                <div id="no-loss-options" class="space-y-4">
                    <h3 class="text-base font-semibold text-gray-200">Yield Protocol</h3>
                    <div class="ui-panel p-4 space-y-2">
                        <div id="yield-protocol-aave" class="flex justify-between items-center p-3 rounded-lg border border-sky-400 bg-sky-500/10 cursor-pointer" onclick="selectYield('aave')">
                            <span class="font-medium text-white dark:text-white">Aave</span>
                            <span class="font-bold text-green-400">4.12% APY</span>
                        </div>
                        <div id="yield-protocol-compound" class="flex justify-between items-center p-3 rounded-lg border border-transparent cursor-pointer text-gray-400 hover:border-gray-600" onclick="selectYield('compound')">
                            <span class="font-medium">Compound</span>
                            <span class="font-bold text-green-400">3.88% APY</span>
                        </div>
                        <div id="yield-protocol-lido" class="flex justify-between items-center p-3 rounded-lg border border-transparent cursor-pointer text-gray-400 hover:border-gray-600" onclick="selectYield('lido')">
                            <span class="font-medium">Lido</span>
                            <span class="font-bold text-green-400">3.2% APY</span>
                        </div>
                        <div id="yield-protocol-yearn" class="flex justify-between items-center p-3 rounded-lg border border-transparent cursor-pointer text-gray-400 hover:border-gray-600" onclick="selectYield('yearn')">
                            <span class="font-medium">Yearn Finance</span>
                            <span class="font-bold text-green-400">5.8% APY</span>
                        </div>
                        <div id="yield-protocol-curve" class="flex justify-between items-center p-3 rounded-lg border border-transparent cursor-pointer text-gray-400 hover:border-gray-600" onclick="selectYield('curve')">
                            <span class="font-medium">Curve</span>
                            <span class="font-bold text-green-400">2.9% APY</span>
                        </div>
                        <div id="yield-protocol-convex" class="flex justify-between items-center p-3 rounded-lg border border-transparent cursor-pointer text-gray-400 hover:border-gray-600" onclick="selectYield('convex')">
                            <span class="font-medium">Convex</span>
                            <span class="font-bold text-green-400">4.5% APY</span>
                        </div>
                    </div>
                    <input type="hidden" id="selected-yield-protocol" value="aave">
                </div>

                <div id="standard-market-options" class="form-section space-y-4">
                    <h3 class="text-base font-semibold text-gray-200">Market Timing</h3>
                    <div class="space-y-2">
                        <label for="market-stake-duration" class="text-sm font-medium text-gray-300">Staking Window (Duration)</label>
                        <input type="text" id="market-stake-duration" class="ui-input" placeholder="e.g., 24h, 3d, 1 week">
                    </div>
                    <div class="space-y-2">
                        <label for="market-resolution-date" class="text-sm font-medium text-gray-300">Resolution Date</label>
                        <input type="date" id="market-resolution-date" class="ui-input" style="color-scheme: dark;">
                    </div>
                </div>

                <button id="create-market-btn" class="btn btn-primary lg:text-lg">Create Market</button>
                    </div>

                    <div class="lg:col-span-1">
                        <div class="lg:sticky lg:top-4 space-y-3">
                            <h3 class="text-base font-semibold text-gray-200">Live Preview</h3>
                            <div class="ui-panel">
                                <h3 id="preview-title" class="text-lg font-semibold text-white mb-3 leading-tight">...</h3>
                                <div class="flex justify-around my-5">
                                    <div class="text-center">
                                        <div id="preview-yes" class="text-4xl font-bold text-gray-400">--%</div>
                                        <div class="text-sm text-gray-300">YES</div>
                                    </div>
                                    <div class="text-center">
                                        <div id="preview-no" class="text-4xl font-bold text-gray-400">--%</div>
                                        <div class="text-sm text-gray-300">NO</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="market-detail-screen" class="screen screen-inactive space-y-6">
                <button onclick="goBack()" class="flex items-center text-sky-400 font-medium transition-colors hover:text-sky-300 lg:text-lg">
                    <svg class="w-5 h-5 mr-1 lg:w-6 lg:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    Back to Home
                </button>
                <h1 id="detail-title" class="text-2xl lg:text-3xl font-bold text-white">...</h1>

                <div class="lg:grid lg:grid-cols-3 lg:gap-6 space-y-6 lg:space-y-0">
                    <div class="lg:col-span-2 space-y-6">

                <div class="ui-panel">
                    <p id="detail-insight" class="text-gray-300 text-sm mb-6">...</p>
                    <div class="flex justify-around mb-6">
                        <div class="text-center">
                            <div id="detail-yes-percent" class="text-5xl font-bold text-green-400">--%</div>
                            <div class="text-sm text-gray-300">YES</div>
                        </div>
                        <div class="text-center">
                            <div id="detail-no-percent" class="text-5xl font-bold text-red-400">--%</div>
                            <div class="text-sm text-gray-300">NO</div>
                        </div>
                    </div>
                    <button id="ai-explain-btn" class="btn btn-secondary w-full">
                         Explain these Odds (AI)
                    </button>

                    <div id="ai-explain-panel" class="hidden mt-4 space-y-2 p-3 bg-black/20 rounded-lg text-sm text-gray-300">
                    </div>
                </div>

                <div id="detail-yield-panel" class="ui-panel hidden">
                    <h3 class="text-base font-semibold text-gray-200">Live Simulated Yield</h3>
                    <p class="text-sm text-gray-400 mb-3">Real-time simulation of yield from principal.</p>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-300">Total Yield Accrued:</span>
                        <span id="detail-yield-counter" class="text-2xl font-bold text-green-400">$0.00</span>
                    </div>
                </div>

                <div class="ui-panel space-y-4 mt-6">
                     <h2 class="text-base font-semibold text-gray-200">Market Analytics</h2>

                     <div class="text-center p-4 bg-black/20 rounded-lg">
                         <span class="text-xs text-gray-400">Total Volume Staked (TVL)</span>
                         <p id="market-tvl-text" class="text-3xl font-bold text-white">$0.00</p>
                     </div>

                     <div>
                         <canvas id="marketVolumeChart"></canvas>
                     </div>
                    <div class="border-t border-gray-700 pt-4 mt-4">
                        <button id="show-ticker-btn" class="btn btn-secondary w-full">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                            View Live Ticker
                            <span id="ticker-comment-count" class="ml-2 bg-sky-600 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden">0</span>
                        </button>
                    </div>
                 </div>
                    </div>

                    <div class="lg:col-span-1">
                        <div class="lg:sticky lg:top-4">
                            <div class="ui-panel space-y-4">
                                <h2 class="text-base font-semibold text-gray-200">Place Your Stake</h2>

                                <div class="space-y-2">
                                    <label for="stake-asset-select" class="text-sm font-medium text-gray-300">Stake with:</label>
                                    <select id="stake-asset-select" class="ui-select">
                                    </select>
                                </div>

                                <div class="space-y-2">
                                    <label for="stake-amount-input" class="text-sm font-medium text-gray-300">Amount</label>
                                    <input type="number" id="stake-amount-input" class="ui-input" placeholder="0.00">
                                </div>
                                <div id="stake-section" class="grid grid-cols-2 gap-4">
                                    <button id="stake-yes-btn" class="btn btn-stake-yes">
                                        Stake YES
                                    </button>
                                    <button id="stake-no-btn" class="btn btn-stake-no">
                                        Stake NO
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> 

            </div>



            <div id="leaderboard-screen" class="screen screen-inactive space-y-6">
                <h1 class="text-2xl lg:text-3xl font-bold gradient-text">Leaderboard</h1>
                <div id="user-rank-panel" class="ui-panel text-center p-6 lg:p-8 border-l-4 border-sky-400">
                    <p class="text-gray-400 lg:text-lg">Loading your rank...</p>
                </div>
                <div class="flex justify-around border-b border-white/10 max-w-2xl mx-auto">
                    <button class="profile-tab active lg:text-lg" data-filter="all-time">All-Time</button>
                    <button class="profile-tab lg:text-lg" data-filter="weekly">Weekly</button>
                    <button class="profile-tab lg:text-lg" data-filter="daily">Daily</button>
                </div>
                <div id="ranking-list" class="space-y-2 lg:space-y-3 max-w-3xl mx-auto">
                    <p class="text-gray-400 text-center pt-8 lg:text-lg">Fetching top players...</p>
                </div>
            </div>

            <div id="pledge-pool-screen" class="screen screen-inactive space-y-6">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl lg:text-3xl font-bold gradient-text">Pledge Pool (Quick Plays)</h1>
                </div>
                
                <!-- Empty State -->
                <div id="pledge-pool-empty" class="hidden max-w-2xl mx-auto text-center py-16 lg:py-24">
                    <div class="ui-panel p-8 lg:p-12">
                        <svg class="w-20 h-20 lg:w-24 lg:h-24 mx-auto mb-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                        </svg>
                        <h3 class="text-xl lg:text-2xl font-bold text-gray-300 mb-3">No Active Pledges</h3>
                        <p class="text-gray-400 lg:text-lg mb-6">Your pledge pool is empty. Join Quick Plays to see your pending pledges here!</p>
                        <button onclick="showScreen('quick-play-screen')" class="btn btn-primary lg:text-lg">
                            Explore Quick Plays
                        </button>
                    </div>
                </div>
                
                <!-- Pledges Grid -->
                <div id="pledge-pool-content" class="space-y-4 lg:grid lg:grid-cols-2 lg:gap-6 lg:space-y-0 xl:grid-cols-3 2xl:grid-cols-4">
                </div>

                <div id="pledge-pool-footer" class="ui-panel p-4 space-y-4 hidden">
                    <h3 class="text-base font-semibold text-white">Confirm All Pledges</h3>

                    <div class="space-y-2">
                        <label for="pledge-all-asset" class="text-sm font-medium text-gray-300">Asset to use:</label>
                        <select id="pledge-all-asset" class="ui-select">
                            <option value="BUSD">BUSD</option>
                            <option value="BNB">BNB</option>
                            <option value="CAKE">CAKE</option>
                        </select>
                    </div>

                    <div class="space-y-2">
                        <label class="text-sm font-medium text-gray-300">Quick Set (Optional)</label>
                        <p class="text-xs text-gray-400">Set all pledge amounts at once.</p>
                        <div class="flex justify-start space-x-2">
                            <button onclick="setPledgeAll(1, 'BUSD')" class="btn-quick-tap">$1</button>
                            <button onclick="setPledgeAll(5, 'BUSD')" class="btn-quick-tap">$5</button>
                            <button onclick="setPledgeAll(10, 'BUSD')" class="btn-quick-tap">$10</button>
                        </div>
                    </div>

                    <p id="pledge-total-summary" class="text-center text-gray-400 text-sm h-5"></p>

                    <button id="stake-all-pledges-btn" class="btn btn-primary">
                        Confirm Pledges
                    </button>
                </div>
            </div>

            <div id="profile-screen" class="screen screen-inactive space-y-6">
                <div class="lg:grid lg:grid-cols-3 lg:gap-6 space-y-6 lg:space-y-0">
                    <div class="lg:col-span-1 space-y-6">
                        <div id="profile-panel" class="ui-panel flex flex-col items-center lg:p-6 relative">
                            <!-- Theme Toggle at Top -->
                            <button onclick="toggleThemeWithFlip()" class="absolute top-4 right-4 p-2 rounded-full hover:bg-white/10 transition-all duration-200">
                                <svg id="profile-theme-icon-sun" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                </svg>
                                <svg id="profile-theme-icon-moon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                                </svg>
                            </button>
                            
                            <div class="w-20 h-20 lg:w-24 lg:h-24 bg-gradient-to-br from-indigo-600 to-blue-600 rounded-full flex items-center justify-center text-white font-bold text-4xl lg:text-5xl shadow-lg mb-4">
                                P
                            </div>
                            <h1 id="profile-display-name" class="text-2xl lg:text-3xl font-bold text-white">...</h1>
                            <p id="profile-wallet-address" class="text-sm lg:text-base text-gray-400 mt-2">Connecting wallet...</p>
                            
                            <!-- Follower Count - Clickable -->
                            <button onclick="handleProfileTab('networking'); handleNetworkingTab('followers');" class="mt-2 px-3 py-1 rounded-full bg-white/5 hover:bg-white/10 transition-all duration-200 border border-white/10">
                                <span id="profile-follower-count" class="text-sm text-gray-400">
                                    <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                    </svg>
                                    0 Followers
                                </span>
                            </button>
                            
                            <div class="flex flex-wrap justify-center gap-2 mt-3">
                                <span id="profile-xp-badge" class="badge badge-xp">... XP</span>
                                <span id="profile-rank-badge" class="badge badge-rank">Rank: ...</span>
                                <span id="profile-accuracy-badge" class="badge badge-green">...% Accuracy</span>
                                <span id="user-streak-text" class="badge badge-blue"> 0 Wins</span>
                            </div>
                        </div>

                        <div class="ui-panel p-4 lg:p-6 space-y-3">
                            <h3 class="text-base font-semibold text-sky-300">AI Performance Review</h3>
                            <p class="text-sm text-gray-400">Get a summary of your prediction history.</p>
                            <button id="ai-profile-summary-btn" class="btn btn-secondary w-full">
                                 Generate My Summary
                            </button>
                            <div id="ai-profile-summary-panel" class="hidden mt-3 p-3 bg-black/20 rounded-lg text-sm text-gray-300">

                            </div>
                        </div>

                        <div class="ui-panel lg:p-6">
                            <h2 class="text-base font-semibold gradient-text mb-3">Staking Summary</h2>
                            <div class="grid grid-cols-2 gap-4 text-center">
                                <div>
                                    <span class="text-xs text-gray-400">Total Staked</span>
                                    <p id="total-principal" class="text-xl lg:text-2xl font-semibold text-white">$0.00</p>
                                </div>
                                <div>
                                    <span class="text-xs text-gray-400">Mock BUSD</span>
                                    <p id="mock-balance" class="text-xl lg:text-2xl font-semibold text-green-400">$100.00</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-2">

                <div>
                    <div class="grid grid-cols-5 border-b border-white/10">
                        <button id="tab-active" class="profile-tab active" onclick="handleProfileTab('active')">Active</button>
                        <button id="tab-history" class="profile-tab" onclick="handleProfileTab('history')">History</button>
                        <button id="tab-notifications" class="profile-tab relative" onclick="handleProfileTab('notifications')">
                            Alerts
                            <span id="notification-badge-profile" class="hidden absolute -top-1 -right-1 w-4 h-4 bg-rose-500 text-white text-xs font-bold rounded-full flex items-center justify-center">0</span>
                        </button>
                        <button id="tab-networking" class="profile-tab" onclick="handleProfileTab('networking')">Network</button>
                        <button id="tab-assets" class="profile-tab" onclick="handleProfileTab('assets')">Assets</button>
                    </div>
                    <div class="pt-4">
                        <div id="active-stakes-content">
                            <p class="text-gray-400 text-center pt-8">Loading active stakes...</p>
                        </div>
                        <div id="history-content" class="hidden">
                            <p class="text-gray-400 text-center pt-8">Loading history...</p>
                        </div>
                        
                        <div id="notifications-content" class="hidden space-y-3">
                            <!-- Notification Filter Tabs -->
                            <div class="flex border-b border-[#30363D] dark:border-[#30363D] light:border-gray-200 mb-4">
                                <button onclick="filterNotifications('all')" class="notif-tab flex-1 px-4 py-2 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent hover:border-sky-400 transition-all active" data-filter="all">
                                    All
                                </button>
                                <button onclick="filterNotifications('markets')" class="notif-tab flex-1 px-4 py-2 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent hover:border-sky-400 transition-all" data-filter="markets">
                                    Markets
                                </button>
                                <button onclick="filterNotifications('social')" class="notif-tab flex-1 px-4 py-2 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent hover:border-sky-400 transition-all" data-filter="social">
                                    Social
                                </button>
                            </div>
                            
                            <!-- Notifications Feed -->
                            <div id="notifications-feed-profile" class="space-y-3">
                                <p class="text-gray-400 text-center py-8 text-sm">No notifications yet</p>
                            </div>
                        </div>

                <div id="assets-content" class="hidden space-y-3">
                    <p class="text-gray-400 text-center pt-8">Loading assets...</p>
                </div> 

                        <div id="networking-content" class="hidden space-y-4">
                            <div class="flex justify-around border-b border-white/10">
                                <button id="sub-tab-followers" class="profile-tab active" data-subtab="followers" onclick="handleNetworkingTab('followers')">Followers</button>
                                <button id="sub-tab-following" class="profile-tab" data-subtab="following" onclick="handleNetworkingTab('following')">Following</button>
                            </div>
                            <div class="pt-4">
                                <div id="followers-list-content" class="space-y-3">
                                    <p class="text-gray-400 text-center pt-8">Loading followers...</p>
                                </div>
                                <div id="following-list-content" class="hidden space-y-3">
                                    <p class="text-gray-400 text-center pt-8">Loading following list...</p>
                                </div>
                            </div>
                        </div>


</div> </div> <div id="logout-button-container" class="pt-4 hidden">

            <button onclick="logout()" class="btn btn-secondary w-full lg:w-auto lg:px-8" style="border-color: #EF4444; color: #F87171;">
                Log Out
            </button>
        </div>
                    </div>
                </div>

    </div> 


            <div id="quick-play-screen" class="screen screen-inactive">
                        <button onclick="goBack()" class="absolute top-4 left-4 z-10 flex items-center text-sky-400 font-medium transition-colors hover:text-sky-300">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    Back to Home
                </button>
                <div id="quick-play-card-container">
                    <div id="quick-play-card">
                        </div>
                </div>
                <div class="flex justify-around items-center p-6">
                    <button onclick="handleQuickPlay('no')" class="quick-play-btn quick-play-btn-no">NO</button>
                    <button onclick="handleQuickPlay('skip')" class="quick-play-btn quick-play-btn-skip">SKIP</button>
                    <button onclick="handleQuickPlay('yes')" class="quick-play-btn quick-play-btn-yes">YES</button>
                </div>
            </div>

            <div id="admin-panel-screen" class="screen screen-inactive space-y-6">
                <h1 class="text-2xl font-bold gradient-text">Admin Panel</h1>

                <div class="ui-panel p-4 space-y-4">
                    <h2 class="text-lg font-semibold text-white">Quick Play Publisher</h2>
                    <p class="text-sm text-gray-400">Use the AI to pre-fill, or create manually.</p>

                    <div class="space-y-2">
                        <label for="admin-ai-prompt" class="text-sm font-medium text-gray-300">AI Prompt (Optional)</label>
                        <div class="flex space-x-2">
                            <textarea id="admin-ai-prompt" rows="1" class="ui-input" placeholder="e.g., 'Grammys'"></textarea>
                            <button id="admin-generate-btn" class="btn btn-secondary w-28 flex-shrink-0">AI Fill</button>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label for="admin-qp-title" class="text-sm font-medium text-gray-300">Title</label>
                        <textarea id="admin-qp-title" rows="2" class="ui-input"></textarea>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <div class="space-y-2">
                            <label for="admin-qp-duration" class="text-sm font-medium text-gray-300">Duration</label>
                            <input id="admin-qp-duration" type="text" class="ui-input" placeholder="e.g., 24h">
                        </div>
                        <div class="space-y-2">
                            <label for="admin-qp-yes" class="text-sm font-medium text-gray-300">YES %</label>
                            <input id="admin-qp-yes" type="number" class="ui-input" placeholder="50">
                        </div>
                        <div class="space-y-2">
                            <label for="admin-qp-no" class="text-sm font-medium text-gray-300">NO %</label>
                            <input id="admin-qp-no" type="number" class="ui-input" placeholder="50">
                        </div>
                    </div>
                    <button id="admin-publish-btn" class="btn btn-primary w-full">Publish Quick Play</button>
                </div>

                <div class="ui-panel p-4 space-y-4">
                    <h2 class="text-lg font-semibold text-white">Resolve Active Markets</h2>
                    <p class="text-sm text-gray-400 mb-4">Select the outcome to finalize the market and pay winners.</p>
                    <div id="resolution-list" class="space-y-4">
                        <p class="text-gray-400 text-center">Loading markets...</p>
                    </div>
                </div>

                <div class="ui-panel p-4 space-y-4">
                    <h2 class="text-lg font-semibold text-white">Resolve Active Quick Plays</h2>
                    <p class="text-sm text-gray-400 mb-4">Finalize Quick Play markets and pay winners.</p>
                    <div id="quick-play-resolution-list" class="space-y-4">
                        <p class="text-gray-400 text-center">Loading quick plays...</p>
                    </div>
                </div>
                <button id="admin-logout-btn" class="btn btn-secondary w-full">Log Out of Admin</button>

                <div class="ui-panel p-4 space-y-3">
                    <h2 class="text-lg font-semibold text-red-400"> Submission Prep: Clear Data</h2>
                    <p class="text-sm text-gray-400">This action deletes ALL demo markets and ALL pledges/scores.</p>
                    <button onclick="clearAllDemoData()" class="btn" style="background-color: #991b1b; color: white;">
                        WIPE ALL DEMO DATA (Admin Only)
                    </button>
                </div>

                <div class="ui-panel p-4 space-y-3">
                    <h2 class="text-lg font-semibold text-yellow-400"> Admin Test: Run Oracle</h2>
                    <p class="text-sm text-gray-400">This manually runs the auto-resolve and daily-create jobs. Make sure you've set your CRON_SECRET in Replit.</p>
                    <button id="run-oracle-btn" class="btn" style="background-color: #ca8a04; color: white;">
                        Run Oracle Jobs
                    </button>
                </div>

            </div>


            <div id="admin-password-screen" class="screen screen-inactive space-y-4">
                <h1 class="text-2xl font-bold gradient-text">Admin Access</h1>
                <div class="space-y-2">
                    <label for="admin-password-input" class="text-sm font-medium text-gray-300">Enter Password</label>
                    <input type="password" id="admin-password-input" class="ui-input">
                </div>
                <button id="admin-login-btn" class="btn btn-primary w-full">Login</button>
                <button onclick="showScreen('login-screen')" class="btn btn-secondary w-full">Cancel</button>
            </div>

            <!-- ADD NEW SCREEN  -->
            <div id="search-results-screen" class="screen screen-inactive space-y-6">
                <button onclick="goBack()" class="flex items-center text-sky-400 font-medium transition-colors hover:text-sky-300">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    Back to Home
                </button>
                <h1 id="search-results-title" class="text-2xl font-bold gradient-text">Search Results</h1>

                <div id="search-results-list" class="space-y-4">
                    <!-- Search results will be injected here -->
                    <p class="text-gray-400 text-center">Type to search...</p>
                </div>
            </div>
            <!-- END OF NEW SCREEN -->

            <div id="public-profile-screen" class="screen screen-inactive space-y-6">
                <button onclick="goBack()" class="flex items-center text-sky-400 font-medium transition-colors hover:text-sky-300">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    Back
                </button>

                <div class="ui-panel flex flex-col items-center">
                    <div id="public-profile-avatar" class="w-20 h-20 rounded-full flex items-center justify-center shadow-lg mb-4 bg-gradient-to-br from-indigo-600 to-blue-600">
                        </div>
                    <h1 id="public-profile-name" class="text-2xl font-bold text-white">...</h1>
                    
                    <!-- Follower Count Display for Public Profile -->
                    <button onclick="viewUserFollowers(currentPublicUserId)" class="mt-2 px-3 py-1 rounded-full bg-white/5 hover:bg-white/10 transition-all duration-200 border border-white/10">
                        <span id="public-profile-follower-count" class="text-sm text-gray-400">
                            <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                            </svg>
                            0 Followers
                        </span>
                    </button>
                    
                    <div class="flex flex-wrap justify-center gap-2 mt-3">
                        <span id="public-profile-xp-badge" class="badge badge-xp">... XP</span>
                        <span id="public-profile-rank-badge" class="badge badge-rank">Rank: ...</span>
                        <span id="public-profile-accuracy-badge" class="badge badge-green">...% Accuracy</span>
                    </div>
                </div>

                <button id="follow-btn" class="btn btn-primary w-full">
                    Follow
                </button>

                <div>
                    <div class="grid grid-cols-3 border-b border-white/10">
                        <button class="profile-tab active" data-pubtab="active" onclick="handlePublicProfileTab('active')">Active</button>
                        <button class="profile-tab" data-pubtab="history" onclick="handlePublicProfileTab('history')">History</button>
                        <button class="profile-tab" data-pubtab="followers" onclick="handlePublicProfileTab('followers')">Followers</button>
                    </div>
                    <div class="pt-4">
                        <div id="public-active-stakes-content">
                            <p class="text-gray-400 text-center pt-8">Loading active stakes...</p>
                        </div>
                        <div id="public-history-content" class="hidden">
                            <p class="text-gray-400 text-center pt-8">Loading history...</p>
                        </div>
                        <div id="public-followers-content" class="hidden space-y-3">
                            <p class="text-gray-400 text-center pt-8">Loading followers...</p>
                        </div>
                    </div>
                </div>
            </div>




        </main>

                <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 z-50 max-w-md mx-auto px-1 py-3 flex justify-around items-center md:hidden">

            <button onclick="showScreen('home-screen')" class="nav-button flex flex-col items-center text-sky-400">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6-4v4m0-4h4"></path></svg>
                <span class="text-xs mt-1">Home</span>
            </button>
            <button onclick="showScreen('leaderboard-screen')" class="nav-button flex flex-col items-center text-gray-400">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                <span class="text-xs mt-1">Leaders</span>
            </button>
            <button onclick="showScreen('create-market-screen')" class="nav-button flex flex-col items-center text-gray-400 -mt-2 bg-gradient-to-br from-indigo-600 to-blue-600 p-3 rounded-full shadow-lg shadow-blue-500/30 border-2 border-sky-400">
                <svg class="w-5 h-5" fill="none" stroke="white" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
            </button>
            <button onclick="showScreen('pledge-pool-screen')" class="nav-button flex flex-col items-center text-gray-400">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                <span class="text-xs mt-1">Pledges</span>
            </button>
            <button onclick="showScreen('profile-screen')" class="nav-button flex flex-col items-center text-gray-400">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                <span class="text-xs mt-1">Profile</span>
            </button>
        </nav>

        <!-- Toast Notification Container -->
        <div id="toast-container" class="fixed top-20 right-4 z-[999] space-y-2 max-w-sm">
            <!-- Toasts will be dynamically inserted here -->
        </div>

        <div id="loading-overlay" class="hidden fixed inset-0 bg-black/80 z-[998] flex justify-center items-center backdrop-blur-sm">
            <div class="spinner w-10 h-10 border-4 border-transparent rounded-full"></div>
            <span id="loading-message" class="ml-4 text-white text-lg">Loading...</span>
        </div>

        <div id="mock-wallet-modal" class="hidden">
            <div class="ui-panel text-center w-11/12 max-w-sm">
                <h2 class="text-2xl font-bold text-green-400 mb-4"> Demo Wallet Active</h2>
                <p class="text-gray-300">This is your persistent mock wallet for this demo account.</p>
                <div id="mock-wallet-details" class="space-y-2 mt-4 text-left p-3 bg-black/20 rounded-lg">
                    <p class="text-gray-400 text-center">Loading wallet details...</p>
                </div>
                <button onclick="closeMockWalletModal()" class="btn btn-primary w-full mt-6">Got it</button>
            </div>
        </div>

    </div>

    <div id="quick-play-detail-modal" class="hidden fixed inset-0 z-[995] bg-black/70 backdrop-blur-sm flex justify-center items-center p-4">

        <div class="ui-panel w-full max-w-sm">
            <h2 id="qp-modal-title" class="text-xl font-bold text-white mb-4">...</h2>

            <div class="space-y-3">
                <h3 class="text-sm font-semibold text-sky-300">AI Insight</h3>
                <p id="qp-modal-insight" class="text-gray-300 text-sm bg-black/20 p-3 rounded-lg">
                    Loading insight...
                </p>
            </div>

            <button onclick="closeQuickPlayDetails()" class="btn btn-primary w-full mt-6">
                Got it
            </button>
        </div>

    </div>

    <div id="ai-verdict-modal" class="hidden fixed inset-0 z-[995] bg-black/70 backdrop-blur-sm flex justify-center items-center p-4">

        <div class="ui-panel w-full max-w-sm space-y-4">

            <div class="text-center">
                <span id="verdict-modal-outcome" class="text-2xl font-bold text-green-400">MARKET RESOLVED: YES</span>
            </div>

            <div>
                <h3 class="text-sm font-semibold text-sky-300">AI Judge's Rationale</h3>
                <p id="verdict-modal-rationale" class="text-gray-300 text-sm bg-black/20 p-3 rounded-lg mt-2">
                    Loading rationale...
                </p>
                <a id="verdict-modal-source" href="#" target="_blank" rel="noopener noreferrer" class="text-sky-400 text-xs truncate block mt-2 hover:underline">
                    View Source: http://...
                </a>
            </div>

            <div>
                <h3 class="text-sm font-semibold text-red-400">Dispute this Outcome?</h3>
                <p class="text-xs text-gray-400 mt-1">
                    If you believe the AI is wrong, you can open a Jury dispute.
                </p>
                <button onclick="handleDispute()" class="btn btn-secondary w-full mt-3" style="border-color: #EF4444; color: #F87171;">
                    DISPUTE (Cost: 10 BUSD)
                </button>
            </div>

            <button onclick="closeVerdictModal()" class="btn btn-primary w-full mt-4">
                Close
            </button>
        </div>
        </div>
        <div id="avatar-modal" class="hidden fixed inset-0 z-[995] bg-black/70 backdrop-blur-sm flex justify-center items-center p-4">
            <div class="ui-panel w-full max-w-sm space-y-4">

                <h2 class="text-xl font-bold text-white text-center">Choose Your Avatar</h2>
                <p class="text-sm text-gray-400 text-center">Select your identity to enter Predora.</p>

                <!-- Avatar Grid -->
                <div id="avatar-grid" class="grid grid-cols-3 gap-4">
                    <p class="text-gray-400 col-span-3 text-center">Loading avatars...</p>
                </div>
            </div>
        </div>

    <div id="ticker-modal" class="hidden fixed inset-0 z-[995] bg-black/70 backdrop-blur-sm flex flex-col justify-end">

        <!-- This is the slide-up panel -->
        <div id="ticker-panel" class="ui-panel w-full max-w-md mx-auto rounded-b-none h-[70vh] flex flex-col transform translate-y-full transition-transform duration-300 ease-out">

            <!-- 1. Header -->
            <div class="flex justify-between items-center pb-3 border-b border-gray-700">
                <h2 class="text-xl font-bold gradient-text">Live Ticker</h2>
                <button onclick="closeTickerModal()" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>

            <!-- 2. Scrolling Feed -->
            <div id="ticker-feed-content" class="flex-grow py-4 overflow-y-auto space-y-4">
                <!-- Comments will be loaded here -->
                <p class="text-gray-400 text-center">Loading feed...</p>
            </div>

            <!-- 3. Input Area (Stake-to-Chat) -->
            <div class="border-t border-gray-700 pt-4">

                <!-- This message shows when chat is LOCKED -->
                <div id="ticker-locked-message" class="text-center p-3 bg-gray-800/50 rounded-lg">
                    <p class="text-sm font-semibold text-gray-300">Stake in this market to join the chat.</p>
                </div>

                <!-- This input shows when chat is UNLOCKED -->
                <div id="ticker-input-area" class="hidden flex space-x-2">
                    <input type="text" id="ticker-comment-input" class="ui-input flex-grow" placeholder="Add your insight...">
                    <button id="ticker-post-btn" class="btn btn-primary w-20">Post</button>
                </div>
            </div>

        </div>
    </div>


    <script type="module">
        // --- Import Firebase modules ---
        // These are imported from the web to make the HTML file self-contained
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            signInWithCustomToken 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        import { 
            getFirestore, 
            doc, getDoc, setDoc, 
            updateDoc, deleteDoc, 
            onSnapshot, collection, 
            query, where, 
            increment, addDoc, 
            serverTimestamp, writeBatch, getDocs, 
            runTransaction, 
            setLogLevel,
            orderBy,
            limit
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // --- Pass all imports to a global window object for convenience ---
        window.firebase = {
            app: { initializeApp },
            auth: { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken },
            firestore: { 
                getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, 
                onSnapshot, collection, query, where, increment, addDoc, 
                serverTimestamp, writeBatch, setLogLevel, getDocs,
                runTransaction, orderBy, limit
            }
        };

        // --- GLOBAL APP LOGIC ---

        // --- GLOBAL STATE & CONSTANTS ---
        let db, auth;
        let currentScreenId = 'login-screen'; 
        let currentUserId = null;
        let userProfile = { 
            xp: 0, displayName: '', walletAddress: '', isApproved: false, 
            balance: 100, bnbBalance: 0.2, cakeBalance: 150 
        };

        // --- Firestore Real-time Listeners (for cleanup) ---
        let userProfileUnsubscribe = null;
        let standardMarketsUnsubscribe = null;
        let quickPlayUnsubscribe = null;
        let activeStakesUnsubscribe = null;
        let historyStakesUnsubscribe = null;
        let leaderboardUnsubscribe = null;
        let detailMarketUnsubscribe = null; // --- RACE CONDITION FIX (NEW) ---
        let userHistoryData = []; // To store history for AI summary

        // --- DOM ELEMENTS (Cached for performance) ---
        let dom = {};

        // --- CONFIGURATION ---
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'predora-hackathon';

        // ---  ---
        // This is where to set  logo and the other avatar options
        const LOGO_URL = "https://res.cloudinary.com/djslxbghy/image/upload/Predora-app.png";
        const AVATAR_LIST = [
            LOGO_URL,
            "https://res.cloudinary.com/djslxbghy/image/upload/IMG_4934_kmonb7.png",
            "https://res.cloudinary.com/djslxbghy/image/upload/IMG_4936_mfgrnq.png",
            "https://res.cloudinary.com/djslxbghy/image/upload/IMG_4938_p3ekdi.png",
            "https://res.cloudinary.com/djslxbghy/image/upload/IMG_4940_c3y04c.png",
            "https://res.cloudinary.com/djslxbghy/image/upload/IMG_4942_ipa7g6.png",
            "https://res.cloudinary.com/djslxbghy/image/upload/IMG_4945_ymkcqz.png",
            "https://res.cloudinary.com/djslxbghy/image/upload/IMG_4948_qskmio.png"
        ];

        const ADMIN_PASSWORD = "predora-admin";

        // --- GEMINI API CONSTANTS ---

          const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        const GEMINI_API_KEY = "";

        // --- FIRESTORE PATHS ---
        // All data is stored in a "public" path for the hackathon demo
        // In a real app, these paths would be secured with Firestore Rules
        const USER_PROFILE_COLLECTION = 'profile'; 
        const PUBLIC_LEADERBOARD_COLLECTION = 'leaderboard'; 
        const STANDARD_MARKETS_COLLECTION = 'standard_markets'; 
        const QUICK_PLAY_MARKETS_COLLECTION = 'quick_play_markets'; 
        const PLEDGES_COLLECTION = 'pledges'; 
        const STAKE_LOGS_COLLECTION = 'stake_logs';
        const MARKET_COMMENTS_COLLECTION = 'market_comments';

        // --- Local State ---
        let currentMarket = null; 
        let currentMarketId = null;
        let pledgePoolItems = []; 
        let currentQuickPlayIndex = 0;
        let isAnimating = false;
        let yieldInterval;
        let allStandardMarkets = [];
        let currentCategoryFilter = 'All';
        let marketChart = null; 
        let tickerUnsubscribe = null;
        let toastTimer;

        // --- Mock Data ---
        const MOCK_ETH_MARKET = {
            id: 'mock-eth-1',
            title: 'Will ETH reach $5,000 by the end of the year?',
            insight: 'This is a mock market to demonstrate the app\'s functionality. Staking on this market will use your real mock balance!',
            yesPercent: 65,
            noPercent: 35,
            isNoLoss: true,
            stakeDuration: '7 days',
            yieldProtocol: 'aave',
            createdByDisplayName: 'PredoraBot',
            isMock: true
        };

        // === THEME MANAGEMENT ===
        function toggleThemeWithFlip() {
            const panel = document.getElementById('profile-panel');
            
            // Add flip animation
            panel.classList.add('flip-left');
            
            // Toggle theme at the midpoint of animation
            setTimeout(() => {
                toggleTheme();
            }, 300);
            
            // Remove animation class after it completes
            setTimeout(() => {
                panel.classList.remove('flip-left');
            }, 600);
        }
        
        function toggleTheme() {
            const html = document.documentElement;
            const body = document.body;
            const sunIcon = document.getElementById('theme-icon-sun');
            const moonIcon = document.getElementById('theme-icon-moon');
            const profileSunIcon = document.getElementById('profile-theme-icon-sun');
            const profileMoonIcon = document.getElementById('profile-theme-icon-moon');
            
            html.classList.toggle('light-mode');
            body.classList.toggle('light-mode');
            const isLightMode = html.classList.contains('light-mode');
            
            // Toggle desktop icons
            if (sunIcon && moonIcon) {
                if (isLightMode) {
                    sunIcon.classList.remove('hidden');
                    moonIcon.classList.add('hidden');
                } else {
                    sunIcon.classList.add('hidden');
                    moonIcon.classList.remove('hidden');
                }
            }
            
            // Toggle profile icons
            if (profileSunIcon && profileMoonIcon) {
                if (isLightMode) {
                    profileSunIcon.classList.remove('hidden');
                    profileMoonIcon.classList.add('hidden');
                } else {
                    profileSunIcon.classList.add('hidden');
                    profileMoonIcon.classList.remove('hidden');
                }
            }
            
            // Save preference
            localStorage.setItem('theme', isLightMode ? 'light' : 'dark');
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const html = document.documentElement;
            const body = document.body;
            const sunIcon = document.getElementById('theme-icon-sun');
            const moonIcon = document.getElementById('theme-icon-moon');
            const profileSunIcon = document.getElementById('profile-theme-icon-sun');
            const profileMoonIcon = document.getElementById('profile-theme-icon-moon');
            
            // Sync body class with html class (set by inline script)
            if (html.classList.contains('light-mode')) {
                body.classList.add('light-mode');
            }
            
            // Sync desktop icons
            if (sunIcon && moonIcon) {
                if (savedTheme === 'light') {
                    sunIcon.classList.remove('hidden');
                    moonIcon.classList.add('hidden');
                } else {
                    sunIcon.classList.add('hidden');
                    moonIcon.classList.remove('hidden');
                }
            }
            
            // Sync profile icons
            if (profileSunIcon && profileMoonIcon) {
                if (savedTheme === 'light') {
                    profileSunIcon.classList.remove('hidden');
                    profileMoonIcon.classList.add('hidden');
                } else {
                    profileSunIcon.classList.add('hidden');
                    profileMoonIcon.classList.remove('hidden');
                }
            }
        }

        // Initialize theme on load
        window.toggleTheme = toggleTheme;
        window.toggleThemeWithFlip = toggleThemeWithFlip;

        // --- INITIALIZATION ---
        document.addEventListener("DOMContentLoaded", () => {
            // Initialize theme immediately when DOM is ready
            initTheme();

            // Load the pledge pool from storage
            const savedPledgePool = localStorage.getItem('pledgePool');
            if (savedPledgePool) {
                try {
                    pledgePoolItems = JSON.parse(savedPledgePool);
                } catch (e) {
                    console.error("Could not parse pledge pool:", e);
                    pledgePoolItems = []; // Start fresh if data is corrupt
                }
            }
            
            // Render pledge pool to show empty state on initial load
            if (typeof renderPledgePool === 'function') {
                renderPledgePool();
            }
            // ---- END ADD ----

            if (window.firebase) {
                startApp();
            } else {
                console.error("Firebase is not loaded.");
                alert("CRITICAL ERROR: Firebase not loaded.");
            }
        });

        /**
         * Initializes the Firebase app, caches DOM, and checks for a saved session.
         */
        function startApp() {
            const { initializeApp } = window.firebase.app;
            const { getAuth } = window.firebase.auth;
            const { getFirestore, setLogLevel } = window.firebase.firestore;

            try {

                const firebaseConfig = {
                    apiKey: "AIzaSyCr36OARwTBJduV9PJI6FfhDKRVwxarBBM",
                    authDomain: "predora-app.firebaseapp.com",
                    projectId: "predora-app",
                    storageBucket: "predora-app.appspot.com",
                    messagingSenderId: "264141669177",
                    appId: "1:264141669177:web:e650746b9ed7ce2a1fdee8",
                };
                const app = initializeApp(firebaseConfig);

                db = getFirestore(app);
                auth = getAuth(app);

                // setLogLevel('debug'); // Uncomment for verbose Firestore logs
                cacheDomElements();
                setupEventListeners(); // Wires up all app buttons
                startMockAliveFeatures(); // Starts the " online" counter

                // --- Session Resume Logic ---
                const demoUserId = localStorage.getItem('demoUserId');
                const demoDisplayName = localStorage.getItem('demoDisplayName');

                if (demoUserId && demoDisplayName) {
                    // User has a saved session, log them back in
                    console.log(`Resuming session for demo user: ${demoDisplayName}`);
                    currentUserId = demoUserId;
                    userProfile.displayName = demoDisplayName;

                    initializeUserProfile().then(() => {
                        attachDataListeners();
                        showScreen('home-screen');
                    }).catch(err => {
                        console.error("Failed to init profile on resume:", err);
                        showScreen('login-screen'); // Fallback to login
                    });
                } else {
                    // No session, show the login screen
                    console.log("No demo user in localStorage, showing login screen.");
                    showScreen('login-screen');
                }

            } catch (error) {
                console.error("Error during Firebase initialization:", error);
                alert(`Firebase Init Error: ${error.message}`);
            }
        }

        /**
         * Caches all frequently used DOM elements into the `dom` object.
         */
        function cacheDomElements() {


            dom.userStreakText = document.getElementById('user-streak-text');

            dom.screens = document.querySelectorAll('.screen');

            dom.navButtons = document.querySelectorAll('.nav-button');
            dom.topNav = document.getElementById('top-nav');
            dom.bottomNav = document.getElementById('bottom-nav');
            dom.loadingOverlay = document.getElementById('loading-overlay');
            dom.loadingMessage = document.getElementById('loading-message');
            dom.mockWalletModal = document.getElementById('mock-wallet-modal');

            dom.quickPlayCard = document.getElementById('quick-play-card');

            dom.profileDisplayName = document.getElementById('profile-display-name');
            dom.profileWalletAddress = document.getElementById('profile-wallet-address');
            dom.profileXpBadge = document.getElementById('profile-xp-badge');
            dom.profileRankBadge = document.getElementById('profile-rank-badge');
            dom.profileAccuracyBadge = document.getElementById('profile-accuracy-badge');
            dom.totalPrincipal = document.getElementById('total-principal');
            dom.mockBalance = document.getElementById('mock-balance'); 
            dom.activeStakesContent = document.getElementById('active-stakes-content');
            dom.historyContent = document.getElementById('history-content');
            dom.assetsContent = document.getElementById('assets-content'); 
            dom.aiProfileSummaryBtn = document.getElementById('ai-profile-summary-btn'); 
            dom.aiProfileSummaryPanel = document.getElementById('ai-profile-summary-panel'); 

            dom.marketYesInput = document.getElementById('market-yes-input');
            dom.marketNoInput = document.getElementById('market-no-input');
            dom.previewTitle = document.getElementById('preview-title');
            dom.previewYes = document.getElementById('preview-yes');
            dom.previewNo = document.getElementById('preview-no');

            dom.detailTitle = document.getElementById('detail-title');
            dom.detailInsight = document.getElementById('detail-insight');
            dom.detailYesPercent = document.getElementById('detail-yes-percent');
            dom.detailNoPercent = document.getElementById('detail-no-percent');
            dom.detailYieldPanel = document.getElementById('detail-yield-panel');
            dom.detailYieldCounter = document.getElementById('detail-yield-counter');
            dom.stakeAssetSelect = document.getElementById('stake-asset-select');
            dom.aiExplainBtn = document.getElementById('ai-explain-btn');
            dom.aiExplainPanel = document.getElementById('ai-explain-panel');
            dom.stakeSection = document.getElementById('stake-section');
            dom.stakeAmountInput = document.getElementById('stake-amount-input');

            dom.userRankPanel = document.getElementById('user-rank-panel');
            dom.rankingList = document.getElementById('ranking-list');

            dom.pledgePoolContent = document.getElementById('pledge-pool-content');
            dom.pledgePoolFooter = document.getElementById('pledge-pool-footer');
            dom.pledgeAllAsset = document.getElementById('pledge-all-asset');
            dom.pledgeTotalSummary = document.getElementById('pledge-total-summary');
            dom.stakeAllPledgesBtn = document.getElementById('stake-all-pledges-btn');

            dom.resolutionList = document.getElementById('resolution-list');
            dom.quickPlayResolutionList = document.getElementById('quick-play-resolution-list');

            dom.adminQpTitle = document.getElementById('admin-qp-title');
            dom.adminQpDuration = document.getElementById('admin-qp-duration');
            dom.adminQpYes = document.getElementById('admin-qp-yes');
            dom.adminQpNo = document.getElementById('admin-qp-no');
            dom.logoutButtonContainer = document.getElementById('logout-button-container');

            dom.quickPlayDetailModal = document.getElementById('quick-play-detail-modal');
            dom.qpModalTitle = document.getElementById('qp-modal-title');
            dom.qpModalInsight = document.getElementById('qp-modal-insight');
            dom.aiVerdictModal = document.getElementById('ai-verdict-modal');
            dom.verdictModalOutcome = document.getElementById('verdict-modal-outcome');

            dom.verdictModalRationale = document.getElementById('verdict-modal-rationale');

            dom.verdictModalSource = document.getElementById('verdict-modal-source');

            dom.detailTotalPool = document.getElementById('detail-total-pool');
            dom.marketTvlText = document.getElementById('market-tvl-text');

            dom.searchBarInput = document.getElementById('search-bar-input');
            dom.standardMarketsFeed = document.getElementById('standard-markets-feed');

              dom.avatarModal = document.getElementById('avatar-modal');

            // --- Ticker Modal Elements ---
            dom.tickerModal = document.getElementById('ticker-modal');
            dom.tickerPanel = document.getElementById('ticker-panel');
            dom.tickerFeedContent = document.getElementById('ticker-feed-content');
            dom.tickerLockedMessage = document.getElementById('ticker-locked-message');
            dom.tickerInputArea = document.getElementById('ticker-input-area');
            dom.tickerCommentInput = document.getElementById('ticker-comment-input');
            dom.tickerPostBtn = document.getElementById('ticker-post-btn');
            dom.showTickerBtn = document.getElementById('show-ticker-btn');
            dom.tickerCommentCount = document.getElementById('ticker-comment-count');


            // --- : Social/Public Profile Elements ---
            dom.publicProfileName = document.getElementById('public-profile-name');
            dom.publicProfileAvatar = document.getElementById('public-profile-avatar');
            dom.publicProfileXpBadge = document.getElementById('public-profile-xp-badge');
            dom.publicProfileRankBadge = document.getElementById('public-profile-rank-badge');
            dom.publicProfileAccuracyBadge = document.getElementById('public-profile-accuracy-badge');
            dom.followBtn = document.getElementById('follow-btn');
            dom.publicActiveStakesContent = document.getElementById('public-active-stakes-content');

            dom.publicHistoryContent = document.getElementById('public-history-content');

            dom.topNavButtons = document.querySelectorAll('.top-nav-btn');

            // --- Create Market Liquidity Inputs ---
            dom.marketLiquidityInput = document.getElementById('market-liquidity-input');
            dom.marketLiquidityAsset = document.getElementById('market-liquidity-asset');

        }

        // =====================================================================
        // --- MOCK AUTHENTICATION ---
        // =====================================================================

        /**
         * Checks if an email is entered before showing the OTP screen.
         */
        function validateAndShowOtp() {
            const email = document.getElementById('mock-email-input').value;

            if (!email || email.trim() === '' || !email.includes('@')) {
                showToast("Please enter a valid email address.", "warning");
            } else {
                showScreen('otp-screen');
            }
        }
        // ---- END OF NEW FUNCTION --


        /**
         * Logs in as a demo user. Cleans up old listeners, sets localStorage,
         * and initializes the user's profile in Firebase.
         */
        window.mockLogin = (userId, displayName) => {
            cleanupFirestoreListeners(); 

            console.log(`Mock login as: ${displayName}`);
            localStorage.setItem('demoUserId', userId);
            localStorage.setItem('demoDisplayName', displayName);
            currentUserId = userId;
            userProfile.displayName = displayName;

            showLoadingOverlay(true, `Logging in as ${displayName}...`);

            const { signInAnonymously } = window.firebase.auth;

            signInAnonymously(auth)
                .then((userCredential) => {
                    console.log("Firebase Auth UID (Anonymous):", userCredential.user.uid);
                    // initializeUserProfile will now handle all navigation
                    return initializeUserProfile(); 
                })
                .catch(err => {
                    console.error("Firebase auth for demo failed:", err);
                    showLoadingOverlay(false);
                    alert(`Error: ${err.message}`); 
                });
        }

        /**
         * Handles the mock OTP login flow.
         */
        window.mockOtpLogin = () => {
            const otp = document.getElementById('mock-otp-input').value;
            if (otp === '123456') {
                const email = document.getElementById('mock-email-input').value || 'demo-user@predora.io';
                const userId = email.split('@')[0];
                const displayName = `@${userId}`;
                mockLogin(userId, displayName);
            } else {
                showToast("Invalid OTP. Hint: 123456", "error");
            }
        }
        /**
         * Logs the current demo user out.
         */
        window.logout = () => {
            console.log("Logging out...");
            localStorage.removeItem('demoUserId');
            localStorage.removeItem('demoDisplayName');
            localStorage.removeItem('pledgePool');
            cleanupFirestoreListeners();
            currentUserId = null;
            userProfile = { 
                xp: 0, displayName: '', walletAddress: '', isApproved: false, 
                balance: 100, bnbBalance: 0.2, cakeBalance: 150 
            };
            pledgePoolItems = [];
            showScreen('login-screen');
        }
        // ---- END OF NEW FUNCTION ----



        /**
         * Loads or creates a user's profile in Firestore.
         * This is ASYNC and returns a promise.
         */
        async function initializeUserProfile() {
            const { doc, getDoc, setDoc, onSnapshot } = window.firebase.firestore;

            const profileRef = doc(db, 'artifacts', APP_ID, 'public', 'data', USER_PROFILE_COLLECTION, currentUserId);

            try {
                const docSnap = await getDoc(profileRef);
                const defaultProfile = {
                    userId: currentUserId,
                    displayName: userProfile.displayName, 
                    walletAddress: "0x" + [...Array(40)].map(() => Math.floor(Math.random() * 16).toString(16)).join(''), 
                    xp: 0,
                    balance: 100, 
                    bnbBalance: 0.2,
                    cakeBalance: 150,
                    createdAt: new Date().toISOString(),
                    streak: 0,
                    avatarUrl: LOGO_URL // Default to  app's logo
                };

                let needsPublicUpdate = false;

                if (!docSnap.exists()) {
                    // --- 1. NEW USER PATH ---
                    console.log("Creating new demo profile...");
                    await setDoc(profileRef, defaultProfile);
                    userProfile = defaultProfile;
                    needsPublicUpdate = true;

                    // Update the UI (so they see their name)
                    updateProfileUI(userProfile); 

                    // Hide  "Logging in..." spinner
                    showLoadingOverlay(false); 

                    // Show the avatar picker
                    showAvatarModal();

                } else {
                    // --- 2. EXISTING USER PATH ---
                    console.log("Demo profile loaded from Firebase.");
                    userProfile = { ...defaultProfile, ...docSnap.data() }; 

                    // Ensure public profile exists
                    const publicProfileRef = doc(db, 'artifacts', APP_ID, 'public', 'data', PUBLIC_LEADERBOARD_COLLECTION, currentUserId);
                    const publicSnap = await getDoc(publicProfileRef);
                    if (!publicSnap.exists()) {
                        needsPublicUpdate = true;
                    }

                    // Update UI
                    updateProfileUI(userProfile);

                    // Attach all data listeners
                    attachDataListeners();
                    
                    // Setup notification listener
                    setupNotificationListener();

                    // Go to the app
                    showScreen('home-screen');
                    showLoadingOverlay(false);
                    dom.topNav.classList.remove('hidden');
                    dom.bottomNav.classList.remove('hidden');
                }

                // Sync with the public leaderboard collection (for both paths)
                if (needsPublicUpdate) {
                    const publicProfileRef = doc(db, 'artifacts', APP_ID, 'public', 'data', PUBLIC_LEADERBOARD_COLLECTION, currentUserId);
                    await setDoc(publicProfileRef, {
                        userId: userProfile.userId,
                        displayName: userProfile.displayName,
                        walletAddress: userProfile.walletAddress, 
                        avatarUrl: userProfile.avatarUrl, // <-- Add avatar to leaderboard
                        xp: userProfile.xp
                    }, { merge: true });
                    console.log("Created/Synced public leaderboard profile.");
                }

                // Attach a live listener to the user's profile
                if (userProfileUnsubscribe) userProfileUnsubscribe();
                userProfileUnsubscribe = onSnapshot(profileRef, (doc) => {
                    if (doc.exists()) {
                        userProfile = doc.data();
                        console.log("Profile updated in real-time:", userProfile);
                        updateProfileUI(userProfile);
                    }
                });

            } catch (error) {
                console.error("Error initializing user profile:", error);
                throw error;
            }
        }

        // =====================================================================
        // --- UI / NAVIGATION ---
        // =====================================================================

        /* === NOTIFICATION SYSTEM === */
        
        let currentNotificationFilter = 'all';
        
        /**
         * Toggle notification panel visibility (navigate to profile)
         */
        window.toggleNotifications = () => {
            showScreen('profile-screen');
            handleProfileTab('notifications');
        };
        
        /**
         * Filter notifications by type
         */
        window.filterNotifications = (filter) => {
            currentNotificationFilter = filter;
            
            // Update active tab
            document.querySelectorAll('.notif-tab').forEach(tab => {
                if (tab.dataset.filter === filter) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Re-render notifications with filter
            loadNotifications();
        };
        
        /**
         * Mark all notifications as read
         */
        window.markAllNotificationsRead = async () => {
            if (!auth.currentUser) return;
            
            const { collection, query, where, getDocs, updateDoc, doc } = window.firebase.firestore;
            
            try {
                const notificationsRef = collection(db, 'users', auth.currentUser.uid, 'notifications');
                const unreadQuery = query(notificationsRef, where('read', '==', false));
                const snapshot = await getDocs(unreadQuery);
                
                const updatePromises = snapshot.docs.map(docSnap => 
                    updateDoc(doc(db, 'users', auth.currentUser.uid, 'notifications', docSnap.id), { read: true })
                );
                
                await Promise.all(updatePromises);
                
                // Update UI
                updateNotificationBadge(0);
                loadNotifications();
                showToast('All notifications marked as read', "success");
            } catch (error) {
                console.error('Error marking notifications as read:', error);
            }
        };
        
        /**
         * Show notification preferences modal
         */
        window.showNotificationPreferences = () => {
            // TODO: Implement preferences modal
            showToast('Notification preferences coming soon!');
        };
        
        /**
         * Load notifications from Firestore
         */
        async function loadNotifications() {
            if (!auth.currentUser) return;
            
            const { collection, query, orderBy, limit, getDocs, where } = window.firebase.firestore;
            
            try {
                let notificationsRef = collection(db, 'users', auth.currentUser.uid, 'notifications');
                let q = query(notificationsRef, orderBy('timestamp', 'desc'), limit(50));
                
                // Apply filter
                if (currentNotificationFilter === 'markets') {
                    q = query(notificationsRef, where('type', 'in', ['market_resolved', 'market_disputed']), orderBy('timestamp', 'desc'), limit(50));
                } else if (currentNotificationFilter === 'social') {
                    q = query(notificationsRef, where('type', 'in', ['new_follower', 'comment_reply']), orderBy('timestamp', 'desc'), limit(50));
                }
                
                const snapshot = await getDocs(q);
                
                const feed = document.getElementById('notifications-feed-profile');
                if (!feed) return;
                
                feed.innerHTML = '';
                
                if (snapshot.empty) {
                    feed.innerHTML = '<p class="text-gray-400 text-center py-8 text-sm">No notifications yet</p>';
                    return;
                }
                
                snapshot.docs.forEach(docSnap => {
                    const notification = { id: docSnap.id, ...docSnap.data() };
                    feed.appendChild(renderNotificationItem(notification));
                });
                
                // Update badge with unread count
                const unreadCount = snapshot.docs.filter(d => !d.data().read).length;
                updateNotificationBadge(unreadCount);
                
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }
        
        /**
         * Render a single notification item
         */
        function renderNotificationItem(notification) {
            const div = document.createElement('div');
            div.className = `p-4 hover:bg-gray-800/30 dark:hover:bg-gray-800/30 light:hover:bg-gray-50 transition-colors cursor-pointer ${!notification.read ? 'bg-sky-900/10' : ''}`;
            
            // Safe icon/title/message defaults
            let icon = '<svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>';
            let title = 'Notification';
            let message = notification.message || 'You have a new notification';
            let actionText = 'View';
            
            switch (notification.type) {
                case 'market_resolved':
                    icon = '<svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
                    title = 'Market Resolved';
                    message = notification.message || 'A market you staked in has been resolved';
                    actionText = 'View Results';
                    break;
                case 'market_disputed':
                    icon = '<svg class="w-5 h-5 text-rose-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>';
                    title = 'Market Disputed';
                    message = notification.message || 'A market resolution has been disputed';
                    actionText = 'Vote as Jury';
                    break;
                case 'new_follower':
                    icon = '<svg class="w-5 h-5 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>';
                    title = 'New Follower';
                    message = notification.message || 'Someone started following you';
                    actionText = 'View Profile';
                    break;
                case 'comment_reply':
                    icon = '<svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>';
                    title = 'New Reply';
                    message = notification.message || 'Someone replied to your comment';
                    actionText = 'View Reply';
                    break;
            }
            
            const timeAgo = getTimeAgo(notification.timestamp?.toDate?.() || new Date());
            
            div.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0 mt-1">
                        ${icon}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between">
                            <p class="text-sm font-semibold text-gray-200 dark:text-gray-200 light:text-gray-900">${title}</p>
                            <span class="text-xs text-gray-500">${timeAgo}</span>
                        </div>
                        <p class="text-sm text-gray-400 dark:text-gray-400 light:text-gray-600 mt-1">${message}</p>
                        ${notification.actionUrl ? `<button onclick="handleNotificationAction('${notification.actionUrl}')" class="text-xs text-sky-400 hover:text-sky-300 font-medium mt-2">${actionText}</button>` : ''}
                    </div>
                    ${!notification.read ? '<div class="flex-shrink-0"><div class="w-2 h-2 bg-sky-400 rounded-full"></div></div>' : ''}
                </div>
            `;
            
            // Mark as read when clicked
            div.onclick = async () => {
                if (!notification.read && auth.currentUser) {
                    const { doc, updateDoc } = window.firebase.firestore;
                    try {
                        await updateDoc(doc(db, 'users', auth.currentUser.uid, 'notifications', notification.id), { read: true });
                        loadNotifications();
                    } catch (error) {
                        console.error('Error marking notification as read:', error);
                    }
                }
                if (notification.actionUrl) {
                    handleNotificationAction(notification.actionUrl);
                }
            };
            
            return div;
        }
        
        /**
         * Handle notification action (navigation)
         */
        window.handleNotificationAction = (actionUrl) => {
            if (!actionUrl) return;
            
            // Parse actionUrl and navigate accordingly
            // Format: screen:market-detail:marketId or screen:profile:userId
            const parts = actionUrl.split(':');
            if (parts.length >= 2 && parts[0] === 'screen') {
                showScreen(parts[1] + '-screen');
                // Additional logic for screen parameters can go here
            }
        };
        
        /**
         * Update notification badge count
         */
        function updateNotificationBadge(count) {
            const badge = document.getElementById('notification-badge');
            const badgeProfile = document.getElementById('notification-badge-profile');
            
            if (count > 0) {
                const displayCount = count > 99 ? '99+' : count;
                if (badge) {
                    badge.textContent = displayCount;
                    badge.classList.remove('hidden');
                }
                if (badgeProfile) {
                    badgeProfile.textContent = displayCount;
                    badgeProfile.classList.remove('hidden');
                }
            } else {
                if (badge) badge.classList.add('hidden');
                if (badgeProfile) badgeProfile.classList.add('hidden');
            }
        }
        
        /**
         * Listen for new notifications in realtime
         */
        function setupNotificationListener() {
            if (!auth.currentUser) return;
            
            const { collection, query, onSnapshot, orderBy } = window.firebase.firestore;
            
            const notificationsRef = collection(db, 'users', auth.currentUser.uid, 'notifications');
            const allQuery = query(notificationsRef, orderBy('timestamp', 'desc'));
            
            onSnapshot(allQuery, (snapshot) => {
                // Count unread notifications
                const unreadCount = snapshot.docs.filter(d => !d.data().read).length;
                updateNotificationBadge(unreadCount);
                
                // Refresh feed if notifications tab is open
                const notificationsContent = document.getElementById('notifications-content');
                if (notificationsContent && !notificationsContent.classList.contains('hidden')) {
                    loadNotifications();
                }
                
                // Play sound or show toast for new notifications (optional)
                if (!snapshot.metadata.fromCache && snapshot.docChanges().some(change => change.type === 'added')) {
                    console.log('New notification received');
                }
            });
        }
        
        /* === END NOTIFICATION SYSTEM === */

        /**
         * Main navigation function. Hides all screens and shows the one with the matching ID.
         */
        window.showScreen = (screenId) => {
            if (!screenId) return;
            console.log(`Navigating to: ${screenId}`);

            // Special case: Hide nav bars on full-screen game modes and auth screens
            if (dom.topNav && dom.bottomNav) {
                // List of screens that should NOT have nav bars
                const noNavScreens = [
                    'quick-play-screen', 
                    'admin-password-screen',
                    'login-screen',
                    'otp-screen'
                ];

                const shouldHideNavs = noNavScreens.includes(screenId);

                dom.topNav.classList.toggle('hidden', shouldHideNavs);
                dom.bottomNav.classList.toggle('hidden', shouldHideNavs);
            }


            // Loop over all screens and toggle their visibility
            dom.screens.forEach(screen => {
                screen.classList.toggle('screen-active', screen.id === screenId);
                screen.classList.toggle('screen-inactive', screen.id !== screenId);
            });

            currentScreenId = screenId;
            window.scrollTo(0, 0); // Scroll to top on new screen

            // --- RACE CONDITION FIX ---
            // Clean up the single-market listener when we leave the detail screen
            if (screenId !== 'market-detail-screen' && detailMarketUnsubscribe) {
                console.log("Cleaning up detail market listener.");
                detailMarketUnsubscribe();
                detailMarketUnsubscribe = null;
            }
            // --- END FIX ---

            // Load data for the new screen
            if (currentUserId) {
                loadDataForScreen(screenId);
            }
            updateNavStyles();
        }

        /**
         * Alias for returning to the home screen.
         */
        window.goBack = () => showScreen('home-screen');

        /**
         * Updates the bottom nav bar icon colors to reflect the active screen.
         */
        function updateNavStyles() {
            if (!dom.navButtons) return;
            dom.navButtons.forEach(button => {
                // Get the screen ID from the button's onclick attribute
                const onclick = button.getAttribute('onclick');
                if (!onclick || !onclick.includes('showScreen')) return; // Skip non-navigation buttons
                
                const match = onclick.match(/'([^']+)'/);
                if (!match) return; // Skip if no match
                
                const buttonScreen = match[1];
                button.classList.toggle('text-sky-400', buttonScreen === currentScreenId);
                button.classList.toggle('text-gray-400', buttonScreen !== currentScreenId);
            });
            // The "Create" button is special, it should always be gray unless active
            const createBtn = document.querySelector('button[onclick*="create-market-screen"]');
            if(createBtn && currentScreenId !== 'create-market-screen') {
                createBtn.classList.remove('text-sky-400');
                createBtn.classList.add('text-gray-400'); 
            }

            // 2. Update Top Navigation Buttons
            if (dom.topNavButtons) {
                dom.topNavButtons.forEach(button => {
                    const buttonScreen = button.dataset.screen;
                    button.classList.toggle('active', buttonScreen === currentScreenId);
                });
            }
        }

        /**
         * A router that loads or attaches listeners based on the screen being viewed.
         */
        function loadDataForScreen(screenId) {
            switch(screenId) {
                case 'home-screen':
                    if (!standardMarketsUnsubscribe) attachStandardMarketsListener();
                    break;
                case 'quick-play-screen':
                    // Re-attach listener every time to refresh the "already staked" list
                    attachQuickPlayListener();
                    break;
                case 'leaderboard-screen':
                    if (!leaderboardUnsubscribe) renderLeaderboard();
                    break;
                case 'profile-screen':
                    handleProfileTab(document.querySelector('.profile-tab.active')?.id.split('-')[1] || 'active');
                    if (!historyStakesUnsubscribe) renderHistoryStakes();
                    break;
                case 'pledge-pool-screen': 
                    renderPledgePool();
                    break;
                case 'admin-panel-screen':
                    renderResolutionPanel();
                    renderQuickPlayResolutionPanel();
                    break;
                    case 'create-market-screen':
                    populateAssetSelector();
                    break;
            }
        }

        /**
         * Shows a beautiful toast notification
         * @param {string} message - The message to display
         * @param {string} type - Type of toast: 'success', 'error', 'info', 'warning'
         * @param {number} duration - How long to show the toast in ms
         */
        function showToast(message, type = 'info', duration = 3500) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            // Create toast element
            const toast = document.createElement('div');
            toast.className = 'toast-item transform transition-all duration-300 ease-out';
            
            // Icon and colors based on type
            const config = {
                success: {
                    icon: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>',
                    bgClass: 'bg-gradient-to-r from-emerald-500/20 to-green-500/20 dark:from-emerald-500/20 dark:to-green-500/20 light:from-emerald-50 light:to-green-50',
                    borderClass: 'border-l-4 border-emerald-500',
                    iconColor: 'text-emerald-500',
                    textColor: 'text-emerald-100 dark:text-emerald-100 light:text-emerald-900'
                },
                error: {
                    icon: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>',
                    bgClass: 'bg-gradient-to-r from-rose-500/20 to-red-500/20 dark:from-rose-500/20 dark:to-red-500/20 light:from-rose-50 light:to-red-50',
                    borderClass: 'border-l-4 border-rose-500',
                    iconColor: 'text-rose-500',
                    textColor: 'text-rose-100 dark:text-rose-100 light:text-rose-900'
                },
                warning: {
                    icon: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>',
                    bgClass: 'bg-gradient-to-r from-amber-500/20 to-yellow-500/20 dark:from-amber-500/20 dark:to-yellow-500/20 light:from-amber-50 light:to-yellow-50',
                    borderClass: 'border-l-4 border-amber-500',
                    iconColor: 'text-amber-500',
                    textColor: 'text-amber-100 dark:text-amber-100 light:text-amber-900'
                },
                info: {
                    icon: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>',
                    bgClass: 'bg-gradient-to-r from-sky-500/20 to-blue-500/20 dark:from-sky-500/20 dark:to-blue-500/20 light:from-sky-50 light:to-blue-50',
                    borderClass: 'border-l-4 border-sky-500',
                    iconColor: 'text-sky-500',
                    textColor: 'text-sky-100 dark:text-sky-100 light:text-sky-900'
                }
            };

            const style = config[type] || config.info;

            toast.innerHTML = `
                <div class="flex items-start gap-3 p-4 rounded-lg shadow-2xl backdrop-blur-md ${style.bgClass} ${style.borderClass} border border-white/10 dark:border-white/10 light:border-gray-200 min-w-[280px] max-w-sm">
                    <div class="${style.iconColor} flex-shrink-0 mt-0.5">
                        ${style.icon}
                    </div>
                    <p class="${style.textColor} text-sm font-medium flex-1 leading-relaxed">${message}</p>
                    <button onclick="this.closest('.toast-item').remove()" class="text-gray-400 hover:text-white dark:hover:text-white light:hover:text-gray-900 flex-shrink-0 transition-colors">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                    </button>
                </div>
            `;

            // Add with slide-in animation
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            container.appendChild(toast);

            // Trigger animation
            requestAnimationFrame(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(0)';
            });

            // Auto-remove after duration
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        /**
         * Shows or hides the full-screen loading overlay.
         */
        function showLoadingOverlay(show, message = 'Loading...') {
            if (!dom.loadingMessage || !dom.loadingOverlay) return;
            if (show) {
                dom.loadingMessage.innerText = message;
                dom.loadingOverlay.classList.remove('hidden');
            } else {
                dom.loadingOverlay.classList.add('hidden');
            }
        }

        /**
         * Utility to shorten a wallet address          */
        function truncateAddress(address) {
            if (!address) return "No wallet";
            return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
        }

        /**
         * Starts the  "online users" counter.
         */
        function startMockAliveFeatures() {
            const userCountEl = document.getElementById('live-user-count-text');
            let userCount = 147;
            setInterval(() => {
                userCount += Math.floor(Math.random() * 3) - 1; 
                if (userCount < 140) userCount = 140;
                userCountEl.innerText = userCount;
            }, 3000); 
        }

        // =====================================================================
        // --- DATA LISTENERS (FIRESTORE) ---
        // =====================================================================

        /**
         * Cleans up all active Firestore listeners. Crucial for when a user logs out
         * or switches demo accounts.
         */
        function cleanupFirestoreListeners() {
            console.log("Cleaning up old listeners...");
            if (userProfileUnsubscribe) { userProfileUnsubscribe(); userProfileUnsubscribe = null; }
            if (standardMarketsUnsubscribe) { standardMarketsUnsubscribe(); standardMarketsUnsubscribe = null; }
            if (quickPlayUnsubscribe) { quickPlayUnsubscribe(); quickPlayUnsubscribe = null; }
            if (activeStakesUnsubscribe) { activeStakesUnsubscribe(); activeStakesUnsubscribe = null; }
            if (historyStakesUnsubscribe) { historyStakesUnsubscribe(); historyStakesUnsubscribe = null; }
            if (leaderboardUnsubscribe) { leaderboardUnsubscribe(); leaderboardUnsubscribe = null; }
            if (tickerUnsubscribe) { tickerUnsubscribe(); tickerUnsubscribe = null; }
            if (detailMarketUnsubscribe) { detailMarketUnsubscribe(); detailMarketUnsubscribe = null; } // --- RACE CONDITION FIX (NEW) ---

            // Clear local data
            userHistoryData = [];
            pledgePoolItems = [];
        }

        /**
         * Attaches the primary data listeners for the app.
         */
        function attachDataListeners() {
            cleanupFirestoreListeners(); 
            attachStandardMarketsListener();
            attachQuickPlayListener();
            attachFollowerListener();
        }

        /**
         * Attaches a real-time listener to the standard markets collection
         * and renders the home screen feed. [NEW VERSION]
         */
        function attachStandardMarketsListener() {
            const { collection, query, onSnapshot } = window.firebase.firestore;

            try {
                // Query for all standard markets
                const q = query(
                    collection(db, 'artifacts', APP_ID, 'public', 'data', STANDARD_MARKETS_COLLECTION),
                where('isResolved', '==', false)
                );

                standardMarketsUnsubscribe = onSnapshot(q, (snapshot) => {
                    let markets = [];
                    snapshot.forEach(doc => {
                        markets.push({ id: doc.id, ...doc.data() });
                    });

                    // Add the hardcoded mock market to the top
                    if (!markets.find(m => m.id === MOCK_ETH_MARKET.id)) {
                        markets.unshift(MOCK_ETH_MARKET);
                    }

                    // 1. Cache the full list for searching
                    allStandardMarkets = markets; 

                    // 2. Call the "Printer" function to render the full list
                    filterMarkets('All'); 

                }, (error) => {
                    console.error("Error fetching standard markets:", error);
                    dom.standardMarketsFeed.innerHTML = '<p class="text-red-400 text-center">Error loading markets.</p>';
                });
            } catch (error) {
                console.error("Critical error in attachStandardMarketsListener:", error);
                dom.standardMarketsFeed.innerHTML = '<p class="text-red-400 text-center">Failed to attach listener.</p>';
            }
        }

        /**
         * Attaches a listener for the Quick Play feed. This is more complex because
         * it must filter out markets the user has already pledged on.
         */
        async function attachQuickPlayListener() {
            const { collection, query, where, onSnapshot, getDocs } = window.firebase.firestore;

            // 1. Hardcoded list of default mock markets
            const allMockMarkets = [
                { id: 'mock-qp-1', title: 'Will BTC break $70k in the next 24h?', duration: '24h', yesPercent: 55, noPercent: 45, isMock: true, isResolved: false },
                { id: 'mock-qp-2', title: 'Will the next tweet from @elonmusk mention DOGE?', duration: '4h', yesPercent: 30, noPercent: 70, isMock: true, isResolved: false },
                { id: 'mock-qp-3', title: 'Will the Lakers win their next game?', duration: '8h', yesPercent: 60, noPercent: 40, isMock: true, isResolved: false },
                { id: 'mock-qp-4', title: 'Will it rain in New York tomorrow?', duration: '12h', yesPercent: 20, noPercent: 80, isMock: true, isResolved: false },
            ];

            try {
                // 2. Get a list of ALL pledges (resolved or not) by the current user
                const activePledgesQuery = query(
                    collection(db, 'artifacts', APP_ID, 'public', 'data', PLEDGES_COLLECTION),
                    where('userId', '==', currentUserId),
                    where('isQuickPlay', '==', true)
                );
                const activePledgeSnapshot = await getDocs(activePledgesQuery);
                // This Set stores the IDs of markets the user has already successfully staked on
                const stakedMarketIds = new Set(activePledgeSnapshot.docs.map(doc => doc.data().marketId));

                const localPledgeIds = new Set(pledgePoolItems.map(item => item.id));

                // 3. Filter the Mock Markets
                const filteredMockMarkets = allMockMarkets.filter(market => !stakedMarketIds.has(market.id)&& !localPledgeIds.has(market.id));

                // 4. Listen for Active "Real" Markets from the admin panel
                const q = query(
                    collection(db, 'artifacts', APP_ID, 'public', 'data', QUICK_PLAY_MARKETS_COLLECTION),
                    where('isResolved', '==', false)
                );

                if (quickPlayUnsubscribe) quickPlayUnsubscribe(); 
                quickPlayUnsubscribe = onSnapshot(q, (snapshot) => {
                    let realMarkets = [];
                    snapshot.forEach(doc => {
                        // Only include REAL markets that are NOT RESOLVED AND NOT STAKED
                        if (!stakedMarketIds.has(doc.id)&& !localPledgeIds.has(doc.id))  {
                            realMarkets.push({ id: doc.id, ...doc.data(), isMock: false }); 
                        }
                    });

                    // 5. Combine the Active Real Markets and the FILTERED Mock Markets
                    window.quickPlayData = [...realMarkets, ...filteredMockMarkets];
                    // Sort by creation date (newest first)
                    window.quickPlayData.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                    // 6. Load the first card
                    loadQuickPlay(0);

                }, (error) => console.error("Error fetching active quick plays:", error));

            } catch (error) {
                console.error("Critical error in attachQuickPlayListener:", error);
            }
        }

        /**
         * Attaches a real-time listener to the user's followers list.
         */
        function attachFollowerListener() {
            const { collection, query, onSnapshot, where, serverTimestamp } = window.firebase.firestore;

            const q = query(
                collection(db, 'artifacts', APP_ID, 'public', 'data', USER_PROFILE_COLLECTION, currentUserId, 'followers')
            );

            let isFirstLoad = true;

            onSnapshot(q, (snapshot) => {
                // Skip all initial documents on first load
                if (isFirstLoad) {
                    isFirstLoad = false;
                    return;
                }
                
                snapshot.docChanges().forEach(change => {
                    // Only check for new documents added after first load
                    if (change.type === 'added') {
                        const follower = change.doc.data();
                        console.log("New follower detected:", follower.displayName);
                        showToast(`${follower.displayName} just followed you!`, "info");
                    }
                });
            });
        }

        // =====================================================================
        // --- PROFILE UI & DATA ---
        // =====================================================================

        /**
         * Updates all the elements on the profile screen with the user's data.
         */
            function updateProfileUI(profile) {
                if (!profile) return;

                // --- AVATAR LOGIC (Profile Screen) ---
                const profileAvatarContainer = document.querySelector('#profile-screen .ui-panel > div');
                // Use the avatarUrl from their profile, or fall back to  logo
                const avatarUrl = profile.avatarUrl || LOGO_URL; 

                if (profileAvatarContainer) {

                    profileAvatarContainer.innerHTML = `
                        <img src="${avatarUrl}" class="w-20 h-20 rounded-full" alt="Profile Avatar">
                    `;
                    // Clean up old styles
                    profileAvatarContainer.classList.remove('bg-gradient-to-br', 'from-indigo-600', 'to-blue-600');
                }
                
                // Update follower count
                updateFollowerCount(currentUserId);

                // --- AVATAR LOGIC (Top Nav Button) ---
                const navProfileButton = document.getElementById('nav-profile-button');
                if (navProfileButton) {

                    navProfileButton.innerHTML = `
                        <img src="${avatarUrl}" class="w-full h-full rounded-full" alt="Profile">
                    `;
                    // Add padding to the button itself to make the image fit
                    navProfileButton.classList.add('p-1');
                }

                // --- Original Profile Logic ---
                dom.profileDisplayName.innerText = profile.displayName || '...';
                dom.profileWalletAddress.innerText = truncateAddress(profile.walletAddress) || "No wallet connected";
                dom.profileXpBadge.innerText = `${profile.xp.toLocaleString()} XP`;
                dom.mockBalance.innerText = `$${profile.balance.toFixed(2)}`;
                dom.profileRankBadge.innerText = `Rank: #${profile.xp > 1000 ? '1' : '12'}`; 
                dom.profileAccuracyBadge.innerText = `${profile.xp > 0 ? '82' : '0'}% Accuracy`; 

                if (dom.userStreakText) {
                    dom.userStreakText.innerText = ` ${profile.streak || 0} Wins`;
                }
            }

        /**
         * Handles the tab switching on the profile screen (Active, History, Assets).
         */
        window.handleProfileTab = (tabName) => {
            // Update tab styles
            document.querySelectorAll('.profile-tab').forEach(btn => btn.classList.remove('active'));
            const activeTab = document.getElementById(`tab-${tabName}`);
            if (activeTab) activeTab.classList.add('active');

            // Hide all content panels
            if(dom.activeStakesContent) dom.activeStakesContent.classList.add('hidden');
            if(dom.historyContent) dom.historyContent.classList.add('hidden');
            if(dom.assetsContent) dom.assetsContent.classList.add('hidden'); 
            if(dom.aiProfileSummaryPanel) dom.aiProfileSummaryPanel.classList.add('hidden');

            if(dom.logoutButtonContainer) dom.logoutButtonContainer.classList.add('hidden');

            // Hide the new networking panel
            const networkingContent = document.getElementById('networking-content');
            if(networkingContent) networkingContent.classList.add('hidden');
            
            // Hide notifications panel
            const notificationsContent = document.getElementById('notifications-content');
            if(notificationsContent) notificationsContent.classList.add('hidden');
            // --- END NEW ---

            // Show the correct content panel
            const contentEl = document.getElementById(`${tabName}-content`) || document.getElementById(`${tabName}-stakes-content`);
            if (contentEl) contentEl.classList.remove('hidden');

            // Load data for the selected tab
        // ...
            if (tabName === 'active') renderActiveStakes();
            if (tabName === 'notifications') loadNotifications();
            else if (tabName === 'history') renderHistoryStakes();
                else if (tabName === 'networking') {
                    // Show the networking panel and load its default sub-tab
                    if(networkingContent) networkingContent.classList.remove('hidden');
                    handleNetworkingTab('followers'); // We will add this function next
                }
            else if (tabName === 'assets') { 
                renderAssetsContent(); 

              if(dom.logoutButtonContainer) dom.logoutButtonContainer.classList.remove('hidden');
            } 
        }


        /**
         * Renders the "Assets" tab on the profile screen, including the mock faucet.
         */
        function renderAssetsContent() {
            const assetsEl = document.getElementById('assets-content');
            const balance = userProfile.balance || 0;
            const bnbBalance = userProfile.bnbBalance || 0;
            const cakeBalance = userProfile.cakeBalance || 0;

            assetsEl.innerHTML = `
                <div class="ui-panel p-4">
                    <h3 class="text-base font-semibold gradient-text mb-4">Mock Wallet Assets (BNB Testnet)</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <img src="https://s2.coinmarketcap.com/static/img/coins/64x64/4687.png" class="w-10 h-10 rounded-full mr-3" alt="BUSD">
                                <div>
                                    <p class="font-semibold text-white">BUSD (Mock)</p>
                                    <p class="text-sm text-gray-400">Binance-Peg BUSD</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold text-white">$${balance.toFixed(2)}</p>
                                <p class="text-sm text-gray-400">${balance.toFixed(2)} BUSD</p>
                            </div>
                        </div>

                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <img src="https://s2.coinmarketcap.com/static/img/coins/64x64/1839.png" class="w-10 h-10 rounded-full mr-3" alt="BNB">
                                <div>
                                    <p class="font-semibold text-white">BNB (Mock)</p>
                                    <p class="text-sm text-gray-400">BNB</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold text-white">$${(bnbBalance * getMockPrice('BNB')).toFixed(2)}</p>
                                <p class="text-sm text-gray-400">${bnbBalance.toFixed(4)} BNB</p>
                            </div>
                        </div>

                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <img src="https://s2.coinmarketcap.com/static/img/coins/64x64/7186.png" class="w-10 h-10 rounded-full mr-3" alt="CAKE">
                                <div>
                                    <p class="font-semibold text-white">PancakeSwap (Mock)</p>
                                    <p class="text-sm text-gray-400">CAKE</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold text-white">$${(cakeBalance * getMockPrice('CAKE')).toFixed(2)}</p>
                                <p class="text-sm text-gray-400">${cakeBalance.toFixed(2)} CAKE</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="ui-panel p-4 space-y-3">
                    <h3 class="text-base font-semibold text-white">Mock Faucet</h3>
                    <p class="text-sm text-gray-400">Need more test tokens?</p>
                    <div class="grid grid-cols-3 gap-2">
                        <button id="faucet-busd" class="btn btn-secondary text-sm">Get 100 BUSD</button>
                        <button id="faucet-bnb" class="btn btn-secondary text-sm">Get 0.1 BNB</button>
                        <button id="faucet-cake" class="btn btn-secondary text-sm">Get 50 CAKE</button>
                    </div>
                </div>
            `;

            // Add listeners for the new faucet buttons
            document.getElementById('faucet-busd').addEventListener('click', () => claimTokens('BUSD'));
            document.getElementById('faucet-bnb').addEventListener('click', () => claimTokens('BNB'));
            document.getElementById('faucet-cake').addEventListener('click', () => claimTokens('CAKE'));

            // Re-populate all asset selectors in the app
            populateAssetSelector();
        }

        /**
         * Mock faucet function to add tokens to the user's profile.
         */
        async function claimTokens(asset) {
            const { doc, updateDoc, increment } = window.firebase.firestore;

            let amount = 0;
            let field = "";

            if (asset === 'BUSD') { amount = 100; field = 'balance'; }
            else if (asset === 'BNB') { amount = 0.1; field = 'bnbBalance'; }
            else if (asset === 'CAKE') { amount = 50; field = 'cakeBalance'; }

            if (!field) return;

            showLoadingOverlay(true, `Claiming ${amount} ${asset}...`);

            try {
                const profileRef = doc(db, 'artifacts', APP_ID, 'public', 'data', USER_PROFILE_COLLECTION, currentUserId);
                await updateDoc(profileRef, {
                    [field]: increment(amount) 
                });


                userProfile[field] = (userProfile[field] || 0) + amount;


                renderAssetsContent();
                updateProfileUI(userProfile);

                showLoadingOverlay(false);
                showToast(`${amount} ${asset} received from faucet!`, "success");


            } catch (error) {
                console.error("Faucet claim failed:", error);
                showLoadingOverlay(false);
                showToast("Faucet claim failed. Check console.", "error");
            }
        }

        /**
         * Renders the list of active stakes on the profile screen.
         */
        function renderActiveStakes() {
            const { collection, query, where, onSnapshot } = window.firebase.firestore;

            const q = query(
                collection(db, 'artifacts', APP_ID, 'public', 'data', PLEDGES_COLLECTION),
                where('isResolved', '==', false),
                where('userId', '==', currentUserId) // Filter by the current user
            );

            if (activeStakesUnsubscribe) activeStakesUnsubscribe();
            activeStakesUnsubscribe = onSnapshot(q, (snapshot) => {
                let html = '';
                let totalPrincipal = 0;

                if (snapshot.empty) {
                    dom.activeStakesContent.innerHTML = '<div class="ui-panel text-center"><p class="text-gray-400">You have no active stakes.</p></div>';
                    updateStakingSummary(0);
                    return;
                }

                snapshot.forEach(doc => {
                    const pledge = doc.data();
                    totalPrincipal += pledge.amountUsd; 
                    const pickClass = pledge.pick === 'YES' ? 'text-green-400' : 'text-red-400';

                    // Display the mock transaction hash
                    const txHashHtml = pledge.txHash 
                        ? `<div class="text-xs text-gray-500 mt-2">
                            TX: <span class="text-sky-400 cursor-pointer" onclick="showTxToast('${pledge.txHash}')">${truncateAddress(pledge.txHash)}</span>
                          </div>`
                        : '';

                    html += `
                        <div class="ui-panel p-4 mb-3">
                            <p class="text-gray-900 dark:text-white font-semibold">${pledge.marketTitle}</p>
                            <div class="flex justify-between items-center text-sm mt-2">
                                <span class="text-gray-600 dark:text-gray-400">Your Pick: <span class="${pickClass} font-bold">${pledge.pick}</span></span>
                                <span class="text-gray-600 dark:text-gray-400">Stake: <span class="text-gray-900 dark:text-white font-bold">${pledge.amount.toFixed(4)} ${pledge.asset} ($${pledge.amountUsd.toFixed(2)})</span></span>
                            </div>
                            <div class="text-xs text-gray-500 dark:text-gray-500 mt-1">
                                Potential Return: <span class="text-green-500 dark:text-green-400">$${pledge.potentialReturn.toFixed(2)}</span>
                            </div>
                            ${txHashHtml}
                        </div>
                    `;
                });
                dom.activeStakesContent.innerHTML = html;
                updateStakingSummary(totalPrincipal);
            });
        }

        /**
         * Renders the list of historical stakes on the profile screen.
         */
        function renderHistoryStakes() {
            const { collection, query, where, onSnapshot } = window.firebase.firestore;

            const q = query(
                collection(db, 'artifacts', APP_ID, 'public', 'data', PLEDGES_COLLECTION),
                where('isResolved', '==', true), // Get only resolved stakes
                where('userId', '==', currentUserId)
            );

            if (historyStakesUnsubscribe) historyStakesUnsubscribe();
            historyStakesUnsubscribe = onSnapshot(q, (snapshot) => {
                let html = '';
                userHistoryData = []; // Clear local cache for AI summary
                if (snapshot.empty) {
                    dom.historyContent.innerHTML = '<div class="ui-panel text-center"><p class="text-gray-400">No settled predictions yet.</p></div>';
                    return;
                }
                snapshot.forEach(doc => {
                    const pledge = doc.data();
                    userHistoryData.push(pledge); // Add to local cache
                    const isWinner = pledge.isWinner === true;
                    const result = isWinner ? 'WON' : 'LOST';
                    const resultClass = isWinner ? 'text-green-400' : 'text-red-400';
                    const payout = pledge.payout;
                    // Calculate P&L (Payout - Original Stake)
                    const pnl = isWinner ? (payout - pledge.amountUsd) : -pledge.amountUsd;
                    const payoutText = `${pnl >= 0 ? '+' : '-'}$${Math.abs(pnl).toFixed(2)}`;

                    const txHashHtml = pledge.txHash 
                        ? `<div class="text-xs text-gray-500 mt-2">
                            TX: <span class="text-sky-400 cursor-pointer" onclick="showTxToast('${pledge.txHash}')">${truncateAddress(pledge.txHash)}</span>
                          </div>`
                        : '';

                    html += `
                      <button onclick="showVerdictModal('${doc.id}')" class="ui-panel p-4 mb-3 w-full text-left ${isWinner ? 'border-l-4 border-green-400' : 'border-l-4 border-red-400'}">
                            <p class="text-gray-900 dark:text-white font-semibold">${pledge.marketTitle}</p>
                            <div class="flex justify-between items-center text-sm mt-2">
                                <span class="text-gray-600 dark:text-gray-400">Result: <span class="${resultClass} font-bold">${result}</span></span>
                                <span class="text-gray-600 dark:text-gray-400">Net P&L: <span class="${resultClass} font-bold">${payoutText}</span></span>
                            </div>
                            ${txHashHtml}
                        </button>
                    `;
                });
                dom.historyContent.innerHTML = html;
            });
        }

        /**
         * Updates the "Total Staked" summary panel.
         */
        function updateStakingSummary(principal) {
            const principalEl = document.querySelector('#profile-screen #total-principal');
            if(principalEl) principalEl.innerText = `$${principal.toFixed(2)}`;
        }

        // =====================================================================
        // --- LEADERBOARD ---
        // =====================================================================

        /**
         * Renders the leaderboard screen with ranked users.
         */
        function renderLeaderboard() {
            const { collection, query, onSnapshot } = window.firebase.firestore;
            dom.userRankPanel.innerHTML = '<p class="text-gray-400">Loading your rank...</p>';
            dom.rankingList.innerHTML = '<p class="text-gray-400 text-center pt-8">Fetching top players...</p>';

            // Query the public leaderboard collection
            const q = query(collection(db, 'artifacts', APP_ID, 'public', 'data', PUBLIC_LEADERBOARD_COLLECTION));

            if (leaderboardUnsubscribe) leaderboardUnsubscribe();
            leaderboardUnsubscribe = onSnapshot(q, (snapshot) => {
                let profiles = [];
                snapshot.forEach(doc => profiles.push(doc.data()));
                // Sort by XP, descending
                profiles.sort((a, b) => b.xp - a.xp);

                let userRank = -1;
                let rankHtml = '';
                const userProfileData = profiles.find(p => p.userId === currentUserId) || userProfile;

                profiles.forEach((profile, index) => {
                    const rank = index + 1;
                    const isCurrentUser = profile.userId === currentUserId;
                    if (isCurrentUser) userRank = rank;

                    let rankStyle = 'text-white font-medium';
                    let scoreStyle = 'text-white font-semibold';
                    let name = profile.displayName || truncateAddress(profile.walletAddress) || 'Anonymous';

                    // Special styles for top 3
                    if (rank === 1) { rankStyle = 'text-yellow-400 font-extrabold text-lg'; scoreStyle = 'text-yellow-400 font-extrabold'; }
                    else if (rank === 2) { rankStyle = 'text-gray-300 font-extrabold text-base'; scoreStyle = 'text-gray-300 font-extrabold'; }
                    else if (rank === 3) { rankStyle = 'text-amber-700 font-bold'; scoreStyle = 'text-amber-700 font-bold'; }

                    const rowClass = isCurrentUser ? 'bg-sky-500/10 border-l-4 border-sky-400' : 'border-b border-white/5';
                    rankHtml += `
                        <div class="flex justify-between items-center p-3 rounded-lg ${rowClass}">
                            <div class="flex items-center space-x-4">
                                <span class="w-8 text-center ${rankStyle}">#${rank}</span>
                                <img src="${profile.avatarUrl || LOGO_URL}" class="w-10 h-10 rounded-full" alt="Avatar">
                                ${isCurrentUser ? `
    <span class="gradient-text font-extrabold">${name}</span>
` : `
    <button onclick="viewUserProfile('${profile.userId}')" class="text-white hover:text-sky-400 font-semibold transition-colors">
        ${name}
    </button>
`}
                            </div>
                            <span class="${scoreStyle}">${profile.xp.toLocaleString()} XP</span>
                        </div>
                    `;
                });

                // Update the user's personal rank panel
                dom.userRankPanel.innerHTML = `
                    <p class="text-xs text-gray-400 mb-2">Your Current Rank (All-Time)</p>
                    <div class="text-5xl font-extrabold ${userRank === 1 ? 'gradient-text' : 'text-white'}">${userRank > 0 ? `#${userRank}` : 'N/A'}</div>
                    <p class="text-sm text-gray-300 mt-2">Score: ${userProfileData.xp.toLocaleString()} XP</p>
                `;
                // Update the full ranking list
                dom.rankingList.innerHTML = rankHtml;
            });
        }

        // =====================================================================
        // --- MARKET DETAIL & STAKING ---
        // =====================================================================

        /**
         * Updates the Market Detail UI with new data.
         */
        function updateMarketDetailUI(marketData) {
            if (!marketData) return;

            dom.detailTitle.innerText = marketData.title;
            dom.detailInsight.innerText = marketData.insight;
            dom.detailYesPercent.innerText = `${marketData.yesPercent}%`;
            dom.detailNoPercent.innerText = `${marketData.noPercent}%`;

            // Reset AI panel
            dom.aiExplainPanel.classList.add('hidden'); 
            dom.aiExplainPanel.innerHTML = ''; 

            // Toggle yield panel
            dom.detailYieldPanel.classList.toggle('hidden', !marketData.isNoLoss);
            if (marketData.isNoLoss && !yieldInterval) { // Only start if not already running
                startMockYieldCounter(dom.detailYieldCounter);
            }

            // --- THIS IS THE FIX FOR THE UI BUG ---
            // Check if market is resolved and disable UI
            if (marketData.isResolved) {
                document.getElementById('stake-yes-btn').disabled = true;
                document.getElementById('stake-no-btn').disabled = true;
                dom.stakeAmountInput.disabled = true;
                dom.stakeAmountInput.placeholder = "Market is closed";
            }
        }


            /**
             * Loads the detail screen for a specific market.
             * [CORRECTED VERSION FOR CHARTING]
             */
            window.viewMarketDetail = async (marketId) => {
                const { doc, getDoc, onSnapshot } = window.firebase.firestore;
                currentMarketId = marketId;

                try {
                    // --- THIS BLOCK IS NOW CORRECTED ---
                    if (marketId === MOCK_ETH_MARKET.id) {
                        currentMarket = MOCK_ETH_MARKET;
                        // Give the mock market a creation date for the chart
                        currentMarket.createdAt = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000); // 7 days ago
                    } else {
                        const marketRef = doc(db, 'artifacts', APP_ID, 'public', 'data', STANDARD_MARKETS_COLLECTION, marketId);
                        const docSnap = await getDoc(marketRef);
                        if (!docSnap.exists()) {
                            showToast("Error: Market not found.", "error");
                            return;
                        }

                        currentMarket = { id: docSnap.id, ...docSnap.data() };

                        // Convert Firestore timestamp to JS Date
                        if (currentMarket.createdAt && currentMarket.createdAt.toDate) {
                            currentMarket.createdAt = currentMarket.createdAt.toDate();
                        } else {
                            // Fallback if createdAt is missing (for older markets)
                            currentMarket.createdAt = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000); // 7 days ago
                        }
                    }
                    // --- END CORRECTION ---

                    // Populate the UI
                    dom.detailTitle.innerText = currentMarket.title;
                    dom.detailInsight.innerText = currentMarket.insight;
                    dom.detailYesPercent.innerText = `${currentMarket.yesPercent.toFixed(1)}%`; // Added rounding
                    dom.detailNoPercent.innerText = `${currentMarket.noPercent.toFixed(1)}%`; // Added rounding
                    dom.aiExplainPanel.classList.add('hidden'); 
                    dom.aiExplainPanel.innerHTML = ''; 
                    dom.detailYieldPanel.classList.toggle('hidden', !currentMarket.isNoLoss);
                    if (currentMarket.isNoLoss) {
                        startMockYieldCounter(dom.detailYieldCounter);
                    }

                    // Reset staking buttons
                    document.getElementById('stake-yes-btn').disabled = false;
                    document.getElementById('stake-no-btn').disabled = false;
                    dom.stakeAmountInput.disabled = false;
                    dom.stakeAmountInput.value = '';

                    populateAssetSelector();
                    showScreen('market-detail-screen');

                    // --- ADDED FOR CHART & TVL ---
                    // 1. Update the TVL Text
                    dom.marketTvlText.innerText = `$${(currentMarket.totalStakeVolume || 0).toFixed(2)}`;

                    // 2. Load and Draw the Chart
                    loadAndDrawChart(currentMarketId, currentMarket.createdAt);
                    // --- END CHART & TVL BLOCK ---

                    // --- RACE CONDITION FIX (STILL NEEDED) ---
                    if (marketId !== MOCK_ETH_MARKET.id) {
                        const marketRef = doc(db, 'artifacts', APP_ID, 'public', 'data', STANDARD_MARKETS_COLLECTION, marketId);

                        if(detailMarketUnsubscribe) detailMarketUnsubscribe();

                        // THIS IS THE NEW, UPGRADED LISTENER
                        detailMarketUnsubscribe = onSnapshot(marketRef, (docSnap) => {
                            if (!docSnap.exists()) {
                                showToast("Error: This market no longer exists.", "error");
                                goBack();
                                return;
                            }

                            // 1. Get the new data
                            const newData = docSnap.data();

                            // 2. Update the global currentMarket object
                            // We must convert the timestamp, just like we did when we first loaded it
                            let creationDate = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000); // Default
                            if (newData.createdAt && newData.createdAt.toDate) {
                                creationDate = newData.createdAt.toDate();
                            }
                            currentMarket = { id: docSnap.id, ...newData, createdAt: creationDate };

                            // 3. Update the UI elements IN REAL TIME
                            dom.detailYesPercent.innerText = `${currentMarket.yesPercent.toFixed(1)}%`;
                            dom.detailNoPercent.innerText = `${currentMarket.noPercent.toFixed(1)}%`;
                            dom.marketTvlText.innerText = `$${(currentMarket.totalStakeVolume || 0).toFixed(2)}`;

                            // 4. Reload and draw the chart
                            loadAndDrawChart(currentMarketId, currentMarket.createdAt);

                            // 5. Check if the market was resolved *while* we were watching
                            if (currentMarket.isResolved) {
                                console.log("Market resolved while user was viewing.");
                                showToast("This market has just been resolved! Staking is closed.", "warning");
                                document.getElementById('stake-yes-btn').disabled = true;
                                document.getElementById('stake-no-btn').disabled = true;
                                dom.stakeAmountInput.disabled = true;
                                dom.stakeAmountInput.placeholder = "Market is closed";
                            }
                        });
                    }
                    // --- END FIX ---

                } catch (error) {
                    console.error("Error fetching market detail:", error);
                    showToast("Error loading market details.", "error");
                }
            }

        /**
         * Populates the <select> dropdown with the user's current asset balances.
         */
        /**
         * Populates ALL <select> dropdowns with the user's current asset balances.
         */
        function populateAssetSelector() {
            const busdBal = userProfile.balance || 0;
            const bnbBal = userProfile.bnbBalance || 0;
            const cakeBal = userProfile.cakeBalance || 0;

            // Create the HTML for the options once
            const optionsHtml = `
                <option value="BUSD">BUSD (Balance: ${busdBal.toFixed(2)})</option>
                <option value="BNB">BNB (Balance: ${bnbBal.toFixed(4)})</option>
                <option value="CAKE">CAKE (Balance: ${cakeBal.toFixed(2)})</option>
            `;

            // 1. Populate the original Market Detail stake select
            if (dom.stakeAssetSelect) {
                dom.stakeAssetSelect.innerHTML = optionsHtml;
            }

            // 2. NEW: Populate the new Create Market liquidity select
            if (dom.marketLiquidityAsset) {
                dom.marketLiquidityAsset.innerHTML = optionsHtml;
            }
        }

        /**
         * Starts the fake "yield" counter for no-loss markets.
         */
        function startMockYieldCounter(element) {
            clearInterval(yieldInterval);
            let mockYield = 0.00;
            element.innerText = `$${mockYield.toFixed(2)}`;

            yieldInterval = setInterval(() => {
                mockYield += (Math.random() * 0.002); 
                element.innerText = `$${mockYield.toFixed(2)}`;
            }, 2000);
        }

        /**
         * Submits a stake for a standard market.
         */
        //

        async function stakeMarket(pick) {
            // 1. Get all Firebase functions
            const { doc, updateDoc, increment, addDoc, collection, serverTimestamp, runTransaction } = window.firebase.firestore;

            // 2. Get Form Values
            const amount = parseFloat(dom.stakeAmountInput.value);
            const selectedAsset = dom.stakeAssetSelect.value;

            // 3. --- VALIDATION ---
            if (!amount || amount <= 0) {
                showToast("Please enter a valid stake amount.", "warning");
                return;
            }
            if (!currentMarketId || !currentMarket) {
                showToast("Error: No market selected.", "error");
                return;
            }
            if (currentMarket.isResolved) {
                showToast("This market is closed and no longer accepting stakes.", "warning");
                return;
            }

            // 4. --- MOCK DELAY ---
            showLoadingOverlay(true, "Confirming on-chain...");
            await new Promise(res => setTimeout(res, 1500)); // Shortened delay

            // 5. --- MAIN LOGIC (NOW INSIDE A TRANSACTION) ---
            try {
                const balanceFieldToUpdate = getBalanceField(selectedAsset);
                const amountInUsd = amount * getMockPrice(selectedAsset);
                const xpToAward = getRandomXP(10);
                const txHash = generateFakeTxHash();

                // --- THIS IS THE FIX ---
                // We wrap all database reads and writes in a transaction
                await runTransaction(db, async (transaction) => {
                    const profileRef = doc(db, 'artifacts', APP_ID, 'public', 'data', USER_PROFILE_COLLECTION, currentUserId);
                    const publicProfileRef = doc(db, 'artifacts', APP_ID, 'public', 'data', PUBLIC_LEADERBOARD_COLLECTION, currentUserId);
                    const pledgeCollection = collection(db, 'artifacts', APP_ID, 'public', 'data', PLEDGES_COLLECTION);

                    // 1. TRANSACTION READ: Get user's profile to check balance
                    const profileSnap = await transaction.get(profileRef);
                    if (!profileSnap.exists()) {
                        throw new Error("User profile not found.");
                    }

                    // 2. BALANCE CHECK:
                    const currentAssetBalance = profileSnap.data()[balanceFieldToUpdate] || 0;
                    if (amount > currentAssetBalance) {
                        throw new Error(`Insufficient ${selectedAsset} balance. You only have ${currentAssetBalance.toFixed(4)}.`);
                    }

                    // 3. TRANSACTION READ: Get the market (unless it's the mock)
                    let market, marketRef, potentialPayoutUsd;

                    if (currentMarket.isMock) {
                        market = MOCK_ETH_MARKET;
                        const odds = pick === 'YES' ? market.yesPercent : market.noPercent;
                        potentialPayoutUsd = (amountInUsd / (odds / 100));
                    } else {
                        marketRef = doc(db, 'artifacts', APP_ID, 'public', 'data', STANDARD_MARKETS_COLLECTION, currentMarketId);
                        const marketSnap = await transaction.get(marketRef);
                        if (!marketSnap.exists()) { throw new Error("Market not found"); }
                        market = marketSnap.data();
                        if (market.isResolved) { throw new Error("Market is closed."); }

                        // 4. AMM MATH (Only for Traditional markets)
                        if (!market.isNoLoss) {
                            let yesPool = market.yesPool;
                            let noPool = market.noPool;
                            const k = yesPool * noPool;

                            if (pick === 'YES') {
                                const newYesPool = yesPool + amountInUsd;
                                const newNoPool = k / newYesPool;
                                potentialPayoutUsd = noPool - newNoPool; // Shares
                                yesPool = newYesPool;
                                noPool = newNoPool;
                            } else {
                                const newNoPool = noPool + amountInUsd;
                                const newYesPool = k / newNoPool;
                                potentialPayoutUsd = yesPool - newYesPool; // Shares
                                yesPool = newYesPool;
                                noPool = newNoPool;
                            }
                            const totalPool = yesPool + noPool;

                            // 5. TRANSACTION WRITE 1: Update the Market
                            transaction.update(marketRef, {
                                yesPool: yesPool,
                                noPool: noPool,
                                yesPercent: (yesPool / totalPool) * 100,
                                noPercent: (noPool / totalPool) * 100,
                                totalStakeVolume: increment(amountInUsd)
                            });
                        } else {
                            // Logic for No-Loss markets
                            const odds = pick === 'YES' ? market.yesPercent : market.noPercent;
                            potentialPayoutUsd = (amountInUsd / (odds / 100));
                            transaction.update(marketRef, { totalStakeVolume: increment(amountInUsd) });
                        }
                    }

                    // 6. TRANSACTION WRITE 2: Create the Pledge
                    const newPledgeRef = doc(pledgeCollection);
                    transaction.set(newPledgeRef, {
                        marketId: currentMarketId,
                        marketTitle: market.title,
                        userId: currentUserId,
                        pick: pick,
                        amount: amount,
                        asset: selectedAsset,
                        amountUsd: amountInUsd,
                        potentialReturn: potentialPayoutUsd,
                        txHash: txHash,
                        isResolved: false,
                        isWinner: null,
                        payout: 0,
                        createdAt: new Date().toISOString()
                    });

                    // 7. TRANSACTION WRITE 3: Log for the chart
                    if (!currentMarket.isMock) {
                        const logRef = doc(collection(db, 'artifacts', APP_ID, 'public', 'data', STAKE_LOGS_COLLECTION));
                        transaction.set(logRef, {
                            marketId: currentMarketId,
                            amountUsd: amountInUsd,
                            timestamp: serverTimestamp()
                        });
                    }

                    // 8. TRANSACTION WRITE 4 & 5: Update user's profile and leaderboard
                    transaction.update(profileRef, {
                        [balanceFieldToUpdate]: increment(-amount),
                        xp: increment(xpToAward)
                    });
                    transaction.update(publicProfileRef, { xp: increment(xpToAward) });
                });
                // --- END OF TRANSACTION ---

                showLoadingOverlay(false);
                showToast(`Stake Confirmed! +${xpToAward} XP`, "success");

            } catch (error) {
                console.error("Staking failed:", error);
                showLoadingOverlay(false);
                showToast(`Staking failed: ${error.message}`, "error"); // This will now show "Insufficient balance"
            }
        }

        // =====================================================================
        // --- QUICK PLAY & PLEDGE POOL ---
        // =====================================================================

        /**
         * Loads a Quick Play card onto the screen.
         */
        function loadQuickPlay(index) {
            let data = window.quickPlayData;
            const cardEl = dom.quickPlayCard;

            // --- HACKATHON FIX: Show "All Caught Up" message ---
            if (!data || data.length === 0) {
                cardEl.innerHTML = `
                    <div class="flex-grow flex flex-col justify-center items-center p-4 text-center">
                        <h2 class="text-2xl font-bold text-white mb-4">All Caught Up!</h2>
                        <p class="text-gray-300">
                            You've pledged on all available Quick Plays. 
                            <br><br>
                            Check back soon for more!
                        </p>
                    </div>
                `;
                // Hide the buttons
                document.querySelector('.quick-play-btn-no').classList.add('hidden');
                document.querySelector('.quick-play-btn-skip').classList.add('hidden');
                document.querySelector('.quick-play-btn-yes').classList.add('hidden');
                return;
            }
            // --- END FIX ---

            // Un-hide buttons in case they were hidden
            document.querySelector('.quick-play-btn-no').classList.remove('hidden');
            document.querySelector('.quick-play-btn-skip').classList.remove('hidden');
            document.querySelector('.quick-play-btn-yes').classList.remove('hidden');


            currentQuickPlayIndex = index % data.length;
            const market = data[currentQuickPlayIndex];

            // Store market data on the card's dataset for later
            cardEl.dataset.id = market.id;
            cardEl.dataset.title = market.title;
            cardEl.dataset.ismock = market.isMock || false; 

            // Render the card HTML
            cardEl.innerHTML = `
                <div class="flex-grow flex flex-col justify-center">
                    <div class="flex justify-between items-center w-full mb-4">
    <div class="w-8"></div> 

    <div class="badge badge-timer flex items-center space-x-1.5">
        <span class="w-1.5 h-1.5 bg-sky-400 rounded-full live-dot"></span>
        <span>${market.duration}</span>
    </div>

    <button onclick="viewQuickPlayDetails(event)" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-sky-400 transition-colors rounded-full">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
    </button>
</div>
                    <h2 class="text-2xl font-bold text-white text-center mb-6">${market.title}</h2>
                    <div class="flex justify-around mb-5">
                        <div class="text-center">
                            <div class="text-4xl font-bold text-green-400">${market.yesPercent.toFixed(1)}%</div>
                            <div class="text-sm text-gray-300">YES</div>
                        </div>
                        <div class="text-center">
                            <div class="text-4xl font-bold text-red-400">${market.noPercent.toFixed(1)}%</div>
                            <div class="text-sm text-gray-300">NO</div>
                        </div>
                    </div>
                </div>
                <div class="text-center text-gray-400 text-sm">
                    <p>Tap to make your pick</p>
                </div>
            `;
        }


        /**
         * Shows a mock insight/detail modal for a Quick Play card.
         */
        window.viewQuickPlayDetails = (event) => {
            // 1. CRITICAL FIX: Stop the swipe action
            event.stopPropagation(); 

            const card = document.getElementById('quick-play-card');
            const marketTitle = card.dataset.title || "No title found.";

            // 2. CRITICAL FIX: Define the mockInsight (which the modal needs)
            const mockInsight = "This market is seeing high volatility. The 'YES' side is favored by social media sentiment, but the 'NO' side has strong technical indicators.";

            // 3. Populate and show the modal
            dom.qpModalTitle.innerText = marketTitle;
            dom.qpModalInsight.innerText = mockInsight;
            dom.quickPlayDetailModal.classList.remove('hidden');
        }
        /**
         * Closes the new Quick Play detail modal.
         */
        window.closeQuickPlayDetails = () => {
            dom.quickPlayDetailModal.classList.add('hidden');
        }
        // ---- END OF NEW FUNCTION ----

        /**
         * Handles the (YES/NO/SKIP) swipe/button press on the Quick Play screen.
         */
        window.handleQuickPlay = (vote) => {
            if (isAnimating) return; // Prevent double-clicks
            isAnimating = true;

            let animationClass = '';
            if (vote === 'yes') animationClass = 'fly-out-right';
            else if (vote === 'no') animationClass = 'fly-out-left';
            else animationClass = 'fly-out-skip';

            dom.quickPlayCard.classList.add(animationClass);

            if (vote !== 'skip') {
                // Add the item to the pledge pool
                const marketId = dom.quickPlayCard.dataset.id;
                const marketTitle = dom.quickPlayCard.dataset.title;
                const isMock = dom.quickPlayCard.dataset.ismock === 'true';

                addItemToPledgePool(marketId, marketTitle, vote.toUpperCase(), isMock);
            }

            // Wait for animation to finish, then load the next card
            setTimeout(() => {
                dom.quickPlayCard.classList.remove(animationClass);
                dom.quickPlayCard.classList.add('fade-in'); // Fade in new card
                loadQuickPlay(currentQuickPlayIndex + 1);

                // Force a reflow to restart the animation
                void dom.quickPlayCard.offsetWidth; 
                dom.quickPlayCard.classList.remove('fade-in');
                isAnimating = false;
            }, 500);
        }

        /**
         * Adds a selected Quick Play item to the local `pledgePoolItems` array.
         */
        function addItemToPledgePool(marketId, marketTitle, pick, isMock = false) {
            const existingItem = pledgePoolItems.find(item => item.id === marketId);

            if (existingItem) {
                if (existingItem.pick === pick) showToast("Already in Pledge Pool!");
                else {
                    existingItem.pick = pick; // Update the pick
                    showToast(`Updated pick to ${pick}!`);
                    if (currentScreenId === 'pledge-pool-screen') renderPledgePool();
                }
            } else {
                // Add new item to the pool
                pledgePoolItems.push({ id: marketId, title: marketTitle, pick: pick, isMock: isMock });
                showToast(`Added to Pledge Pool!`, "success");
                if (currentScreenId === 'pledge-pool-screen') renderPledgePool();
            }

            // --- THIS IS THE CORRECT SPOT ---
            // Inside the function, after the if/else block
            localStorage.setItem('pledgePool', JSON.stringify(pledgePoolItems));

        } // <-- The function ends here.

        /**
         * Removes an item from the local `pledgePoolItems` array.
         */
        window.removeItemFromPledgePool = (marketId) => {
            pledgePoolItems = pledgePoolItems.filter(item => item.id !== marketId);
            showToast("Removed from pool.", "info");
            renderPledgePool(); 
            localStorage.setItem('pledgePool', JSON.stringify(pledgePoolItems));
            // Re-render the pool
        }

        /**
         * Renders the "Pledge Pool" screen with all items from the local array.
         */
        function renderPledgePool() {
            const emptyState = document.getElementById('pledge-pool-empty');
            if (!dom.pledgePoolContent) return;
            if (pledgePoolItems.length === 0) {
                // Show empty state, hide grid
                if (emptyState) emptyState.classList.remove('hidden');
                dom.pledgePoolContent.classList.add('hidden');
                dom.pledgePoolFooter.classList.add('hidden');
            } else {
                // Hide empty state, show grid
                if (emptyState) emptyState.classList.add('hidden');
                dom.pledgePoolContent.classList.remove('hidden');
                // Build the list of pledge items
                let html = '';
                pledgePoolItems.forEach(item => {
                    const pickClass = item.pick === 'YES' ? 'badge-pick-yes' : 'badge-pick-no';
                    const mockBadge = item.isMock ? '<span class="badge badge-blue ml-2">Mock</span>' : '';
                    html += `
                        <div class="ui-panel p-4 mb-3">
                            <p class="text-white font-medium leading-tight">${item.title}</p>
                            <div class="flex justify-between items-center mt-3">
                                <div>
                                    <span class="text-sm text-gray-400">Pick:</span>
                                    <span class="badge ${pickClass} ml-2">${item.pick}</span>
                                    ${mockBadge}
                                </div>
                                <button onclick="removeItemFromPledgePool('${item.id}')" class="text-red-400 text-xs font-medium hover:text-red-300">
                                    Remove
                                </button>
                            </div>
                            <div class="mt-3">
                                <label class="text-sm font-medium text-gray-300">Amount:</label>
                                <input 
                                    type="number" 
                                    class="ui-input pledge-amount-input mt-1" 
                                    placeholder="0.00" 
                                    data-market-id="${item.id}"
                                    oninput="updatePledgeTotalSummary()">
                            </div>
                        </div>
                    `;
                });
                dom.pledgePoolContent.innerHTML = html;
                dom.pledgePoolFooter.classList.remove('hidden');

                // Add change listener to the asset select
                dom.pledgeAllAsset.removeEventListener('change', updatePledgeTotalSummary); // Avoid duplicates
                dom.pledgeAllAsset.addEventListener('change', updatePledgeTotalSummary);

                updatePledgeTotalSummary();
            }
        }

        /**
         * Sets all pledge input fields to the same amount (e.g., $1, $5, $10).
         */
        window.setPledgeAll = (amount, asset) => {
            dom.pledgeAllAsset.value = asset;
            const inputs = document.querySelectorAll('.pledge-amount-input');
            inputs.forEach(input => {
                input.value = amount;
            });
            updatePledgeTotalSummary();
        }

        /**
         * Updates the "Total: $X.XX" summary text in the pledge pool footer.
         */
        function updatePledgeTotalSummary() {
            const inputs = document.querySelectorAll('.pledge-amount-input');
            const asset = dom.pledgeAllAsset.value;
            let totalAmount = 0;
            let numPledges = 0;

            inputs.forEach(input => {
                const amount = parseFloat(input.value) || 0;
                if (amount > 0) {
                    totalAmount += amount;
                    numPledges++;
                }
            });

            if (numPledges === 0) {
                dom.pledgeTotalSummary.innerText = '';
                dom.stakeAllPledgesBtn.innerText = 'Confirm Pledges';
                return;
            }

            let totalString = (asset === 'BUSD') 
                ? `$${totalAmount.toFixed(2)} BUSD` 
                : `${totalAmount.toFixed(4)} ${asset}`;

            dom.pledgeTotalSummary.innerText = `Total: ${totalString} (${numPledges} pledge${numPledges > 1 ? 's' : ''})`;
            dom.stakeAllPledgesBtn.innerText = `Confirm (${totalString})`;
        }

        /**
         * Submits all items in the pledge pool using the AMM Transaction Model.
         * [CORRECTED for "Reads Before Writes" Error]
         */
        window.stakeAllPledges = async () => {
            // 1. Get all Firebase functions
            const { doc, updateDoc, increment, collection, runTransaction, serverTimestamp, getDoc } = window.firebase.firestore;

            if (pledgePoolItems.length === 0) return;

            const selectedAsset = dom.pledgeAllAsset.value;
            let totalStakeAmount = 0;
            let pledgesToProcess = [];

            // 2. First loop: Validate inputs and calculate total
            for (const item of pledgePoolItems) {
                const input = document.querySelector(`.pledge-amount-input[data-market-id="${item.id}"]`);
                const amountPerPledge = parseFloat(input.value);

                if (amountPerPledge && amountPerPledge > 0) {
                    totalStakeAmount += amountPerPledge;
                    pledgesToProcess.push({ ...item, amount: amountPerPledge });
                }
            }

            if (pledgesToProcess.length === 0) {
                showToast("Please enter a valid amount for at least one pledge.", "warning");
                return;
            }

            // 3. Get the correct balance field name
            let balanceFieldToUpdate = "";
            if (selectedAsset === "BUSD") { balanceFieldToUpdate = "balance"; }
            else if (selectedAsset === "BNB") { balanceFieldToUpdate = "bnbBalance"; }
            else if (selectedAsset === "CAKE") { balanceFieldToUpdate = "cakeBalance"; }

            // 4. Mock "on-chain" delay
            showLoadingOverlay(true, "Confirming on-chain...");
            await new Promise(res => setTimeout(res, 3000));

            try {
                // 5. --- RUNS THE ATOMIC TRANSACTION ---
                await runTransaction(db, async (transaction) => {

                    // --- PART 1: ALL READS FIRST ---

                    // 6. Get profile refs
                    const profileRef = doc(db, 'artifacts', APP_ID, 'public', 'data', USER_PROFILE_COLLECTION, currentUserId);
                    const publicProfileRef = doc(db, 'artifacts', APP_ID, 'public', 'data', PUBLIC_LEADERBOARD_COLLECTION, currentUserId);
                    const pledgeCollection = collection(db, 'artifacts', APP_ID, 'public', 'data', PLEDGES_COLLECTION);

                    // 7. TRANSACTION READ 1: Get the user's profile
                    const profileSnap = await transaction.get(profileRef);
                    if (!profileSnap.exists()) { throw new Error("User profile not found."); }

                    // 8. TRANSACTION READ 2: Get all market data
                    const marketRefs = pledgesToProcess.map(item => 
                        doc(db, 'artifacts', APP_ID, 'public', 'data', QUICK_PLAY_MARKETS_COLLECTION, item.id)
                    );
                    const marketSnaps = await Promise.all(marketRefs.map(ref => transaction.get(ref)));

                    // --- ALL READS ARE NOW COMPLETE ---

                    // 9. Balance Check (using the data we just read)
                    const userBalances = profileSnap.data();
                    const currentAssetBalance = userBalances[balanceFieldToUpdate] || 0;
                    if (totalStakeAmount > currentAssetBalance) {
                        throw new Error(`Insufficient ${selectedAsset} balance. You need ${totalStakeAmount.toFixed(4)}.`);
                    }

                    // --- PART 2: ALL WRITES SECOND ---

                    let totalXp = 0;

                    // 10. TRANSACTION LOOP: Process each pledge (WRITE ONLY)
                    for (let i = 0; i < pledgesToProcess.length; i++) {
                        const item = pledgesToProcess[i];
                        const marketSnap = marketSnaps[i]; // Get the market data we fetched earlier

                        const amountInUsdPerPledge = item.amount * getMockPrice(selectedAsset);
                        const txHash = generateFakeTxHash();
                        totalXp += getRandomXP(10);

                        // Safety check: Does this market have AMM pools?
                        if (!marketSnap.exists() || !marketSnap.data().yesPool) {
                            // This is a MOCK market or an OLD market.
                            // We will use the old 60/40 fixed-odds logic for this one.
                            const odds = 60; 
                            const potentialReturn = (amountInUsdPerPledge / (odds / 100));

                            const pledgeRef = doc(pledgeCollection);
                            transaction.set(pledgeRef, {
                                marketId: item.id,
                                marketTitle: item.title,
                                userId: currentUserId,
                                pick: item.pick,
                                amount: item.amount, 
                                asset: selectedAsset, 
                                amountUsd: amountInUsdPerPledge, 
                                potentialReturn: potentialReturn,
                                txHash: txHash,
                                isResolved: false,
                                isWinner: null,
                                payout: 0,
                                createdAt: new Date().toISOString(),
                                stakeTimestamp: serverTimestamp(),
                                isQuickPlay: true 
                            });

                        } else {
                            // --- THIS IS A REAL AMM QUICK PLAY ---
                            // 11. AMM MATH
                            const market = marketSnap.data();
                            const marketRef = marketSnap.ref; // Get the ref from the snapshot
                            let yesPool = market.yesPool;
                            let noPool = market.noPool;
                            const k = yesPool * noPool;
                            let potentialPayoutUsd = 0; // "Shares"

                            if (item.pick === 'YES') {
                                const newYesPool = yesPool + amountInUsdPerPledge;
                                const newNoPool = k / newYesPool;
                                potentialPayoutUsd = noPool - newNoPool;
                                yesPool = newYesPool;
                                noPool = newNoPool;
                            } else { // pick === 'NO'
                                const newNoPool = noPool + amountInUsdPerPledge;
                                const newYesPool = k / newNoPool;
                                potentialPayoutUsd = yesPool - newYesPool;
                                yesPool = newYesPool;
                                noPool = newNoPool;
                            }

                            const totalPool = yesPool + noPool;
                            const newYesPercent = (yesPool / totalPool) * 100;
                            const newNoPercent = (noPool / totalPool) * 100;

                            // 12. TRANSACTION WRITE 1: Update the market
                            transaction.update(marketRef, {
                                yesPool: yesPool,
                                noPool: noPool,
                                yesPercent: newYesPercent,
                                noPercent: newNoPercent,
                                totalStakeVolume: increment(amountInUsdPerPledge)
                            });

                            // 13. TRANSACTION WRITE 2: Create the pledge
                            const pledgeRef = doc(pledgeCollection);
                            transaction.set(pledgeRef, {
                                marketId: item.id,
                                marketTitle: item.title,
                                userId: currentUserId,
                                pick: item.pick,
                                amount: item.amount,
                                asset: selectedAsset,
                                amountUsd: amountInUsdPerPledge,
                                potentialReturn: potentialPayoutUsd, // AMM "Shares"
                                txHash: txHash,
                                isResolved: false,
                                isWinner: null,
                                payout: 0,
                                createdAt: new Date().toISOString(),
                                stakeTimestamp: serverTimestamp(),
                                isQuickPlay: true
                            });
                        }
                    } // --- End of for...loop ---

                    // 14. TRANSACTION WRITE 3: Update profile (one time at the end)
                    transaction.update(profileRef, { 
                        xp: increment(totalXp),
                        [balanceFieldToUpdate]: increment(-totalStakeAmount)
                    });

                    // 15. TRANSACTION WRITE 4: Update leaderboard
                    if (totalXp > 0) {
                        transaction.update(publicProfileRef, { xp: increment(totalXp) });
                    }
                });
                // --- END OF TRANSACTION ---

                // 16. Clear the processed items from the local pool
                pledgePoolItems = pledgePoolItems.filter(item => 
                    !pledgesToProcess.find(p => p.id === item.id)
                );
                localStorage.setItem('pledgePool', JSON.stringify(pledgePoolItems));

                renderPledgePool(); // Re-render the (now empty) pool
                showLoadingOverlay(false);
                showToast(`${pledgesToProcess.length} Pledges Confirmed on BNB Testnet!`, "success");
                showScreen('profile-screen'); 

            } catch (error) {
                console.error("Pledge staking failed:", error);
                showLoadingOverlay(false);
                // Use the string(error) trick to show the real error
                showToast(`Staking failed: ${String(error)}`, "error");
            }
        }

        // =====================================================================
        // --- CREATE MARKET ---
        // =====================================================================

        /**
         * Wires up the listeners for the Create Market screen (odds calculation, etc.).
         */
        function setupCreateMarketListeners() {
            // This is your existing listener for the YES box
            dom.marketYesInput.addEventListener('input', () => {
                const yes = parseFloat(dom.marketYesInput.value);
                if (yes >= 0 && yes <= 100) {
                    dom.marketNoInput.value = (100 - yes).toFixed(1); // Use toFixed for decimals
                } else if (dom.marketYesInput.value === "") {
                    dom.marketNoInput.value = "";
                }
                updatePreview();
            });

            // ---- ADD THIS NEW LISTENER FOR THE NO BOX ----
            dom.marketNoInput.addEventListener('input', () => {
                const no = parseFloat(dom.marketNoInput.value);
                if (no >= 0 && no <= 100) {
                    dom.marketYesInput.value = (100 - no).toFixed(1); // Use toFixed for decimals
                } else if (dom.marketNoInput.value === "") {
                    dom.marketYesInput.value = "";
                }
                updatePreview();
            });
            // ---- END OF NEW BLOCK ----

            document.getElementById('market-title-input').addEventListener('input', updatePreview);
        }

        /**
         * Get APY for protocol
         */
        function getProtocolApy(protocol) {
            const apyMap = {
                'aave': 4.12,
                'compound': 3.88,
                'lido': 3.2,
                'yearn': 5.8,
                'curve': 2.9,
                'convex': 4.5
            };
            return apyMap[protocol] || 0;
        }

        /**
         * Handles yield protocol selection.
         */
        window.selectYield = (protocol) => {
            document.getElementById('selected-yield-protocol').value = protocol;
            
            const protocols = ['aave', 'compound', 'lido', 'yearn', 'curve', 'convex'];
            
            protocols.forEach(p => {
                const btn = document.getElementById(`yield-protocol-${p}`);
                if (btn) {
                    const isSelected = p === protocol;
                    btn.classList.toggle('border-sky-400', isSelected);
                    btn.classList.toggle('bg-sky-500/10', isSelected);
                    btn.classList.toggle('text-gray-400', !isSelected);
                    btn.classList.toggle('text-white', isSelected);
                    btn.classList.toggle('border-transparent', !isSelected);
                }
            });
        }

        /**
         * Updates the "Live Preview" panel on the Create Market screen.
         */
        function updatePreview() {
            dom.previewTitle.innerText = document.getElementById('market-title-input').value || '...';
            dom.previewYes.innerText = `${document.getElementById('market-yes-input').value || '--'}%`;
            dom.previewNo.innerText = `${document.getElementById('market-no-input').value || '--'}%`;
            dom.previewYes.classList.toggle('text-gray-400', !dom.marketYesInput.value);
            dom.previewNo.classList.toggle('text-gray-400', !dom.marketNoInput.value);
        }

        /**
         * Submits a new standard market to Firestore.
         */

        /**
         * Handles the new "No-Loss" vs "Traditional" market type buttons.
         */
        window.selectMarketType = (type) => {
            const noLossBtn = document.getElementById('btn-market-no-loss');
            const traditionalBtn = document.getElementById('btn-market-traditional');
            const noLossOptions = document.getElementById('no-loss-options');
            const typeInput = document.getElementById('market-type-input');

            if (type === 'no-loss') {
                typeInput.value = 'no-loss';
                noLossBtn.classList.replace('btn-secondary', 'btn-stake-yes');
                traditionalBtn.classList.replace('btn-stake-no', 'btn-secondary');
                noLossOptions.classList.remove('hidden');
            } else {
                typeInput.value = 'traditional';
                noLossBtn.classList.replace('btn-stake-yes', 'btn-secondary');
                traditionalBtn.classList.replace('btn-secondary', 'btn-stake-no');
                noLossOptions.classList.add('hidden'); // <-- This is the line that hides it
            }
        }
        // ---- END OF NEW FUNCTION ----


        async function createMarket() {
            // 1. Get all Firebase functions
            const { addDoc, collection, doc, updateDoc, increment, serverTimestamp, runTransaction } = window.firebase.firestore;

            // 2. Get all form values
            const title = document.getElementById('market-title-input').value;
            const insight = document.getElementById('market-insight-input').value;
            const yesPercent = parseFloat(dom.marketYesInput.value, 10);
            const noPercent = parseFloat(dom.marketNoInput.value, 10);
            const stakeDuration = document.getElementById('market-stake-duration').value;
            const resolutionDate = document.getElementById('market-resolution-date').value;
            const category = document.getElementById('market-category-select').value;

            // Get the new liquidity info
            const liquidityAmount = parseFloat(dom.marketLiquidityInput.value);
            const liquidityAsset = dom.marketLiquidityAsset.value;
            const balanceFieldToUpdate = getBalanceField(liquidityAsset);
            const liquidityAmountInUsd = liquidityAmount * getMockPrice(liquidityAsset);

            const selectedMarketType = document.getElementById('market-type-input').value;
            const isNoLossFinal = selectedMarketType === 'no-loss';
            const yieldProtocolFinal = isNoLossFinal ? document.getElementById('selected-yield-protocol').value : null;

            // 3. --- NEW, STRICTER VALIDATION ---
            if (!title || !insight || !stakeDuration || !resolutionDate || isNaN(yesPercent) || isNaN(noPercent) || !liquidityAmount || liquidityAmount <= 0) {
                showToast("Please fill out all fields, including a valid liquidity amount.");
                return;
            }
            if (Math.abs(yesPercent + noPercent - 100) > 0.001) {
                showToast("Error: Percentages must add up to 100%.");
                return;
            }
            if (yesPercent <= 0 || yesPercent >= 100) {
                showToast("Error: For AMM markets, odds must be between 1% and 99%.");
                return;
            }
            if (category === "Other") {
                showToast("Please select a market category.");
                return;
            }
            // --- END NEW VALIDATION ---

            showLoadingOverlay(true, "Creating market...");

            try {
                // --- THIS IS THE CORRECT, SECURE TRANSACTION ---
                await runTransaction(db, async (transaction) => {
                    const profileRef = doc(db, 'artifacts', APP_ID, 'public', 'data', USER_PROFILE_COLLECTION, currentUserId);
                    const publicProfileRef = doc(db, 'artifacts', APP_ID, 'public', 'data', PUBLIC_LEADERBOARD_COLLECTION, currentUserId);
                    const marketCollectionRef = collection(db, 'artifacts', APP_ID, 'public', 'data', STANDARD_MARKETS_COLLECTION);

                    // 1. TRANSACTION READ: Get user's profile to check balance
                    const profileSnap = await transaction.get(profileRef);
                    if (!profileSnap.exists()) {
                        throw new Error("User profile not found.");
                    }

                    // 2. BALANCE CHECK:
                    const currentAssetBalance = profileSnap.data()[balanceFieldToUpdate] || 0;
                    if (liquidityAmount > currentAssetBalance) {
                        throw new Error(`Insufficient ${liquidityAsset} balance. You need ${liquidityAmount}.`);
                    }

                    // 3. TRANSACTION WRITE 1: Create the new market
                    const newMarketRef = doc(marketCollectionRef); // Create ref for the new doc
                    const protocolApy = getProtocolApy(yieldProtocolFinal);
                    transaction.set(newMarketRef, {
                        title,
                        insight,
                        category: category,
                        yesPercent: yesPercent,
                        noPercent: noPercent,
                        // Use the user's staked liquidity
                        yesPool: liquidityAmountInUsd * (yesPercent / 100),
                        noPool: liquidityAmountInUsd * (noPercent / 100),
                        isNoLoss: isNoLossFinal,
                        stakeDuration,
                        resolutionDate,
                        yieldProtocol: yieldProtocolFinal,
                        totalStakeVolume: liquidityAmountInUsd, // The creator's stake is the starting volume
                        uniqueStakerCount: 1, // The creator is the first staker
                        refundVolumeGoal: 100,
                        refundStakerGoal: 10,
                        isResolved: false,
                        winningOutcome: null,
                        createdAt: serverTimestamp(),
                        createdBy: currentUserId,
                        createdByDisplayName: userProfile.displayName,
                        // Yield system fields
                        totalPrincipalUsd: isNoLossFinal ? liquidityAmountInUsd : 0,
                        lastAccrualAt: serverTimestamp(),
                        accruedYieldUsd: 0,
                        protocolApy: protocolApy,
                        disputes: [],
                        resolutionSource: null,
                        adminEvents: []
                    });

                    // 4. TRANSACTION WRITE 2: Deduct liquidity AND award XP
                    const xpToAward = getRandomXP(50);
                    transaction.update(profileRef, {
                        [balanceFieldToUpdate]: increment(-liquidityAmount),
                        xp: increment(xpToAward)
                    });

                    // 5. TRANSACTION WRITE 3: Update public leaderboard
                    transaction.update(publicProfileRef, { xp: increment(xpToAward) });
                });
                // --- END OF TRANSACTION ---

                showLoadingOverlay(false);
                showToast("Market created successfully!", "success");
                showScreen('home-screen');

                // 6. Clear the form
                document.getElementById('market-title-input').value = '';
                document.getElementById('market-insight-input').value = '';
                dom.marketYesInput.value = '';
                dom.marketNoInput.value = '';
                document.getElementById('market-stake-duration').value = '';
                document.getElementById('market-resolution-date').value = '';
                dom.marketLiquidityInput.value = '';

            } catch (error) {
                console.error("Error creating market:", error);
                showLoadingOverlay(false);
                showToast(`Market creation failed: ${error.message}`, "error");
            }
        }

        // =====================================================================
        // --- GEMINI AI FUNCTIONS ---
        // ====================================================================        /**
                 /* A robust, reusable function for calling the Gemini API.
                 * [FINAL VERSION 2 - Handles new Backend]
                 * This now sends a structured payload to our backend proxy.
                 **/
                async function callGemini (systemPrompt, userPrompt, tools = null, jsonSchema = null) {
                    console.log("Calling our backend (/api/gemini)...");

                    const API_ENDPOINT = '/api/gemini';

                    // 1. Build the payload for our backend
                    const payload = {
                        systemPrompt: systemPrompt,
                        userPrompt: userPrompt,
                        tools: tools,           // Will be null OR { google_search, ... }
                        jsonSchema: jsonSchema  // Will be null OR { schema... }
                    };

                    try {
                        // 2. Call our backend proxy
                        const response = await fetch(API_ENDPOINT, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        const result = await response.json(); // Get the full Google response

                        if (!response.ok) {
                            console.error("Backend API Error:", result);
                            throw new Error(result.error?.message || 'Unknown backend error');
                        }

                        // 3. Parse the response (text, function, or JSON)
                        if (!result.candidates || !result.candidates[0].content.parts[0]) {
                            throw new Error("Invalid API response structure.");
                        }

                        const part = result.candidates[0].content.parts[0];

                        // Check if the AI wants to call our function
                        if (part.functionCall) {
                            console.log("Function Call detected:", part.functionCall);

                            // --- THIS IS THE FIX ---
                            // Sometimes the API returns a string, sometimes an object.
                            // We must check the type before parsing.
                            if (typeof part.functionCall.args === 'string') {
                                // It's a string, we must parse it.
                                console.log("Parsing functionCall.args from string...");
                                return JSON.parse(part.functionCall.args); 
                            } else {
                                // It's already an object, just return it.
                                console.log("Returning functionCall.args as object...");
                                return part.functionCall.args;
                            }
                            // --- END OF FIX ---
                        }

                        // Check for Text (for AI Explain / AI Judge's *text* mode)
                        if (part.text) {
                            // Check if AI Judge returned JSON as text
                            if (jsonSchema) {
                                try {
                                    return JSON.parse(part.text);
                                } catch (e) {
                                    console.warn("AI was in JSON mode but did not return valid JSON.", part.text);
                                    throw new Error("AI returned invalid JSON.");
                                }
                            }
                            // It's just plain text
                            return part.text;
                        }

                        throw new Error("No text or functionCall found in response.");

                    } catch (error) {
                        console.error("callGemini function failed:", error);
                        throw error;
                    }
                }

        /**
                 * AI Function: Fills out the "Create Market" form.
                 * [FINAL 2-CALL-CHAIN FIX]
                 */
                async function getAIAssist() {
                    const prompt = document.getElementById('ai-helper-prompt').value;
                    if (!prompt) {
                        showToast("Please enter a prompt first.");
                        return;
                    }

                    document.getElementById('ai-spinner').classList.remove('hidden');
                    const resultPanel = document.getElementById('ai-suggestion-panel');
                    if (resultPanel) resultPanel.classList.add('hidden');

                    try {
                        // --- CALL 1: GET "SMART" IDEAS (Google Search only) ---
                        console.log("AI Assist (Step 1/2): Getting future-event ideas...");
                        const searchTools = [{ "google_search": {} }];
                        const systemPrompt_1 = `You are a research assistant. Use Google Search to find up-to-date, real-time information about the user's topic.
        Find a *single, specific, future-focused* event (for 2025 or 2026).
        Respond ONLY with a 1-2 sentence summary of this event.
        Example: "Solana's Firedancer upgrade is scheduled for 2026, aiming to improve network speed."`;

                        // We call with 'tools' (for Search) and null for 'jsonSchema'
                        const ideaText = await callGemini(systemPrompt_1, prompt, searchTools, null);

                        if (typeof ideaText !== 'string' || ideaText.length < 10) {
                            throw new Error("AI (Step 1) failed to find a valid event.");
                        }

                        // --- CALL 2: "AUTO-FILL" THE FORM (Function Calling only) ---
                        console.log("AI Assist (Step 2/2): Formatting ideas into a market...");

                        // 1. Define the tool we want the AI to use
                        const createMarketTool = {
                            "functionDeclarations": [
                                {
                                    "name": "create_market_form",
                                    "description": "Creates a new prediction market.",
                                    "parameters": {
                                        "type": "OBJECT",
                                        "properties": {
                                            "title": { "type": "STRING", "description": "A yes/no question for the market outcome." },
                                            "insight": { "type": "STRING", "description": "Brief, compelling insight supporting the market." },
                                            "yesPercent": { "type": "NUMBER", "description": "Initial confidence level for YES (1-99)." },
                                            "noPercent": { "type": "NUMBER", "description": "Initial confidence level for NO (1-99)." },
                                            "category": { "type": "STRING", "description": "The market category. Must be one of: Crypto, Sports, Politics, Entertainment, Finance, Tech, Other" }
                                        },
                                        "required": ["title", "insight", "yesPercent", "noPercent", "category"]
                                    }
                                }
                            ]
                        };
                        const functionTools = [ createMarketTool ]; // Note: No Google Search

                        const systemPrompt_2 = `You are a market creator. A user has provided context about a future event.
                        Your ONLY job is to use the 'create_market_form' tool to create a market based on this context.
                        The 'title' must be a yes/no question.
                        The 'insight' must be a brief summary of the context.
                        You MUST select the most relevant 'category' from the allowed list.
                        Odds (yesPercent, noPercent) must be between 1 and 99, and sum to 100.
                        You MUST use the 'create_market_form' tool.`;

                        // The 'prompt' for this call is the *result* from Call 1
                        const userPrompt_2 = `Context: "${ideaText}"`;

                        // We call with 'tools' (for Function) and null for 'jsonSchema'
                        const data = await callGemini(systemPrompt_2, userPrompt_2, functionTools, null);

                        if (typeof data === 'object') {
                            // SUCCESS! The AI used our function tool.
                            document.getElementById('market-title-input').value = data.title;
                            document.getElementById('market-insight-input').value = data.insight;
                            dom.marketYesInput.value = data.yesPercent;
                            dom.marketNoInput.value = data.noPercent;
                            document.getElementById('market-category-select').value = data.category;
                            updatePreview();
                        } else {
                            throw new Error("AI (Step 2) failed to return a valid form.");
                        }

                    } catch (error) {
                        console.error("AI Assist Error:", error);
                        showToast(`AI failed: ${error.message}`);
                    } finally {
                        document.getElementById('ai-spinner').classList.add('hidden');
                    }
                }

                /**
                 * AI Function: Provides a Bull/Bear case on the Market Detail screen.
                 * [FINAL VERSION - Now with Google Search]
                 */
                async function getAIExplanation() {
                    if (!currentMarket) { showToast("No market loaded."); return; }

                    dom.aiExplainPanel.innerHTML = '<div class="flex justify-center items-center py-4"><div class="spinner w-6 h-6 border-2 border-transparent rounded-full"></div><span class="ml-3 text-gray-300">Loading AI analysis...</span></div>';
                    dom.aiExplainPanel.classList.remove('hidden');

                    const { title, insight } = currentMarket;

                    // 1. --- THIS IS THE FIX ---
                    // We just need Google Search, so we send this 'tools' array
                    const tools = [
                        { "google_search": {} }
                    ];

                    const systemPrompt = `You are a concise market analyst. Use Google Search to find contemporary context.
        Provide a simple, neutral 'Bull Case' (for YES) and 'Bear Case' (for NO).
        Format as: Bull Case: ... Bear Case: ... Be concise and use newline characters.`;
                    const userPrompt = `Analyze the following prediction market:
            Market: "${title}"
            Insight: "${insight}"`;

                    try {
                        // 2. Call with 'tools' and null 'jsonSchema'

                        const text = await callGemini(systemPrompt, userPrompt, tools, null);
                        dom.aiExplainPanel.innerHTML = text.replace(/\n/g, '<br>');
                    } catch (error) {
                        console.error("AI Explanation Error:", error);
                        dom.aiExplainPanel.innerHTML = `<p class="text-red-400 text-center">Error: ${error.message}</p>`;
                    }
                }

                /**
                 * AI Function: The "AI Judge" - finds the outcome AND a source URL.
                 * [FINAL VERSION - Uses JSON Mode]
                 */
                window.getAIResolution = async (marketId, marketTitle) => {
                    const today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                    const resultDiv = document.getElementById(`ai-resolve-result-${marketId}`);
                    if (!resultDiv) return;

                    resultDiv.innerHTML = '<div class="flex justify-center items-center py-2"><div class="spinner w-5 h-5 border-2 border-transparent rounded-full"></div><span class="ml-3 text-gray-300 text-sm">AI is searching...</span></div>';
                    resultDiv.classList.remove('hidden');

                    // 1. --- THIS IS THE FIX ---
                    // This function uses JSON Mode, so 'tools' is null.
                    const systemPrompt = `You are a neutral, objective fact-checker. 
                    **Check for final results as of today's date (${today}).** You MUST provide a single, high-quality URL as a 'source of truth'.
                    The 'outcome' must be 'YES', 'NO', or 'AMBIGUOUS'.
                    Respond ONLY with the valid JSON.`;
                    const userPrompt = `Find the answer and a source URL for this market: "${marketTitle}"`;

                    // 2. This is the schema for JSON Mode
                    const schema = {
                        type: "OBJECT",
                        properties: {
                            "outcome": { "type": "STRING" },
                            "sourceURL": { "type": "STRING" },
                            "reasoning": { "type": "STRING" }
                        },
                        required: ["outcome", "sourceURL", "reasoning"]
                    };

                    try {
                        // 3. We call with null 'tools' and the 'schema'
                        const data = await callGemini(systemPrompt, userPrompt, null, schema);

                        // 'data' is now the parsed JSON object
                        const text = data.outcome.toUpperCase();
                        let outcomeColor = "text-yellow-400";
                        if (text === "YES") outcomeColor = "text-green-400";
                        if (text === "NO") outcomeColor = "text-red-400";

                        resultDiv.innerHTML = `
                            <p class="text-sm text-gray-400">${data.reasoning}</p>
                            <p class="text-sm text-gray-400 mt-2 truncate">
                                Source: <a href="${data.sourceURL}" target="_blank" class="text-sky-400 hover:underline" rel="noopener noreferrer">Click to verify</a>
                            </p>
                            <h4 class="text-lg font-bold ${outcomeColor} my-3">
                                AI Suggestion: ${text}
                            </h4>
                            ${text !== 'AMBIGUOUS' ? `
                                <button class="btn ${text === 'YES' ? 'btn-stake-yes' : 'btn-stake-no'} w-full"
                                    onclick="resolveMarket('${marketId}', '${text}')">
                                    Accept & Resolve as ${text}
                                </button>
                            ` : `<p class="text-yellow-400 text-center">Market cannot be resolved yet.</p>`}
                        `;
                    } catch (error) {
                        console.error("AI Resolution Error:", error);
                        resultDiv.innerHTML = `<p class="text-red-400 text-center">AI check failed: ${error.message}</p>`;
                    }
                }

        /**
         * AI Function: Generates a performance summary on the Profile screen.
         */
        async function getAIProfileSummary() {
            if (!userHistoryData || userHistoryData.length === 0) {
                showToast("No prediction history to analyze yet!");
                return;
            }

            dom.aiProfileSummaryPanel.innerHTML = '<div class="flex justify-center items-center py-4"><div class="spinner w-6 h-6 border-2 border-transparent rounded-full"></div><span class="ml-3 text-gray-300">Analyzing performance...</span></div>';
            dom.aiProfileSummaryPanel.classList.remove('hidden');
            dom.aiProfileSummaryBtn.disabled = true;

            // Format history for the AI
            const historyText = userHistoryData.map(pledge => 
                `Market: "${pledge.marketTitle}", Result: ${pledge.isWinner ? 'WON' : 'LOST'}, Payout: $${pledge.payout.toFixed(2)}`
            ).join('\n');

            const systemPrompt = `You are an encouraging but sharp-witted financial analyst.
Give a concise, one-paragraph summary of the user's performance.
Highlight any trends and give one small, playful tip.`;
            const userPrompt = `Here is my prediction history:
${historyText}`;

            try {
                const summaryText = await callGemini(systemPrompt, userPrompt, null);
                dom.aiProfileSummaryPanel.innerHTML = `<p class="text-gray-300">${summaryText}</p>`;
            } catch (error) {
                console.error("AI Profile Summary Error:", error);
                showToast("Error generating AI summary. Check console.");
                dom.aiProfileSummaryPanel.innerHTML = '<p class="text-red-400 text-center">AI summary failed to load.</p>';
            } finally {
                dom.aiProfileSummaryBtn.disabled = false;
            }
        }

        // =====================================================================
        // --- ADMIN PANEL ---
        // =====================================================================


        let adminTapCount = 0;
        let adminTapTimer = null;

        /**
         * Wires up all listeners for the Admin Panel.
         */
        function setupAdminFeatures() {
            // Secret 5-tap gesture on the app title (both desktop and mobile)
            const handleAdminTap = () => {
                adminTapCount++;
                clearTimeout(adminTapTimer);
                adminTapTimer = setTimeout(() => { adminTapCount = 0; }, 2000);
                if (adminTapCount >= 5) {
                    adminTapCount = 0;
                    showScreen('admin-password-screen');
                }
            };
            
            document.getElementById('app-title').addEventListener('click', handleAdminTap);
            document.getElementById('mobile-app-title').addEventListener('click', handleAdminTap);

            // Admin password check
            document.getElementById('admin-login-btn').addEventListener('click', () => {
                const pass = document.getElementById('admin-password-input').value;
                if (pass === ADMIN_PASSWORD) {
                    showScreen('admin-panel-screen');
                } else {
                    showToast("Incorrect password.");
                }
                document.getElementById('admin-password-input').value = '';
            });

            document.getElementById('admin-logout-btn').addEventListener('click', () => showScreen('home-screen'));
            document.getElementById('admin-generate-btn').addEventListener('click', adminGenerateQuickPlay);
            document.getElementById('admin-publish-btn').addEventListener('click', adminPublishQuickPlay);
        }

        /**
                 * AI Function: Fills the Admin Quick Play form with AI suggestions.
                 * [FINAL 2-CALL-CHAIN FIX]
                 */
                async function adminGenerateQuickPlay() {
                    const today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                    const prompt = document.getElementById('admin-ai-prompt').value || "A random, exciting current event market (e.g., crypto, politics, sports, entertainment) for the next 4-24 hours.";
                    showLoadingOverlay(true, "Generating AI Quick Play...");

                    try {
                        // --- CALL 1: GET "SMART" IDEAS (Google Search only) ---
                        console.log("Admin AI (Step 1/2): Getting future-event ideas...");
                        const searchTools = [{ "google_search": {} }];
                        const systemPrompt_1 = `You are a research assistant. Use Google Search to find up-to-date, real-time information.
        Find a *single, specific, future-focused* event for today (${today}) or the next 24-48 hours.
        Respond ONLY with a 1-2 sentence summary of this event.`;

                        const ideaText = await callGemini(systemPrompt_1, prompt, searchTools, null);

                        if (typeof ideaText !== 'string' || ideaText.length < 10) {
                            throw new Error("AI (Step 1) failed to find a valid event.");
                        }

                        // --- CALL 2: "AUTO-FILL" THE FORM (Function Calling only) ---
                        console.log("Admin AI (Step 2/2): Formatting ideas into a market...");

                        const createQuickPlayTool = {
                            "functionDeclarations": [{
                                "name": "create_quick_play_form",
                                "description": "Creates a new quick play market.",
                                "parameters": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "title": { "type": "STRING" }, "duration": { "type": "STRING" },
                                        "yesPercent": { "type": "NUMBER" }, "noPercent": { "type": "NUMBER" }
                                    }, "required": ["title", "duration", "yesPercent", "noPercent"]
                                }
                            }]
                        };
                        const functionTools = [ createQuickPlayTool ]; // Note: No Google Search

                        const systemPrompt_2 = `You are a market creator. A user has provided context about a future event.
        Your ONLY job is to use the 'create_quick_play_form' tool.
        The 'title' must be a yes/no question.
        The 'duration' must be between 2h and 24h.
        Odds (yesPercent, noPercent) must be between 1 and 99, and sum to 100.
        You MUST use the 'create_quick_play_form' tool.`;

                        const userPrompt_2 = `Context: "${ideaText}"`;

                        const data = await callGemini(systemPrompt_2, userPrompt_2, functionTools, null);

                        if (typeof data === 'object') {
                            // SUCCESS!
                            dom.adminQpTitle.value = data.title;
                            dom.adminQpDuration.value = data.duration;
                            dom.adminQpYes.value = data.yesPercent;
                            dom.adminQpNo.value = data.noPercent;
                            showLoadingOverlay(false);
                            showToast("AI suggestions populated!");
                        } else {
                            throw new Error("AI (Step 2) failed to return a valid form.");
                        }

                    } catch (error) {
                        console.error("AI Admin Assist Error:", error);
                        showLoadingOverlay(false);
                        showToast(`AI failed: ${error.message}`);
                    }
                }

        /**
         * Publishes a new "real" Quick Play market from the admin panel.
         */
        async function adminPublishQuickPlay() {
            const { addDoc, collection, serverTimestamp } = window.firebase.firestore;

            const title = dom.adminQpTitle.value;
            const duration = dom.adminQpDuration.value;
            const yesPercent = parseFloat(dom.adminQpYes.value); // Use parseFloat for decimals
            const noPercent = parseFloat(dom.adminQpNo.value);

            // Validate
            if (!title || !duration || isNaN(yesPercent) || isNaN(noPercent) || Math.abs(yesPercent + noPercent - 100) > 0.001) {
                showToast("Please fill out all fields correctly. Odds must sum to 100.");
                return;
            }

            showLoadingOverlay(true, "Publishing Quick Play...");

            try {
                // Add to the quick_play_markets collection
                await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', QUICK_PLAY_MARKETS_COLLECTION), {
                    title,
                    duration,
                    yesPercent,
                    noPercent,

                    // --- ADD THESE LINES FOR AMM ---
                    // We'll add $1000 of virtual liquidity, just like standard markets
                    yesPool: 1000 * (yesPercent / 100),
                    noPool: 1000 * (noPercent / 100),
                    totalStakeVolume: 0,
                    // --- END OF NEW LINES ---

                    isResolved: false,
                    isMock: false, // All admin-created markets are REAL
                    createdAt: serverTimestamp()
                });

                showLoadingOverlay(false);
                showToast("Quick Play published successfully!");
                // Clear the form
                dom.adminQpTitle.value = '';
                dom.adminQpDuration.value = '';
                dom.adminQpYes.value = '';
                dom.adminQpNo.value = '';
                document.getElementById('admin-ai-prompt').value = '';

            } catch (error) {
                showLoadingOverlay(false);
                showToast("AI Quick Play publish failed. Check console.");
            }
        }

        /**
         * Renders the list of active standard markets for resolution.
         * [FINAL VERSION - "No Index" fix]
         */
        function renderResolutionPanel() {
            const { collection, query, where, onSnapshot } = window.firebase.firestore;
            dom.resolutionList.innerHTML = '<p class="text-gray-400 text-center">Loading markets...</p>';

            // 1. --- THIS IS THE FIX ---
            // We get ALL markets, as we can't query for 'isMock == false'
            // without a special index.
            const q = query(
                collection(db, 'artifacts', APP_ID, 'public', 'data', STANDARD_MARKETS_COLLECTION)
            );

            onSnapshot(q, (snapshot) => {
                let html = '';
                if (snapshot.empty) {
                    dom.resolutionList.innerHTML = '<p class="text-gray-400 text-center">No markets to resolve.</p>';
                    return;
                }

                // 2. --- NEW: Filter and Sort in JavaScript ---
                let markets = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // We manually filter out the mock market
                    if (data.isMock !== true) {
                        markets.push({ id: doc.id, ...data });
                    }
                });

                // Sort markets to show unresolved first
                markets.sort((a, b) => {
                    if (a.isResolved === b.isResolved) return 0;
                    return a.isResolved ? 1 : -1; // Unresolved (false) float to the top
                });
                // --- END NEW FILTER/SORT ---

                // 3. if/else logic to render the panel
                markets.forEach(market => {
                    // Escape quotes for the onclick handler
                    const marketTitle = market.title ? market.title.replace(/'/g, "\\'") : "Market Title Error";

                    if (!market.isResolved) {
                        // --- A: Market is ACTIVE (Yellow Bar) ---
                        html += `
                            <div class="ui-panel p-4 border-l-4 border-yellow-500">
                                <p class="text-white font-semibold mb-3">${market.title}</p>
                                <p class="text-xs text-gray-400 mb-3">By: @${market.createdByDisplayName || 'N/A'}</p>
                                <div class="grid grid-cols-2 gap-3">
                                    <button onclick="resolveMarket('${market.id}', 'YES')" class="btn btn-stake-yes flex-1">
                                        Resolve YES
                                    </button>
                                    <button onclick="resolveMarket('${market.id}', 'NO')" class="btn btn-stake-no flex-1">
                                        Resolve NO
                                    </button>
                                </div>


                            </div>
                        `;
                    } else {
                        // --- B: Market is RESOLVED (Gray Bar) ---
                        const outcomeColor = market.winningOutcome === 'YES' ? 'text-green-400' : 'text-red-400';
                        html += `
                            <div class="ui-panel p-4 border-l-4 border-gray-600 opacity-70">
                                <p class="text-gray-400 font-semibold mb-3">${market.title}</p>
                                <p class="text-base font-bold ${outcomeColor} mb-3">
                                    RESOLVED AS: ${market.winningOutcome || 'N/A'}
                                </p>
                                <p class="text-xs text-gray-500 mb-3">By: @${market.createdByDisplayName || 'N/A'}</p>

                                <!-- This is the new button -->
                                <button onclick="adminReOpenMarket('${market.id}')" class="btn btn-secondary w-full" style="border-color: #EF4444; color: #F87171;">
                                     Re-Open Market (Admin)
                                </button>
                            </div>
                        `;
                    }
                });
                dom.resolutionList.innerHTML = html;
            }, (error) => {
                // --- ADDED THIS ERROR HANDLER ---
                console.error("Firebase Snapshot Error in renderResolutionPanel:", error);
                dom.resolutionList.innerHTML = `<p class="text-red-400 text-center">Error loading markets: ${error.message}</p>`;
            });
        }

        // --- "AI JUDGE" FEATURE (MODIFIED) ---
        /**
         * AI Function: The "AI Judge" - finds the outcome AND a source URL.
         */
        window.getAIResolution = async (marketId, marketTitle) => {
            const today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            const resultDiv = document.getElementById(`ai-resolve-result-${marketId}`);
            if (!resultDiv) return;

            resultDiv.innerHTML = '<div class="flex justify-center items-center py-2"><div class="spinner w-5 h-5 border-2 border-transparent rounded-full"></div><span class="ml-3 text-gray-300 text-sm">AI is searching...</span></div>';
            resultDiv.classList.remove('hidden');

            // 1. Upgraded System Prompt
            const systemPrompt = `You are a neutral, objective fact-checker and oracle. 
            **Check for final results as of today's date (${today}).** Your response MUST determine the factual answer. You MUST provide a single, high-quality URL as a 'source of truth' (e.g., official results, major news) to prove the final outcome. The 'outcome' must be 'YES', 'NO', or 'AMBIGUOUS'...`;

            const userPrompt = `Find the answer and a source URL for this market: "${marketTitle}"`;

            // 2. Upgraded Schema
            const schema = {
                type: "OBJECT",
                properties: {
                    "outcome": { "type": "STRING" },
                    "sourceURL": { "type": "STRING" },
                    "reasoning": { "type": "STRING" }
                },
                required: ["outcome", "sourceURL", "reasoning"]
            };

            // 3. Upgraded UI Handling
            try {
                const jsonText = await callGemini(systemPrompt, userPrompt, schema);
                const data = jsonText; // Safe to parse
                const text = data.outcome.toUpperCase();

                let outcomeColor = "text-yellow-400";
                if (text === "YES") outcomeColor = "text-green-400";
                if (text === "NO") outcomeColor = "text-red-400";

                // --- NEW UI WITH SOURCE AND BUTTON ---
                resultDiv.innerHTML = `
                    <p class="text-sm text-gray-400">${data.reasoning}</p>
                    <p class="text-sm text-gray-400 mt-2 truncate">
                        Source: <a href="${data.sourceURL}" target="_blank" class="text-sky-400 hover:underline" rel="noopener noreferrer">Click to verify</a>
                    </p>
                    <h4 class="text-lg font-bold ${outcomeColor} my-3">
                        AI Suggestion: ${text}
                    </h4>

                    ${text !== 'AMBIGUOUS' ? `
                        <button 
                            class="btn ${text === 'YES' ? 'btn-stake-yes' : 'btn-stake-no'} w-full"
                            onclick="resolveMarket('${marketId}', '${text}')">
                            Accept & Resolve as ${text}
                        </button>
                    ` : `
                        <p class="text-yellow-400 text-center">Market cannot be resolved yet.</p>
                    `}
                `;
                // --- END OF NEW UI ---

            } catch (error) {
                console.error("AI Resolution Error:", error);
                showToast("Error getting AI resolution. Check console.");
                resultDiv.innerHTML = '<p class="text-red-400 text-center">AI check failed. Please resolve manually.</p>';
            }
        }

        /**
         * Resolves a market, finds all winning/losing pledges, and pays out.
         * This now works for BOTH standard and quick play markets.
         */
        window.resolveMarket = async (marketId, winningOutcome) => {
            showLoadingOverlay(true, `Resolving as ${winningOutcome}...`);
            const { doc, getDoc, updateDoc, collection, query, where, getDocs, writeBatch, increment } = window.firebase.firestore;

            try {
                // 1. Determine if it's a Standard or Quick Play Market
                const standardRef = doc(db, 'artifacts', APP_ID, 'public', 'data', STANDARD_MARKETS_COLLECTION, marketId);
                const quickPlayRef = doc(db, 'artifacts', APP_ID, 'public', 'data', QUICK_PLAY_MARKETS_COLLECTION, marketId);
                const standardSnap = await getDoc(standardRef);

                let marketRef, marketSnap;
                if (standardSnap.exists()) {
                    marketRef = standardRef;
                    marketSnap = standardSnap;
                } else {
                    marketSnap = await getDoc(quickPlayRef);
                    if (marketSnap.exists()) {
                        marketRef = quickPlayRef;
                    } else {
                        marketRef = null; // Mock market, no doc to update
                    }
                }
                const market = marketSnap?.data() || {};

                // 2. Find all pledges for this market
                const q = query(
                    collection(db, 'artifacts', APP_ID, 'public', 'data', PLEDGES_COLLECTION),
                    where('marketId', '==', marketId),
                    where('isResolved', '==', false)
                );
                const snapshot = await getDocs(q);

                // 3. If no pledges, just resolve the market
                if (snapshot.empty) {
                    if (marketRef) { // If it's a real market
                        await updateDoc(marketRef, {
                            isResolved: true,
                            winningOutcome: winningOutcome
                        });
                    }
                    showLoadingOverlay(false);
                    showToast("Market resolved. No pledges to pay out.");
                    return;
                }

                // 4. Create a batch to update all pledges and profiles
                const batch = writeBatch(db);
                let winnersPaid = 0;

                // Use default 60/40 odds for Quick Play if odds are missing
                const winningOdds = winningOutcome === 'YES' 
                    ? (market.yesPercent || 60) 
                    : (market.noPercent || 40);

                // --- YIELD SYSTEM LOGIC (TIME-WEIGHTED PER PLEDGE) ---
                const resolutionTime = new Date();
                
                for (const pledgeDoc of snapshot.docs) {
                    const pledge = pledgeDoc.data();
                    const pledgeRef = pledgeDoc.ref;
                    const isWinner = pledge.pick === winningOutcome;

                    // Calculate base payout based on the market's odds
                    const payoutUsd = isWinner ? (pledge.amountUsd / (winningOdds / 100)) : 0;

                    // For No-Loss, losers get principal back. For Classic, they get 0.
                    const principalReturn = market.isNoLoss ? pledge.amountUsd : 0;
                    
                    // Calculate TIME-WEIGHTED yield for THIS specific pledge
                    // Only winners earn yield, and only for the time THEIR funds were staked
                    let pledgeYield = 0;
                    if (market.isNoLoss && isWinner && market.protocolApy && pledge.stakeTimestamp) {
                        pledgeYield = calculateYield(
                            pledge.amountUsd,           // This pledge's principal
                            market.protocolApy,         // Market's APY
                            pledge.stakeTimestamp,      // When THIS pledge was staked
                            resolutionTime              // When market resolved
                        );
                        console.log(`YIELD: Pledge earned $${pledgeYield.toFixed(4)} over time`);
                    }
                    
                    // Total return = base payout + this pledge's time-weighted yield
                    const totalReturnUsd = isWinner ? (payoutUsd + pledgeYield) : principalReturn;

                    // Convert USD payout back to the original asset
                    const payoutAmount = totalReturnUsd / getMockPrice(pledge.asset);

                    // XP Change: Win big XP, Lose small XP.
                    let xpChange = isWinner ? getRandomXP(50) : -getRandomXP(10);

                    // Anti-Whale/XP Compensation Logic
                    if (isWinner) {
                        if (pledge.amountUsd <= 50) { // Small Stake (under $50)
                            xpChange *= 5; // 5X XP multiplier for small winners
                            console.log(`XP BOOST: 5X multiplier applied for small stake.`);
                        } else if (pledge.amountUsd >= 1000) { // Whale Stake (over $1000)
                            xpChange = Math.floor(xpChange / 2); // Halve the XP gain for whales
                            console.log(`XP PENALTY: XP halved for whale stake.`);
                        }
                    }
                    // ---- END NEW XP LOGIC BLOCK ----

                    // Update the pledge doc
                    batch.update(pledgeRef, {
                        isResolved: true,
                        isWinner: isWinner,
                        payout: totalReturnUsd // Store total return in USD
                    });

                    const streakUpdate = isWinner ? increment(1) : 0; // Increment streak if winner, reset to 0 if loser
                    // ---- END STREAK LOGIC BLOCK ----

                    // Find the user's profile to pay them and give XP
                    const profileRef = doc(db, 'artifacts', APP_ID, 'public', 'data', USER_PROFILE_COLLECTION, pledge.userId);
                    batch.update(profileRef, {
                        [getBalanceField(pledge.asset)]: increment(payoutAmount),
                        xp: increment(xpChange)
                    });

                    // Update the public leaderboard score
                    const publicProfileRef = doc(db, 'artifacts', APP_ID, 'public', 'data', PUBLIC_LEADERBOARD_COLLECTION, pledge.userId);
                    batch.update(publicProfileRef, {
                        xp: increment(xpChange)
                    });

                    if (isWinner) winnersPaid++;
                }

                // 5. Finally, update the market itself
                if (marketRef) {
                    batch.update(marketRef, {
                        isResolved: true,
                        winningOutcome: winningOutcome
                    });
                }

                // 6. Commit the batch
                await batch.commit();

                showLoadingOverlay(false);
                showToast(` Market Resolved! Paid out ${winnersPaid} winner(s).`);

            } catch (error) {
                console.error("Market resolution failed:", error);
                showLoadingOverlay(false);
                showToast("Market resolution failed. Check console."); 
            }
        };

        // =====================================================================
        // --- UTILITIES ---
        // =====================================================================

        /**
         * Calculates accrued yield for a market based on time and APY
         * @param {number} principalUsd - Total principal staked
         * @param {number} apyPercent - Annual percentage yield (e.g., 4.12)
         * @param {Date|Timestamp} startTime - When staking began
         * @param {Date|Timestamp} endTime - When to calculate yield until
         * @returns {number} - Accrued yield in USD
         */
        function calculateYield(principalUsd, apyPercent, startTime, endTime) {
            if (!principalUsd || !apyPercent || !startTime || !endTime) return 0;
            
            // Convert Firestore timestamps to Date objects if needed
            const start = startTime.toDate ? startTime.toDate() : new Date(startTime);
            const end = endTime.toDate ? endTime.toDate() : new Date(endTime);
            
            // Calculate time difference in days
            const timeDiffMs = end - start;
            const daysDiff = timeDiffMs / (1000 * 60 * 60 * 24);
            
            // Simple interest calculation: principal * APY * (days / 365)
            // Cap APY at 50% to prevent exploits
            const cappedApy = Math.min(apyPercent, 50);
            const yieldUsd = principalUsd * (cappedApy / 100) * (daysDiff / 365);
            
            return Math.max(0, yieldUsd); // Never return negative yield
        }

        /**
         * Generates random XP within a +/- 20% range of the base amount.
         */
        function getRandomXP(baseAmount) {
            const variation = 0.2; // 20%
            const min = baseAmount * (1 - variation);
            const max = baseAmount * (1 + variation);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        /**
         * Admin function to wipe all demo data from Firestore.
         */
        async function clearAllDemoData() {
            if (!confirm("ARE YOU SURE? This will delete ALL demo markets, pledges, and user profiles.")) {
                return;
            }

            showLoadingOverlay(true, "WIPING ALL DEMO DATA...");
            const { getDocs, collection, writeBatch } = window.firebase.firestore;

            const collectionsToWipe = [
                STANDARD_MARKETS_COLLECTION,
                QUICK_PLAY_MARKETS_COLLECTION,
                PLEDGES_COLLECTION,
                PUBLIC_LEADERBOARD_COLLECTION,
                USER_PROFILE_COLLECTION 
            ];

            try {
                const batch = writeBatch(db);
                let operationCount = 0;

                for (const collName of collectionsToWipe) {
                    const collRef = collection(db, 'artifacts', APP_ID, 'public', 'data', collName);
                    const snapshot = await getDocs(collRef);

                    if (snapshot.empty) continue;

                    snapshot.forEach(doc => {
                        batch.delete(doc.ref);
                        operationCount++;
                    });
                    console.log(`Added ${snapshot.size} docs from ${collName} to delete batch.`);
                }

                if (operationCount > 0) {
                    await batch.commit();
                    showLoadingOverlay(false);
                    showToast(` Successfully deleted ${operationCount} documents.`);
                    // Force a reload to clear the app's state
                    localStorage.clear();
                    location.reload(); 
                } else {
                    showLoadingOverlay(false);
                    showToast("No demo data was found to delete.");
                }

            } catch (error) {
                console.error("Error wiping demo data:", error);
                showLoadingOverlay(false);
                showToast("Error wiping data. Check console (it might be a permissions issue).");
            }
        }

        /**
         * Generates a fake 64-character transaction hash.
         */
        function generateFakeTxHash() {
            return "0x" + [...Array(64)].map(() => Math.floor(Math.random() * 16).toString(16)).join('');
        }

        /**
         * Shows a toast with a fake BscScan link.
         */
        window.showTxToast = (txHash) => {
            if (!txHash) return;
            const url = `https://testnet.bscscan.com/tx/${txHash}`;
            showToast(`(Demo) View on BscScan:<br><span class="text-xs text-sky-400 break-all">${url}</span>`, 5000);
        }

        /**
         * Helper to get the mock price of an asset in USD.
         */
        function getMockPrice(asset) {
            if (asset === 'BNB') return 500;
            if (asset === 'CAKE') return 3.5;
            return 1; // BUSD default
        }

        /**
         * Helper to get the correct balance field name in Firestore.
         */
        function getBalanceField(asset) {
            if (asset === 'BNB') return 'bnbBalance';
            if (asset === 'CAKE') return 'cakeBalance';
            return 'balance'; // BUSD default
        }
        /**
         * Closes the mock wallet modal.
         */
        function closeMockWalletModal() {
            if (dom.mockWalletModal) {
                dom.mockWalletModal.classList.remove('show');
            }
        }


        // =======================================================================
        // --- GLOBAL EVENT LISTENERS ---
        // =====================================================================



        // ---- PASTE THESE NEW FUNCTIONS ----
        /**
         * Closes the new AI Verdict modal.
         */
        window.closeVerdictModal = () => {
            dom.aiVerdictModal.classList.add('hidden');
        }

        /**
         * Handles the LIVE dispute logic with real balance withdrawal.
         */
        window.handleDispute = async () => {
            if (!currentMarketId) {
                showToast("No market selected", "error");
                return;
            }
            
            const { doc, getDoc, updateDoc, arrayUnion, increment, runTransaction } = window.firebase.firestore;
            const DISPUTE_COST = 10; // 10 BUSD
            
            try {
                showLoadingOverlay(true, "Processing dispute...");
                
                await runTransaction(db, async (transaction) => {
                    // Get user profile
                    const profileRef = doc(db, 'artifacts', APP_ID, 'public', 'data', USER_PROFILE_COLLECTION, currentUserId);
                    const profileSnap = await transaction.get(profileRef);
                    
                    if (!profileSnap.exists()) {
                        throw new Error("User profile not found");
                    }
                    
                    const userBalance = profileSnap.data().balance || 0;
                    
                    // Validation: Check if user has enough balance
                    if (userBalance < DISPUTE_COST) {
                        throw new Error(`Insufficient balance. You need ${DISPUTE_COST} BUSD but only have ${userBalance.toFixed(2)} BUSD.`);
                    }
                    
                    // Get market document
                    const marketRef = doc(db, 'artifacts', APP_ID, 'public', 'data', STANDARD_MARKETS_COLLECTION, currentMarketId);
                    const marketSnap = await transaction.get(marketRef);
                    
                    if (!marketSnap.exists()) {
                        throw new Error("Market not found");
                    }
                    
                    const marketData = marketSnap.data();
                    
                    // Validation: Market must be resolved
                    if (!marketData.isResolved) {
                        throw new Error("Cannot dispute an unresolved market");
                    }
                    
                    // Validation: Check for duplicate disputes from same user
                    const existingDisputes = marketData.disputes || [];
                    if (existingDisputes.some(d => d.disputerId === currentUserId)) {
                        throw new Error("You have already disputed this market");
                    }
                    
                    // Deduct 10 BUSD from user balance
                    transaction.update(profileRef, {
                        balance: increment(-DISPUTE_COST)
                    });
                    
                    // Add dispute to market
                    transaction.update(marketRef, {
                        disputes: arrayUnion({
                            disputerId: currentUserId,
                            disputerName: userProfile.displayName || 'Unknown',
                            timestamp: new Date().toISOString(),
                            escrowAmount: DISPUTE_COST,
                            status: 'pending'
                        })
                    });
                });
                
                showLoadingOverlay(false);
                closeVerdictModal();
                showToast(`Dispute submitted! 10 BUSD has been escrowed. A jury will review this market.`, "success");
                
                // Refresh user balance
                await loadUserProfile();
                
            } catch (error) {
                console.error("Dispute failed:", error);
                showLoadingOverlay(false);
                showToast(`Dispute failed: ${error.message}`, "error");
            }
        }
        // ---- END OF NEW FUNCTIONS ----


        // ---- PASTE THIS NEW FUNCTION ----
        /**
         * Opens the AI Verdict modal with info for a specific market.
         */
        window.showVerdictModal = async (pledgeId) => {
            const { doc, getDoc } = window.firebase.firestore;

            try {
                // 1. Get the pledge document
                const pledgeRef = doc(db, 'artifacts', APP_ID, 'public', 'data', PLEDGES_COLLECTION, pledgeId);
                const pledgeSnap = await getDoc(pledgeRef);
                if (!pledgeSnap.exists()) {
                    showToast("Error: Pledge details not found.");
                    return;
                }
                const pledgeData = pledgeSnap.data();

                // 2. Get the market document (This is a mock, in a real app you'd fetch the market)
                // For this demo, we'll just use the pledge data and add mock rationale.
                const outcome = pledgeData.isWinner ? pledgeData.pick : (pledgeData.pick === 'YES' ? 'NO' : 'YES');
                const outcomeColor = outcome === 'YES' ? 'text-green-400' : 'text-red-400';

                // This is the mock rationale. In a real app, you'd save this to the market doc.
                const mockRationale = "AI Judge analyzed the official results from [Source] and confirmed the outcome.";
                const mockSource = "http://mock-source-of-truth.com/results";

                // 3. Populate and show the modal
                dom.verdictModalOutcome.innerText = `MARKET RESOLVED: ${outcome}`;
                dom.verdictModalOutcome.className = `text-2xl font-bold ${outcomeColor}`; // Update color
                dom.verdictModalRationale.innerText = mockRationale;
                dom.verdictModalSource.innerText = `View Source: ${mockSource}`;
                dom.verdictModalSource.href = mockSource;

                dom.aiVerdictModal.classList.remove('hidden');

            } catch (error) {
                console.error("Error fetching verdict:", error);
                showToast("Error loading verdict details.");
            }
        }
        // ---- END OF NEW FUNCTION ----

        /**
         * Loads all stake logs for a market and initiates the chart draw.
         */
        async function loadAndDrawChart(marketId, marketCreationDate) {
            const { collection, query, where, getDocs } = window.firebase.firestore;

            // 1. Get logs for this market
            const q = query(
                collection(db, 'artifacts', APP_ID, 'public', 'data', STAKE_LOGS_COLLECTION),
                where('marketId', '==', marketId)
            );

            try {
                const snapshot = await getDocs(q);
                let logs = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Ensure timestamp is a JS Date
                    if (data.timestamp && data.timestamp.toDate) {
                        logs.push({
                            amountUsd: data.amountUsd,
                            date: data.timestamp.toDate()
                        });
                    }
                });

                // 2. Format the data for the chart
                const chartData = formatChartData(logs, marketCreationDate);

                // 3. Draw the chart
                drawMarketChart(chartData.labels, chartData.data);

            } catch (error) {
                console.error("Error loading chart data:", error);
                // Optionally draw an empty chart
                drawMarketChart([], []);
            }
        }

        /**
         * Processes raw stake logs into daily totals for the chart.
         */
        function formatChartData(logs, startDate) {
            let dailyVolume = {}; // Use an object for quick lookups
            const labels = [];
            const data = [];
            const oneDay = 24 * 60 * 60 * 1000;

            // 1. Set up daily buckets from start date to today
            let currentDate = new Date(startDate.setHours(0, 0, 0, 0));
            let today = new Date(new Date().setHours(0, 0, 0, 0));

            while (currentDate <= today) {
                const dateString = currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                labels.push(dateString);
                dailyVolume[dateString] = 0; // Initialize bucket
                currentDate = new Date(currentDate.getTime() + oneDay);
            }

            // 2. Sum logs into their respective buckets
            logs.forEach(log => {
                const logDateString = log.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                if (dailyVolume.hasOwnProperty(logDateString)) {
                    dailyVolume[logDateString] += log.amountUsd;
                }
            });

            // 3. Convert the dailyVolume object into the data array
            labels.forEach(label => {
                data.push(dailyVolume[label]);
            });

            return { labels, data };
        }

        /**
         * Draws the actual chart using Chart.js
         */
        function drawMarketChart(labels, data) {
            const ctx = document.getElementById('marketVolumeChart').getContext('2d');

            // Destroy the old chart if it exists
            if (marketChart) {
                marketChart.destroy();
            }

            marketChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Daily Volume',
                        data: data,
                        backgroundColor: 'rgba(56, 189, 248, 0.2)', // sky-400/20
                        borderColor: 'rgba(56, 189, 248, 1)',     // sky-400
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3 // Smooth curves
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false // Hide the legend
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return ` Volume: $${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#9CA3AF', // gray-400
                                callback: function(value) {
                                    return '$' + value;
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)' // white/10
                            }
                        },
                        x: {
                            ticks: {
                                color: '#9CA3AF' // gray-400
                            },
                            grid: {
                                display: false // Hide vertical grid lines
                            }
                        }
                    }
                }
            });
        }



        /**
         * Admin function to manually trigger the backend Oracle jobs.
         */
        async function runOracleJobs() {
            // 1. Prompt the user for the secret key
            const secret = prompt("Enter your CRON_SECRET to run the jobs:", "");
            if (!secret) {
                showToast("Oracle run cancelled.");
                return;
            }

            showLoadingOverlay(true, "Running Oracle Jobs...");

            try {
                // 2. Call the /api/run-jobs endpoint
                const response = await fetch('/api/run-jobs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key: secret }) // Send the secret
                });

                const result = await response.json();
                showLoadingOverlay(false);

                if (!response.ok) {
                    // Show the server error (e.g., "Unauthorized")
                    throw new Error(result.error || 'Unknown server error');
                }

                // 3. Success!
                console.log("Oracle jobs ran:", result);
                showToast(` Oracle Jobs OK: ${result.message || 'Success'}`);

                // 4. Refresh the list of markets to resolve
                renderResolutionPanel();

            } catch (error) {
                showLoadingOverlay(false);
                console.error("Failed to run Oracle jobs:", error);
                showToast(`Oracle failed: ${error.message}`);
            }
        }

        /**
         * Admin function to re-open a resolved market.
         * This resets the market AND all its pledges.
         */
        async function adminReOpenMarket(marketId) {
            // Use confirm() since it's in your file for the wipe button
            if (!confirm(" ADMIN: RE-OPEN MARKET\n\nThis will:\n1. Reset market to unresolved\n2. Reset all pledges\n3. Add audit trail\n\nNote: Does NOT refund payouts.\n\nContinue?")) {
                return;
            }

            showLoadingOverlay(true, "Re-opening market...");

            const { writeBatch, doc, collection, query, where, getDocs, arrayUnion, getDoc } = window.firebase.firestore;

            try {
                // Get current market data for audit
                const marketRef = doc(db, 'artifacts', APP_ID, 'public', 'data', STANDARD_MARKETS_COLLECTION, marketId);
                const marketSnap = await getDoc(marketRef);
                
                if (!marketSnap.exists()) {
                    throw new Error("Market not found");
                }
                
                const marketData = marketSnap.data();
                const batch = writeBatch(db);

                // 1. Reset the Market with audit trail
                batch.update(marketRef, {
                    isResolved: false,
                    winningOutcome: null,
                    adminEvents: arrayUnion({
                        type: 'market_reopened',
                        adminId: currentUserId,
                        adminName: userProfile.displayName || 'Admin',
                        timestamp: new Date().toISOString(),
                        previousOutcome: marketData.winningOutcome || null,
                        reason: 'Admin reopened for re-resolution'
                    })
                });

                // 2. Find and reset all pledges for this market
                const pledgeCollectionPath = `artifacts/${APP_ID}/public/data/pledges`;
                const q = query(collection(db, pledgeCollectionPath), where('marketId', '==', marketId));

                const pledgeSnapshot = await getDocs(q);

                if (!pledgeSnapshot.empty) {
                    pledgeSnapshot.forEach(pledgeDoc => {
                        // Reset the pledge back to an "active" state
                        batch.update(pledgeDoc.ref, {
                            isResolved: false,
                            isWinner: null,
                            payout: 0
                        });
                    });
                }

                // 3. Commit all changes
                await batch.commit();

                showLoadingOverlay(false);
                showToast(" Market reopened! You can now re-resolve it.", "success");

                // 4. Refresh the admin panel to show the changes
                renderResolutionPanel();

            } catch (error) {
                console.error("Failed to re-open market:", error);
                showLoadingOverlay(false);
                showToast(`Failed to re-open: ${error.message}`, "error");
            }
        }


        /**
         * Shows the avatar selection modal.
         */
        window.showAvatarModal = () => {
            const grid = document.getElementById('avatar-grid');
            let html = '';

            AVATAR_LIST.forEach(url => {
                const isSelected = url === userProfile.avatarUrl;
                html += `
                    <img 
                        src="${url}" 
                        class="w-full h-auto rounded-lg cursor-pointer border-4 ${isSelected ? 'border-sky-400' : 'border-transparent'} hover:border-sky-400/50" 
                        alt="Avatar" 
                        onclick="selectAvatar('${url}')"
                    >
                `;
            });

            grid.innerHTML = html;
            dom.avatarModal.classList.remove('hidden');
        }

        /**
         * Closes the avatar selection modal.
         */
        window.closeAvatarModal = () => {
            dom.avatarModal.classList.add('hidden');
        }

        /**
         * Saves the selected avatar AND logs the new user into the app.
         * This is the "gateway" for new users.
         */
        window.selectAvatar = async (avatarUrl) => {
            const { doc, updateDoc } = window.firebase.firestore;

            showLoadingOverlay(true, "Saving...");
            try {
                // 1. Update the private profile
                const profileRef = doc(db, 'artifacts', APP_ID, 'public', 'data', USER_PROFILE_COLLECTION, currentUserId);
                await updateDoc(profileRef, {
                    avatarUrl: avatarUrl
                });

                // 2. Update the public leaderboard profile
                const publicProfileRef = doc(db, 'artifacts', APP_ID, 'public', 'data', PUBLIC_LEADERBOARD_COLLECTION, currentUserId);
                await updateDoc(publicProfileRef, {
                    avatarUrl: avatarUrl
                });

                // --- THIS IS THE "GATEWAY" LOGIC ---
                // After saving, log them into the app
                showLoadingOverlay(false);
                closeAvatarModal();
                showToast("Avatar saved! Welcome to Predora!", "success");

                // Attach all data listeners
                attachDataListeners();

                // Go to the app
                showScreen('home-screen');
                dom.topNav.classList.remove('hidden');
                dom.bottomNav.classList.remove('hidden');
                // --- END OF NEW LOGIC ---

            } catch (error) {
                console.error("Failed to save avatar:", error);
                showLoadingOverlay(false);
                showToast(`Error: ${error.message}`);
            }
        }


        // =====================================================================
        // --- LIVE TICKER (STAKE-TO-CHAT) FUNCTIONS ---
        // =====================================================================

        /**
         * Checks if the current user has an active, unresolved stake in the current market.
         * This is the "Stake-to-Chat" gate.
         */
        async function checkUserHasActiveStake() {
            if (!currentUserId || !currentMarketId) return false;

            const { collection, query, where, getDocs } = window.firebase.firestore;

            const q = query(
                collection(db, 'artifacts', APP_ID, 'public', 'data', PLEDGES_COLLECTION),
                where('userId', '==', currentUserId),
                where('marketId', '==', currentMarketId),
                where('isResolved', '==', false)
            );

            try {
                const snapshot = await getDocs(q);
                return !snapshot.empty; // Returns true if they have 1 or more stakes
            } catch (error) {
                console.error("Error checking user stake:", error);
                return false;
            }
        }

        /**
         * Loads the live comment feed for the current market.
         */
        function loadTickerFeed() {
            if (!currentMarketId) return;

            const { collection, query, where, onSnapshot } = window.firebase.firestore;

            // Clean up old listener
            if (tickerUnsubscribe) tickerUnsubscribe();

            const q = query(
                collection(db, 'artifacts', APP_ID, 'public', 'data', MARKET_COMMENTS_COLLECTION),
                where('marketId', '==', currentMarketId)
                // We'll sort in JavaScript to avoid an index
            );

            tickerUnsubscribe = onSnapshot(q, async (snapshot) => {
                let comments = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    comments.push({
                        ...data,
                        commentId: doc.id // Use Firestore document ID
                    });
                });

                // Sort by timestamp, newest first
                comments.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);

                // Update the comment count badge
                if (comments.length > 0) {
                    dom.tickerCommentCount.innerText = comments.length;
                    dom.tickerCommentCount.classList.remove('hidden');
                } else {
                    dom.tickerCommentCount.classList.add('hidden');
                }

                // Render the feed
                if (comments.length === 0) {
                    dom.tickerFeedContent.innerHTML = '<p class="text-gray-400 text-center">Be the first to comment!</p>';
                    return;
                }

                let html = '';
                for (const comment of comments) {
                    const pickClass = comment.pick === 'YES' ? 'badge-pick-yes' : 'badge-pick-no';
                    const avatarUrl = comment.avatarUrl || YOUR_LOGO_URL;
                    const displayName = comment.displayName || 'Anonymous';
                    const commentId = comment.commentId;
                    const timeAgo = comment.timestamp ? getTimeAgo(comment.timestamp.seconds) : 'just now';
                    
                    // Load replies for this comment
                    const commentRef = doc(db, 'artifacts', APP_ID, 'public', 'data', MARKET_COMMENTS_COLLECTION, commentId);
                    const repliesCol = collection(commentRef, 'replies');
                    const repliesSnapshot = await getDocs(query(repliesCol));
                    
                    let repliesHtml = '';
                    if (!repliesSnapshot.empty) {
                        repliesSnapshot.forEach(replyDoc => {
                            const reply = replyDoc.data();
                            const replyTimeAgo = reply.timestamp ? getTimeAgo(reply.timestamp.seconds) : 'just now';
                            repliesHtml += `
                                <div class="flex space-x-2 text-sm">
                                    <img src="${reply.avatarUrl || YOUR_LOGO_URL}" class="w-6 h-6 rounded-full" alt="Avatar">
                                    <div>
                                        <div class="flex items-center space-x-2">
                                            <span class="font-semibold text-gray-800 dark:text-gray-200 text-xs">${reply.displayName}</span>
                                            <span class="text-xs text-gray-500 dark:text-gray-400">${replyTimeAgo}</span>
                                        </div>
                                        <p class="text-gray-700 dark:text-gray-300 text-xs mt-0.5">${reply.commentText}</p>
                                    </div>
                                </div>
                            `;
                        });
                    }
                    
                    html += `
                        <div class="flex space-x-3 pb-3 border-b border-white/5" data-comment-id="${commentId}">
                            <img src="${avatarUrl}" class="w-10 h-10 rounded-full" alt="Avatar">
                            <div class="flex-grow">
                                <div class="flex items-center space-x-2">
                                    ${comment.userId === currentUserId ? `
    <span class="font-semibold text-gray-900 dark:text-white">${displayName}</span>
` : `
    <button onclick=" closeTickerModal(); viewUserProfile('${comment.userId}')" class="font-semibold text-gray-900 dark:text-white hover:text-sky-500 dark:hover:text-sky-400 transition-colors">
        ${displayName}
    </button>
`}
                                    ${comment.pick ? `<span class="badge ${pickClass}">${comment.pick}</span>` : ''}
                                    <span class="text-xs text-gray-500 dark:text-gray-400">${timeAgo}</span>
                                </div>
                                <p class="text-gray-700 dark:text-gray-300 text-sm mt-1">${comment.commentText}</p>
                                <button onclick="startReply('${commentId}', '${displayName.replace(/'/g, "\\'")}')" class="text-xs text-sky-600 dark:text-sky-400 hover:text-sky-500 mt-1 flex items-center space-x-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                                    </svg>
                                    <span>Reply${repliesSnapshot.size > 0 ? ` (${repliesSnapshot.size})` : ''}</span>
                                </button>
                                <div id="replies-${commentId}" class="mt-2 ml-4 space-y-2 ${repliesSnapshot.empty ? 'hidden' : ''}">
                                    ${repliesHtml}
                                </div>
                            </div>
                        </div>
                    `;
                }
                dom.tickerFeedContent.innerHTML = html;
            });
        }

        /**
         * Opens the live ticker modal and checks for stake status.
         */
        window.showTickerModal = async () => {
            dom.tickerModal.classList.remove('hidden');
            // Force a reflow to animate
            await new Promise(resolve => setTimeout(resolve, 10));
            dom.tickerPanel.classList.remove('translate-y-full');

            // 1. Start loading the feed
            loadTickerFeed();

            // 2. Check if user is allowed to chat
            const canChat = await checkUserHasActiveStake();

            if (canChat) {
                dom.tickerLockedMessage.classList.add('hidden');
                dom.tickerInputArea.classList.remove('hidden');
            } else {
                dom.tickerLockedMessage.classList.remove('hidden');
                dom.tickerInputArea.classList.add('hidden');
            }
        }

        /**
         * Closes the live ticker modal.
         */
        window.closeTickerModal = () => {
            // Animate out
            dom.tickerPanel.classList.add('translate-y-full');

            // Hide after animation
            setTimeout(() => {
                dom.tickerModal.classList.add('hidden');

                // Stop the live listener
                if (tickerUnsubscribe) {
                    tickerUnsubscribe();
                    tickerUnsubscribe = null;
                }
            }, 300); // 300ms matches the transition duration
        }

        /**
         * Helper to format timestamps as "time ago"
         */
        function getTimeAgo(seconds) {
            const now = Date.now() / 1000;
            const diff = now - seconds;
            
            if (diff < 60) return 'just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            return `${Math.floor(diff / 86400)}d ago`;
        }
        
        // Track current reply state
        let replyingTo = null;
        
        /**
         * Start replying to a comment
         */
        window.startReply = (commentId, displayName) => {
            replyingTo = { commentId, displayName };
            dom.tickerCommentInput.placeholder = `Replying to ${displayName}...`;
            dom.tickerCommentInput.focus();
            
            // Update button text
            dom.tickerPostBtn.innerText = 'Reply';
        }
        
        /**
         * Cancel reply mode
         */
        function cancelReply() {
            replyingTo = null;
            dom.tickerCommentInput.placeholder = 'Add your insight...';
            dom.tickerPostBtn.innerText = 'Post';
        }
        
        /**
         * Posts a new comment or reply to the live ticker.
         */
        window.postComment = async () => {
            const commentText = dom.tickerCommentInput.value.trim();
            if (commentText.length < 1) return;

            dom.tickerPostBtn.disabled = true;
            try {
                const { addDoc, collection, serverTimestamp, doc } = window.firebase.firestore;
                
                if (replyingTo) {
                    // Posting a reply
                    console.log('Posting reply to comment:', replyingTo.commentId);
                    const commentRef = doc(db, 'artifacts', APP_ID, 'public', 'data', MARKET_COMMENTS_COLLECTION, replyingTo.commentId.toString());
                    const repliesCol = collection(commentRef, 'replies');
                    
                    await addDoc(repliesCol, {
                        userId: currentUserId,
                        displayName: userProfile.displayName,
                        avatarUrl: userProfile.avatarUrl || YOUR_LOGO_URL,
                        commentText: commentText,
                        timestamp: serverTimestamp()
                    });
                    
                    console.log('Reply posted successfully');
                    showToast('Reply posted!', "success");
                    cancelReply();
                    
                    // Reload the ticker feed to show the new reply
                    loadTickerFeed();
                } else {
                    // Posting a top-level comment
                    const docRef = await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', MARKET_COMMENTS_COLLECTION), {
                        marketId: currentMarketId,
                        userId: currentUserId,
                        displayName: userProfile.displayName,
                        avatarUrl: userProfile.avatarUrl || YOUR_LOGO_URL,
                        pick: null,
                        commentText: commentText,
                        timestamp: serverTimestamp()
                    });
                    
                    // Store the document ID as commentId
                    const commentId = docRef.id;
                    console.log('Comment posted with ID:', commentId);
                }

                // Clear input
                dom.tickerCommentInput.value = '';

            } catch (error) {
                console.error("Failed to post comment:", error);
                showToast("Error posting comment.");
            } finally {
                dom.tickerPostBtn.disabled = false;
            }
        }

        // =====================================================================
        // --- SOCIAL GRAPH (FOLLOW) FUNCTIONS ---
        // =====================================================================

        /**
         * Shows the public profile page for a given user.
         */
        window.viewUserProfile = (userId, initialTab = 'active') => {
            if (!userId) return;

            if (userId === currentUserId) {
                // Don't show a public profile for yourself, just go to your own profile
                showScreen('profile-screen');
            } else {
                // Load the public profile screen
                loadPublicProfile(userId, initialTab);
            }
        }

        /**
         * Loads and displays a public profile for a given user ID.
         */
        async function loadPublicProfile(userId, initialTab = 'active') {
            const { doc, getDoc } = window.firebase.firestore;
            showLoadingOverlay(true, "Loading profile...");

            try {
                // 1. Get the public profile data from the leaderboard
                const publicProfileRef = doc(db, 'artifacts', APP_ID, 'public', 'data', PUBLIC_LEADERBOARD_COLLECTION, userId);
                const publicSnap = await getDoc(publicProfileRef);

                if (!publicSnap.exists()) {
                    throw new Error("User profile not found.");
                }
                const profile = publicSnap.data();

                // 2. Populate the UI
                dom.publicProfileName.innerText = profile.displayName || 'Anonymous';
                dom.publicProfileAvatar.innerHTML = `<img src="${profile.avatarUrl || LOGO_URL}" class="w-20 h-20 rounded-full" alt="Profile Avatar">`;
                dom.publicProfileXpBadge.innerText = `${(profile.xp || 0).toLocaleString()} XP`;
                
                // Update follower count for this user
                updateFollowerCount(userId);
                dom.publicProfileRankBadge.innerText = `Rank: N/A`; // Note: Rank is tricky to get for a single user
                dom.publicProfileAccuracyBadge.innerText = `${profile.xp > 0 ? '82' : '0'}% Accuracy`; // Still mocked

                // 3. Set up the Follow button
                dom.followBtn.dataset.targetUserId = userId;
                dom.followBtn.dataset.targetUserName = profile.displayName;

                // 4. NEW: Check follow status
                await checkFollowStatus(userId);

                // 5. Show the screen
                showScreen('public-profile-screen');
                handlePublicProfileTab(initialTab); // Use the provided initial tab

                // 6. Load the user's data based on the initial tab
                if (initialTab === 'active') {
                    renderPublicActiveStakes(userId);
                } else if (initialTab === 'history') {
                    renderPublicHistoryStakes(userId);
                } else if (initialTab === 'followers') {
                    renderPublicFollowersList(userId);
                }

            } catch (error) {
                console.error("Error loading public profile:", error);
                showToast(`Error: ${error.message}`);
                goBack();
            } finally {
                showLoadingOverlay(false);
            }
        }

        /**
         * Handles the tab switching on the public profile screen (Active, History, Followers).
         */
        window.handlePublicProfileTab = (tabName) => {
            document.querySelectorAll('#public-profile-screen .profile-tab').forEach(btn => btn.classList.remove('active'));
            const tabButton = document.querySelector(`#public-profile-screen .profile-tab[data-pubtab="${tabName}"]`);
            if (tabButton) tabButton.classList.add('active');

            dom.publicActiveStakesContent.classList.toggle('hidden', tabName !== 'active');
            dom.publicHistoryContent.classList.toggle('hidden', tabName !== 'history');
            const publicFollowersContent = document.getElementById('public-followers-content');
            if (publicFollowersContent) {
                publicFollowersContent.classList.toggle('hidden', tabName !== 'followers');
            }

            // Get the userId from the follow button
            const userId = dom.followBtn.dataset.targetUserId;
            if (!userId) return; // Safety check

            // Load data for the selected tab
            if (tabName === 'active') {
                renderPublicActiveStakes(userId);
            } else if (tabName === 'history') {
                renderPublicHistoryStakes(userId);
            } else if (tabName === 'followers') {
                renderPublicFollowersList(userId);
            }

        }
        
        /**
         * Renders the list of users who follow a specific user (for public profiles)
         */
        async function renderPublicFollowersList(userId) {
            const { collection, getDocs, query } = window.firebase.firestore;
            const content = document.getElementById('public-followers-content');
            content.innerHTML = '<p class="text-gray-400 text-center pt-8">Loading followers...</p>';

            try {
                const followersCol = collection(db, 'artifacts', APP_ID, 'public', 'data', USER_PROFILE_COLLECTION, userId, 'followers');
                const snapshot = await getDocs(query(followersCol));

                if (snapshot.empty) {
                    content.innerHTML = `<div class="ui-panel text-center"><p class="text-gray-400">This user has no followers yet.</p></div>`;
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const user = doc.data();
                    html += `
                        <div class="ui-panel p-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <img src="${user.avatarUrl || LOGO_URL}" class="w-10 h-10 rounded-full" alt="Avatar">
                                    <div>
                                        <p class="font-semibold text-white">${user.displayName}</p>
                                        <p class="text-sm text-gray-400">${(user.xp || 0).toLocaleString()} XP</p>
                                    </div>
                                </div>
                                <button onclick="viewUserProfile('${user.userId}')" class="btn btn-secondary" style="width: auto; padding: 0.375rem 1rem; font-size: 0.875rem;">
                                    View Profile
                                </button>
                            </div>
                        </div>
                    `;
                });
                content.innerHTML = html;
            } catch (error) {
                console.error("Failed to render public followers:", error);
                content.innerHTML = `<p class="text-red-400 text-center">Error loading followers.</p>`;
            }
        }

        /**
         * Handles the "Followers" / "Following" sub-tabs on the main profile screen.
         */
        window.handleNetworkingTab = (tabName) => {
            const followersBtn = document.getElementById('sub-tab-followers');
            const followingBtn = document.getElementById('sub-tab-following');
            const followersContent = document.getElementById('followers-list-content');
            const followingContent = document.getElementById('following-list-content');

            if (tabName === 'followers') {
                followersBtn.classList.add('active');
                followingBtn.classList.remove('active');
                followersContent.classList.remove('hidden');
                followingContent.classList.add('hidden');
                renderFollowersList();
            } else {
                followersBtn.classList.remove('active');
                followingBtn.classList.add('active');
                followersContent.classList.add('hidden');
                followingContent.classList.remove('hidden');
                renderFollowingList();
            }
        }

        /**
         * Updates the follower count display for the current user's profile
         */
        async function updateFollowerCount(userId = currentUserId) {
            const { collection, getDocs, query } = window.firebase.firestore;
            
            try {
                const followersCol = collection(db, 'artifacts', APP_ID, 'public', 'data', USER_PROFILE_COLLECTION, userId, 'followers');
                const snapshot = await getDocs(query(followersCol));
                const count = snapshot.size;
                
                // Update profile follower count if viewing own profile
                if (userId === currentUserId) {
                    const profileCountEl = document.getElementById('profile-follower-count');
                    if (profileCountEl) {
                        profileCountEl.innerHTML = `
                            <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                            </svg>
                            ${count} Follower${count !== 1 ? 's' : ''}
                        `;
                    }
                } else {
                    // Update public profile follower count
                    const publicCountEl = document.getElementById('public-profile-follower-count');
                    if (publicCountEl) {
                        publicCountEl.innerHTML = `
                            <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                            </svg>
                            ${count} Follower${count !== 1 ? 's' : ''}
                        `;
                    }
                }
            } catch (error) {
                console.error("Failed to update follower count:", error);
            }
        }
        
        /**
         * Renders the list of users who follow the current user.
         */
        async function renderFollowersList() {
            const { collection, getDocs, query, onSnapshot } = window.firebase.firestore;
            const content = document.getElementById('followers-list-content');
            content.innerHTML = '<p class="text-gray-400 text-center pt-8">Loading followers...</p>';

            try {
                const followersCol = collection(db, 'artifacts', APP_ID, 'public', 'data', USER_PROFILE_COLLECTION, currentUserId, 'followers');
                const snapshot = await getDocs(query(followersCol));

                if (snapshot.empty) {
                    content.innerHTML = `<div class="ui-panel text-center"><p class="text-gray-400">You don't have any followers yet.</p></div>`;
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const user = doc.data();
                    html += `
                        <div class="ui-panel p-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <img src="${user.avatarUrl || LOGO_URL}" class="w-10 h-10 rounded-full" alt="Avatar">
                                    <div>
                                        <p class="font-semibold text-white">${user.displayName}</p>
                                        <p class="text-sm text-gray-400">${(user.xp || 0).toLocaleString()} XP</p>
                                    </div>
                                </div>
                                <button onclick="viewUserProfile('${user.userId}')" class="btn btn-secondary" style="width: auto; padding: 0.375rem 1rem; font-size: 0.875rem;">
                                    View
                                </button>
                            </div>
                        </div>
                    `;
                });
                content.innerHTML = html;
                
                // Update follower count
                updateFollowerCount(currentUserId);
            } catch (error) {
                console.error("Failed to render followers:", error);
                content.innerHTML = `<p class="text-red-400 text-center">Error loading followers.</p>`;
            }
        }
        
        /**
         * Opens a modal/screen showing a user's followers with full details
         */
        window.viewUserFollowers = function(userId) {
            // Navigate to their profile with the followers tab open
            viewUserProfile(userId, 'followers');
        }

        /**
         * Renders the list of users the current user is following.
         */
        async function renderFollowingList() {
            const { collection, getDocs, query, onSnapshot } = window.firebase.firestore;
            const content = document.getElementById('following-list-content');
            content.innerHTML = '<p class="text-gray-400 text-center pt-8">Loading following list...</p>';

            try {
                const followingCol = collection(db, 'artifacts', APP_ID, 'public', 'data', USER_PROFILE_COLLECTION, currentUserId, 'following');
                const snapshot = await getDocs(query(followingCol));

                if (snapshot.empty) {
                    content.innerHTML = `<div class="ui-panel text-center"><p class="text-gray-400">You aren't following anyone yet.</p></div>`;
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const user = doc.data();
                    html += `
                        <div class="ui-panel p-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <img src="${user.avatarUrl || LOGO_URL}" class="w-10 h-10 rounded-full" alt="Avatar">
                                    <div>
                                        <p class="font-semibold text-white">${user.displayName}</p>
                                        <p class="text-sm text-gray-400">${(user.xp || 0).toLocaleString()} XP</p>
                                    </div>
                                </div>
                                <button onclick="viewUserProfile('${user.userId}')" class="btn btn-secondary" style="width: auto; padding: 0.375rem 1rem; font-size: 0.875rem;">
                                    View
                                </button>
                            </div>
                        </div>
                    `;
                });
                content.innerHTML = html;
            } catch (error) {
                console.error("Failed to render following:", error);
                content.innerHTML = `<p class="text-red-400 text-center">Error loading following list.</p>`;
            }
        }

        /**
         * Renders a public user's active stakes.
         */
        async function renderPublicActiveStakes(userId) {
            const { collection, query, where, getDocs } = window.firebase.firestore;
            dom.publicActiveStakesContent.innerHTML = '<p class="text-gray-400 text-center pt-8">Loading active stakes...</p>';

            const q = query(
                collection(db, 'artifacts', APP_ID, 'public', 'data', PLEDGES_COLLECTION),
                where('isResolved', '==', false),
                where('userId', '==', userId) // <-- Query for the public user
            );

            try {
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    dom.publicActiveStakesContent.innerHTML = '<div class="ui-panel text-center"><p class="text-gray-400">This user has no active stakes.</p></div>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const pledge = doc.data();
                    const pickClass = pledge.pick === 'YES' ? 'text-green-400' : 'text-red-400';
                    html += `
                        <div class="ui-panel p-4 mb-3 opacity-80">
                            <p class="text-white font-semibold">${pledge.marketTitle}</p>
                            <div class="flex justify-between items-center text-sm mt-2">
                                <span class="text-gray-400">Their Pick: <span class="${pickClass} font-bold">${pledge.pick}</span></span>
                                <span class="text-gray-400">Stake: <span class="text-white font-bold">$${pledge.amountUsd.toFixed(2)}</span></span>
                            </div>
                        </div>
                    `;
                });
                dom.publicActiveStakesContent.innerHTML = html;
            } catch (error) {
                console.error("Error loading public active stakes:", error);
                dom.publicActiveStakesContent.innerHTML = '<p class="text-red-400 text-center">Could not load stakes.</p>';
            }
        }

        /**
         * Renders a public user's stake history.
         */
        async function renderPublicHistoryStakes(userId) {
            const { collection, query, where, getDocs } = window.firebase.firestore;
            dom.publicHistoryContent.innerHTML = '<p class="text-gray-400 text-center pt-8">Loading history...</p>';

            const q = query(
                collection(db, 'artifacts', APP_ID, 'public', 'data', PLEDGES_COLLECTION),
                where('isResolved', '==', true),
                where('userId', '==', userId) // <-- Query for the public user
            );

            try {
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    dom.publicHistoryContent.innerHTML = '<div class="ui-panel text-center"><p class="text-gray-400">This user has no stake history.</p></div>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const pledge = doc.data();
                    const isWinner = pledge.isWinner === true;
                    const result = isWinner ? 'WON' : 'LOST';
                    const resultClass = isWinner ? 'text-green-400' : 'text-red-400';
                    const pnl = isWinner ? (pledge.payout - pledge.amountUsd) : -pledge.amountUsd;
                    const payoutText = `${pnl >= 0 ? '+' : '-'}$${Math.abs(pnl).toFixed(2)}`;

                    html += `
                        <button onclick="showVerdictModal('${doc.id}')" class="ui-panel p-4 mb-3 w-full text-left ${isWinner ? 'border-l-4 border-green-400' : 'border-l-4 border-red-400'} opacity-80">
                            <p class="text-white font-semibold">${pledge.marketTitle}</p>
                            <div class="flex justify-between items-center text-sm mt-2">
                                <span class="text-gray-400">Result: <span class="${resultClass} font-bold">${result}</span></span>
                                <span class="text-gray-400">Net P&L: <span class="${resultClass} font-bold">${payoutText}</span></span>
                            </div>
                        </button>
                    `;
                });
                dom.publicHistoryContent.innerHTML = html;
            } catch (error) {
                console.error("Error loading public history:", error);
                dom.publicHistoryContent.innerHTML = '<p class="text-red-400 text-center">Could not load history.</p>';
            }
        }

        /**
         * Checks if the current user is following the target user and updates the button.
         */
        async function checkFollowStatus(targetUserId) {
            const { doc, getDoc } = window.firebase.firestore;
            try {
                const followerRef = doc(db, 'artifacts', APP_ID, 'public', 'data', USER_PROFILE_COLLECTION, targetUserId, 'followers', currentUserId);
                const followerDoc = await getDoc(followerRef);
                updateFollowButton(followerDoc.exists());
            } catch (error) {
                console.error("Failed to check follow status:", error);
                updateFollowButton(false);
            }
        }

        /**
         * Updates the Follow/Unfollow button's appearance.
         */
        function updateFollowButton(isFollowing) {
            if (isFollowing) {
                dom.followBtn.innerText = "Unfollow";
                dom.followBtn.classList.replace('btn-primary', 'btn-secondary');
            } else {
                dom.followBtn.innerText = "Follow";
                dom.followBtn.classList.replace('btn-secondary', 'btn-primary');
            }
            dom.followBtn.disabled = false;
        }

        /**
         * Toggles the follow/unfollow status for a user.
         */
        async function toggleFollow() {
            const { doc, getDoc, setDoc, deleteDoc, serverTimestamp, writeBatch } = window.firebase.firestore;
            const targetUserId = dom.followBtn.dataset.targetUserId;
            const targetUserName = dom.followBtn.dataset.targetUserName || "user";
            if (!targetUserId) return;

            dom.followBtn.disabled = true;
            dom.followBtn.innerText = "...";

            // Refs for both sides of the follow action
            const followingRef = doc(db, 'artifacts', APP_ID, 'public', 'data', USER_PROFILE_COLLECTION, currentUserId, 'following', targetUserId);
            const followerRef = doc(db, 'artifacts', APP_ID, 'public', 'data', USER_PROFILE_COLLECTION, targetUserId, 'followers', currentUserId);

            try {
                const followerDoc = await getDoc(followerRef);

                if (followerDoc.exists()) {
                    // --- UNFOLLOW Logic ---
                    const batch = writeBatch(db);
                    batch.delete(followingRef);
                    batch.delete(followerRef);
                    await batch.commit();

                    showToast(`You have unfollowed ${targetUserName}`, "info");
                    updateFollowButton(false);
                } else {
                    // --- FOLLOW Logic ---
                    // Get the data we need to save for both docs
                    const targetUserPublicProfile = await getDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', PUBLIC_LEADERBOARD_COLLECTION, targetUserId));

                    if (!userProfile.displayName || !targetUserPublicProfile.exists()) {
                        throw new Error("Profile data missing, cannot follow.");
                    }

                    const targetUserData = targetUserPublicProfile.data();

                    const batch = writeBatch(db);
                    // Add to *my* 'following' list
                    batch.set(followingRef, {
                        userId: targetUserData.userId,
                        displayName: targetUserData.displayName,
                        avatarUrl: targetUserData.avatarUrl || LOGO_URL, // <-- FIX IS HERE
                        xp: targetUserData.xp || 0,
                        followedAt: serverTimestamp()
                    });
                    // Add *me* to *their* 'followers' list
                    batch.set(followerRef, {
                        userId: currentUserId,
                        displayName: userProfile.displayName,
                        avatarUrl: userProfile.avatarUrl || LOGO_URL, // <-- FIX IS HERE
                        xp: userProfile.xp || 0,
                        followedAt: serverTimestamp()
                    });
                    await batch.commit();

                    showToast(`You are now following ${targetUserName}`, "success");
                    updateFollowButton(true);
                }
            } catch (error) {
                console.error("Error toggling follow:", error);
                showToast(`Error: ${error.message}`);
                updateFollowButton(false); // Reset to a safe state
            } finally {
                dom.followBtn.disabled = false;
            }
        }

        /**
         * Handles the user typing in the search bar.
         */
        function handleSearch() {
            const query = dom.searchBarInput.value.toLowerCase().trim();

            // 1. Get the currently filtered list (not all markets)
            let baseList = [];
            if (currentCategoryFilter === 'All') {
                baseList = allStandardMarkets;
            } else {
                baseList = allStandardMarkets.filter(market => market.category === currentCategoryFilter);
            }

            if (query.length < 1) {
                // If search is cleared, show the category list
                renderMarketFeed(baseList);
                return;
            }

            // 2. Filter the category list by the search query
            const results = baseList.filter(market => 
                market.title.toLowerCase().includes(query)
            );

            // Render only the final results
            renderMarketFeed(results);
        }

        /**
         * Renders the search results into the UI.
         */
        function renderMarketFeed(markets) {
            // We use the cached feed element
            const feed = dom.standardMarketsFeed; 
            if (!feed) return; // Safety check

            if (markets.length === 0) {
                feed.innerHTML = '<p class="text-gray-400 text-center">No active markets match your search.</p>';
                return;
            }

            let html = '';
            markets.forEach(market => {
                const displayName = market.createdByDisplayName || 'Anonymous';
                html += `
                    <div class="ui-panel">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-xs text-gray-400 font-light">By @${displayName}</span>
                            <div class="flex items-center space-x-2">
                                <span class="badge ${market.isNoLoss ? 'badge-blue' : 'badge-green'}">${market.isNoLoss ? 'No-Loss' : 'Classic'}</span>
                                <div class.badge badge-timer flex items-center space-x-1.5">
                                    <span class="w-1.5 h-1.5 bg-sky-400 rounded-full live-dot"></span>
                                    <span>${market.stakeDuration || '...'}</span>
                                </div>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold text-white mb-3 leading-tight">${market.title}</h3>
                        <div class="flex justify-around mb-5">
                            <div class="text-center">
                                <div class="text-4xl font-bold text-green-400">${(market.yesPercent || 0).toFixed(1)}%</div>
                                <div class="text-sm text-gray-300">YES</div>
                            </div>
                            <div class="text-center">
                                <div class="text-4xl font-bold text-red-400">${(market.noPercent || 0).toFixed(1)}%</div>
                                <div class="text-sm text-gray-300">NO</div>
                            </div>
                        </div>
                        <button onclick="viewMarketDetail('${market.id}')" class="btn btn-primary w-full">View Market</button>
                        ${market.isNoLoss ? '<div class="mt-3 text-center"><span class="text-xs font-medium text-green-400"> Simulated Yield 4% APY</span></div>' : ''}
                    </div>
                `;
            });
            feed.innerHTML = html;
        }



        /**
         * Filters the main market feed by category.
         */
        function filterMarkets(category) {
            console.log("Filtering by category:", category);
            currentCategoryFilter = category; // Set the global filter

            // 1. Update the "active" class on the filter pills
            const pills = document.querySelectorAll('#category-filter-bar .filter-pill');
            pills.forEach(pill => {
                if (pill.innerText === category) {
                    pill.classList.add('active');
                } else {
                    pill.classList.remove('active');
                }
            });

            // 2. Filter the markets
            let results = [];
            if (category === 'All') {
                results = allStandardMarkets;
            } else {
                results = allStandardMarkets.filter(market => market.category === category);
            }

            // 3. Re-run the search, in case there's text in the search bar
            const query = dom.searchBarInput.value.toLowerCase().trim();
            if (query.length > 1) {
                results = results.filter(market => market.title.toLowerCase().includes(query));
            }

            // 4. Render the final list
            renderMarketFeed(results);
        }


        /**
         * Wires up all global functions to the window object and attaches
         * listeners to buttons that are always present.
         */
        function setupEventListeners() {
            // Make functions globally accessible for inline HTML `onclick`
            window.showScreen = showScreen;
            window.goBack = goBack;
            window.handleProfileTab = handleProfileTab;

            window.filterMarkets = filterMarkets;

            window.viewMarketDetail = viewMarketDetail;

            window.handleQuickPlay = handleQuickPlay;
            window.removeItemFromPledgePool = removeItemFromPledgePool;
            window.resolveMarket = resolveMarket;
            window.mockLogin = mockLogin;
            window.mockOtpLogin = mockOtpLogin;
            window.closeMockWalletModal = closeMockWalletModal;
            window.selectYield = selectYield; 
            window.stakeAllPledges = stakeAllPledges; 
            window.getAIResolution = getAIResolution;
            window.showTxToast = showTxToast;
            window.claimTokens = claimTokens; 
            window.setPledgeAll = setPledgeAll; 
            window.updatePledgeTotalSummary = updatePledgeTotalSummary; 
            window.clearAllDemoData = clearAllDemoData;
            window.validateAndShowOtp = validateAndShowOtp;
            window.selectMarketType = selectMarketType;
            window.viewQuickPlayDetails = viewQuickPlayDetails;
            window.closeQuickPlayDetails = closeQuickPlayDetails;

            window.closeVerdictModal = closeVerdictModal;

            window.handleDispute = handleDispute;

            window.showVerdictModal = showVerdictModal;

            window.adminReOpenMarket = adminReOpenMarket;

              window.showAvatarModal = showAvatarModal; 
                  window.closeAvatarModal = closeAvatarModal; 

                  window.selectAvatar = selectAvatar;

            window.showTickerModal = showTickerModal; 

            window.closeTickerModal = closeTickerModal; 

            window.postComment = postComment;

            window.viewUserProfile = viewUserProfile;

            window.handlePublicProfileTab = handlePublicProfileTab;
            window.handleNetworkingTab = handleNetworkingTab;

            // Setup admin features
            setupAdminFeatures();
            
            // Attach listeners to static buttons
            const aiGenerateBtn = document.getElementById('ai-generate-btn');
            if (aiGenerateBtn) aiGenerateBtn.addEventListener('click', getAIAssist);
            
            const createMarketBtn = document.getElementById('create-market-btn');
            if (createMarketBtn) createMarketBtn.addEventListener('click', createMarket);
            
            const aiExplainBtn = document.getElementById('ai-explain-btn');
            if (aiExplainBtn) aiExplainBtn.addEventListener('click', getAIExplanation);
            
            const aiProfileSummaryBtn = document.getElementById('ai-profile-summary-btn');
            if (aiProfileSummaryBtn) aiProfileSummaryBtn.addEventListener('click', getAIProfileSummary); 

            dom.showTickerBtn.addEventListener('click', showTickerModal);

            dom.followBtn.addEventListener('click', toggleFollow);
            dom.tickerPostBtn.addEventListener('click', postComment);

dom.searchBarInput.addEventListener('input', handleSearch);

            // Use event delegation for the stake buttons (since they are in a dynamic panel)
            if (dom.stakeSection) {
                dom.stakeSection.addEventListener('click', (event) => {
                    const targetId = event.target.id;
                    if (targetId === 'stake-yes-btn') {
                        stakeMarket('YES');
                    } else if (targetId === 'stake-no-btn') {
                        stakeMarket('NO');
                    }
                });
            }

            dom.stakeAllPledgesBtn.addEventListener('click', stakeAllPledges);

            const runOracleBtn = document.getElementById('run-oracle-btn');
            if (runOracleBtn) runOracleBtn.addEventListener('click', runOracleJobs);
            
            // Setup create market listeners (like the odds calculator)
            setupCreateMarketListeners();

            // --- Wire up Top Navigation Buttons ---
            if (dom.topNavButtons) {
                dom.topNavButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        showScreen(e.currentTarget.dataset.screen);
                    });
                });
            }

        }

    </script>
    </div>
</body>
</html>